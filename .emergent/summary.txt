<analysis>**original_problem_statement:**
O utilizador iniciou a sessão para corrigir um bug no fluxo de aprovação de parceiros. Após a correção, o utilizador solicitou uma série de novas funcionalidades e correções de bugs, incluindo:
1.  **Gestão de Certidão Permanente:** Adicionar funcionalidade de upload, download e edição para a certidão permanente no perfil do parceiro.
2.  **Melhorias nos Contratos:** Adicionar um conjunto completo de variáveis dinâmicas aos templates de contrato, corrigir um erro Method Not Allowed ao guardar templates e guardar uma cópia do contrato em PDF no perfil do motorista.
3.  **Importação em Massa via CSV:** Implementar um sistema para que os parceiros possam importar motoristas e veículos em massa através de ficheiros CSV, incluindo o download de ficheiros de exemplo. Esta funcionalidade foi solicitada para as páginas de Parceiros, Motoristas e Veículos.
4.  **Correções de Bugs Recorrentes:** Resolver repetidamente um erro Erro ao carregar dados do parceiro e um erro crítico e recorrente Parceiro not found durante a importação de CSV, causado por múltiplos fatores (lógica incorreta, cache do browser, dados de utilizador inexistentes na base de dados).
5.  **Criação de Entidade Parceiro:** O utilizador  não conseguia usar a funcionalidade de importação porque não tinha um registo correspondente na coleção . O utilizador forneceu os dados para criar este parceiro.
6.  **Desativação de Motoristas:** Permitir que um parceiro possa desativar/eliminar motoristas da sua própria conta.

**User's preferred language**: Portuguese (português)

**what currently exists?**
A aplicação possui um fluxo de aprovação de parceiros estável e funcionalidade de gestão de certidões permanentes. O sistema de importação de CSV foi significativamente robustecido; o backend agora normaliza automaticamente ficheiros CSV, detetando delimitadores ( ou ), tratando múltiplos encodings (, ), e limpando dados (removendo comentários e convertendo números em notação científica). Uma nova página dedicada, , foi criada para centralizar esta funcionalidade. Um erro crítico e recorrente de Parceiro not found, causado por um ID de utilizador desatualizado no , foi corrigido forçando uma busca de dados atualizados do utilizador () antes de cada operação de importação. A funcionalidade de descarregar CSV de exemplo foi melhorada para incluir dinamicamente o ID do parceiro logado. Um endpoint de backend para parceiros desativarem motoristas foi criado, mas a interface de utilizador (UI) para esta ação ainda não foi implementada.

**Last working item**:
- Last item agent was working: O agente estava prestes a criar um novo registo de parceiro para o utilizador , que não conseguia utilizar a funcionalidade de importação de CSV por não existir na coleção . O utilizador forneceu os dados necessários: Nome da Empresa: zeny macaia unipessoal lda, NIF: 987654321, Nome do Responsável: Zeny macaia.
- Status: NOT STARTED
- Agent Testing Done: N
- Which testing method agent to use? Both. Primeiro, o agente de backend deve criar o parceiro e verificar a sua existência na base de dados. Depois, o agente de frontend deve fazer login como  e confirmar que a funcionalidade de importação de CSV funciona sem o erro Parceiro not found.
- User Testing Done: N

**All Pending/In progress Issue list**:
- Issue 1: (P0) Finalizar a criação do parceiro .
- Issue 2: (P1) Implementar a interface de utilizador (UI) para a funcionalidade de desativação de motoristas.
- Issue 3: (P2) Erro recorrente de validação Pydantic no modelo .
- Issue 4: (P3) Extração de dados do scraper da Via Verde está incompleta.
- Issue 5: (P3) Refatoração do monólito .
- Issue 6: (P4) Funcionalidade de envio de relatórios por Email/WhatsApp está simulada.

Issues Detail:
- Issue 1:
    - Attempted fixes: O agente diagnosticou que o utilizador  não tinha um registo na coleção , o que causava o erro Parceiro not found. O agente obteve os dados necessários do utilizador para criar o registo.
    - Next debug checklist:
        1. Executar um comando para criar um novo documento na coleção  com os dados fornecidos pelo utilizador (, , , ). Certificar-se de que o uid=0(root) gid=0(root) groups=0(root) do novo parceiro corresponde ao uid=0(root) gid=0(root) groups=0(root) do utilizador  na coleção .
        2. Testar o fluxo de login e importação de CSV com a conta .
    - Why fix this issue and what will be achieved with the fix? Irá desbloquear um utilizador principal e confirmar que a arquitetura de resolução de bugs implementada está correta.
    - Status: NOT STARTED
    - Is recurring issue? Y (O sintoma Parceiro not found é recorrente, embora a causa raiz seja nova).
    - Should Test frontend/backend/both after fix? Both
    - Blocked on other issue: None
- Issue 2:
    - Attempted fixes: O agente criou o endpoint de backend  que permite a um parceiro alterar o estado de um motorista para inativo.
    - Next debug checklist:
        1. Modificar o componente .
        2. Adicionar um botão de Desativar (ou um ícone) na linha de cada motorista na tabela.
        3. A ação de clique deve chamar o novo endpoint e, em caso de sucesso, atualizar a UI para refletir o novo estado do motorista.
    - Why fix this issue and what will be achieved with the fix? Completará uma funcionalidade solicitada pelo utilizador, dando aos parceiros mais autonomia na gestão das suas contas.
    - Status: NOT STARTED
    - Is recurring issue? N
    - Should Test frontend/backend/both after fix? Both
    - Blocked on other issue: None

**In progress Task List**:
- Task 1: (P0) Criar o registo de parceiro para .
    - Where to resume: Utilizar um script ou um comando  para interagir com o endpoint de criação de parceiros () e inserir os dados fornecidos pelo utilizador na base de dados.
    - What will be achieved with this? Resolverá o bloqueio principal do utilizador .
    - Status: NOT STARTED
    - Should Test frontend/backend/both after fix? Both
    - Blocked on something: None

**Upcoming and Future Tasks**
*   **Upcoming Tasks:**
    *   (P1) **UI para Desativar Motorista:** Implementar o botão e a lógica no frontend para que os parceiros possam desativar motoristas.
    *   (P2) **Sistema Unificado de Templates:** Criar um sistema de templates de contrato globais/únicos.
*   **Future Tasks:**
    *   (P2) **Finalizar o Scraper da Via Verde:** Implementar a lógica de extração de dados.
    *   (P2) **Refatorar :** Dividir o ficheiro monolítico em múltiplos routers.
    *   (P3) Implementar parsers para outros formatos de CSV/plataformas.
    *   (P3) Integrar um serviço real de envio de relatórios por Email/WhatsApp.
    *   (P3) Implementar Relatório de Faturação Mensal para Parceiros.
    *   (P3) Teste ponta-a-ponta da integração com Moloni.

**Completed work in this session**
- **Robustez da Importação CSV (DONE):**
    - Corrigido erro de decoding  implementando uma tentativa de múltiplos encodings (, ).
    - Adicionada deteção automática de delimitador de CSV ( ou ).
    - Criada uma função de normalização de CSV () que remove comentários e converte números em notação científica.
- **Nova Página de Importação CSV (DONE):**
    - Criada e implementada uma nova página dedicada  com uma interface unificada.
- **Correção de Parceiro not found (DONE):**
    - Diagnosticado e corrigido um bug crítico onde o frontend enviava um  desatualizado do . A solução foi implementar uma chamada ao endpoint  para obter dados atualizados do utilizador antes de cada importação.
- **Melhorias nos Ficheiros de Exemplo CSV (DONE):**
    - O endpoint de download de exemplos agora gera o ficheiro dinamicamente, incluindo o ID do parceiro logado no cabeçalho.
    - Adicionada a coluna Validade de CC ao exemplo de motoristas e a coluna Localidade ao exemplo de veículos, com a respetiva lógica de processamento no backend.
- **Correções de Bugs de Frontend (DONE):**
    - Resolvido um erro de runtime .
    - Corrigido o download de ficheiros de exemplo que falhava por falta de token de autenticação.
    - Corrigidos múltiplos Script errors genéricos através da correção de erros de lint, utilização da biblioteca de toast correta () e padronização da importação da variável de ambiente da API.
- **Endpoint de Desativação de Motorista (Backend DONE):**
    - Criado o endpoint  para permitir que parceiros desativem motoristas.

**Earlier issues found/mentioned but not fixed**
-   A refatoração do  continua pendente e é uma dívida técnica crítica.
-   A extração de dados do scraper da Via Verde continua por resolver.

**Known issue recurrence from previous fork**
-   **Parceiro not found:** Este erro foi a questão central desta sessão. Ocorreu várias vezes com diferentes causas (lógica de ID, cache, dados inexistentes). A última causa foi um registo de parceiro em falta, que está prestes a ser corrigido. A sua natureza recorrente exige atenção.
-   **Recurrence count:** Muito Elevado
-   **Status:** IN PROGRESS (a causa raiz final está a ser tratada).

**Code Architecture**
getInitials

**Key Technical Concepts**
- **Normalização de Dados (Python):** O agente implementou uma função robusta () no backend para pré-processar ficheiros CSV, lidando com diferentes delimitadores, encodings, comentários e formatos de dados.
- **Gestão de Estado no Frontend (React):** O agente diagnosticou com sucesso um problema complexo de estado obsoleto no  e implementou uma solução sólida ao forçar a obtenção de dados atualizados do utilizador a partir de um endpoint () antes de operações críticas.
- **Depuração de Erros (React):** O agente demonstrou competência na resolução de erros genéricos de frontend (Script error, Network Error), usando um processo metódico de verificação de linting, importações, props e estado.

**key DB schema**
-   **users**: 
-   **parceiros**:  (O utilizador  não existe nesta coleção).
-   **motoristas**:  (O campo  foi adicionado para suportar a desativação).

**changes in tech stack**
-   Nenhuma.

**All files of reference**
-   **Criados**:
    -   
-   **Atualizados Criticamente**:
    -   : Lógica de importação de CSV, novo endpoint de desativação.
    -   : Múltiplas correções de bugs (download, importação, estado do utilizador).
    -   : Adicionada nova rota.
    -   : Adicionado novo item de menu.

**Areas that need refactoring**:
-   ****: Continua a ser a maior dívida técnica, com a sua complexidade a crescer a cada nova funcionalidade.
-   ****: Sendo um ficheiro novo e intensamente modificado, beneficiaria de uma refatoração para melhorar a clareza e talvez extrair lógica reutilizável.

**key api endpoints**
-   **Novos:**
    -   
-   **Modificados:**
    -    (lógica de normalização adicionada)
    -    (lógica de normalização adicionada)
    -    (agora gera dinamicamente com ID do parceiro)
    -    (agora usado pelo frontend para obter dados atualizados do utilizador)

**Critical Info for New Agent**
-   **Prioridade Imediata:** A sua primeira tarefa é criar o registo de parceiro para a conta . O utilizador está completamente bloqueado sem isto. Use os dados fornecidos: Nome da Empresa: , NIF: , Nome do Responsável: . O email é . Certifique-se de que o uid=0(root) gid=0(root) groups=0(root) do parceiro criado corresponde ao uid=0(root) gid=0(root) groups=0(root) do utilizador existente na coleção .
-   **Funcionalidade Inacabada:** O utilizador pediu para poder desativar motoristas. O backend está pronto (), mas a UI não existe. Esta é a sua próxima tarefa de alta prioridade após resolver o problema do .
-   **Atenção ao Parceiro not found:** Este erro foi extremamente recorrente. Embora a causa raiz pareça agora estar identificada (um registo de parceiro em falta), esteja preparado para que o erro possa ressurgir se houver outras inconsistências de dados.

**Last 10 User Messages and any pending user messages**
1.  **User**: Pede para o exemplo de CSV usar sempre o ID do parceiro logado. **Status: COMPLETED**.
2.  **User**: Informa que o sistema só funciona para  e não para , anexando um screenshot. **Status: IN PROGRESS**.
3.  **User**: Pergunta se  já não é um parceiro ativo. **Status: IN PROGRESS**.
4.  **User**: Fornece os dados para criar o parceiro . **Status: PENDING (Current Task)**.

**Project Health Check:**
-   **Broken**: A conta do utilizador  não é funcional para tarefas essenciais (como importação) porque não tem um registo de parceiro associado na base de dados.
-   **Mocked**: Envio de relatórios por Email/WhatsApp.

**3rd Party Integrations**
-   Playwright
-   Moloni
-   openpyxl
-   reportlab

**Testing status**
-   Testing agent used after significant changes: YES
-   Troubleshoot agent used after agent stuck in loop: NO
-   Test files created: []
-   Known regressions: Nenhuma.

**Credentials to test flow:**
-   As credenciais estão em .
-   **Utilizador com problemas:**  (Senha: )
-   **Utilizador funcional:**  (Senha: )

**What agent forgot to execute**
-   O agente anterior não chegou a criar o registo de parceiro para  depois de receber os dados.
-   O agente implementou o backend para a desativação de motoristas, mas esqueceu-se de implementar a interface de utilizador correspondente no frontend, deixando a funcionalidade incompleta.</analysis>
