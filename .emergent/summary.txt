<analysis>**original_problem_statement:**
O utilizador iniciou com a necessidade de desenvolver um sistema robusto para a gestão de relatórios semanais de frotas. Os requisitos evoluíram para incluir:
1.  **Gestão de Relatórios:** Um fluxo completo com os estados , , ,  e .
2.  **Criação de Relatórios:** Métodos de criação Manual, Semi-Manual (importação de CSV/Excel) e Automático (sincronização agendada).
3.  **Importação de Dados:** Uma página dedicada para importar dados de várias plataformas (Uber, Bolt, Via Verde, GPS, Combustível, Carregamentos Elétricos), adaptando-se a diferentes formatos de ficheiro e criando relatórios de rascunho automaticamente.
4.  **Lógica de Agregação:** Ao gerar relatórios para uma semana específica, o sistema deve agregar os dados da Uber e Bolt da semana atual com os dados da Via Verde da semana *anterior*.
5.  **Correção de Bugs:** Múltiplos bugs foram reportados, principalmente relacionados com a falha na importação de ficheiros de diversas plataformas e a persistência de dados em formulários de edição de veículos e motoristas. O utilizador fornece feedback contínuo e ficheiros de exemplo para depuração.

**User's preferred language**: Portuguese (português)

**what currently exists?**
A aplicação full-stack (React + FastAPI) possui um Hub de Relatórios () e uma página de importação () altamente customizada. O sistema agora suporta a importação de dados de diversas fontes (Uber, Bolt, Via Verde Portagens, Via Verde Carregamentos, GPS, Combustível) através de uma lógica complexa no backend que lida com múltiplos formatos de ficheiro (CSV, XLSX), delimitadores, codificações e identificadores de veículos/motoristas (Matrícula, OBU, vários tipos de cartões, UUID, etc.). A página de importação foi melhorada com seletores de Ano/Semana que sincronizam bidirecionalmente com campos de data. A maior parte do trabalho recente focou-se em corrigir sucessivos bugs de importação reportados pelo utilizador. Um novo campo () foi adicionado ao frontend para diferenciar cartões de carregamento elétrico dos de combustível.

**Last working item**:
- Last item agent was working: Implementação de um campo dedicado para cartões de carregamento elétrico. O utilizador solicitou a criação do campo  para distinguir do  (usado para combustível). O agente adicionou o campo com sucesso ao formulário do frontend em  e estava prestes a atualizar a lógica do backend para utilizá-lo.
- Status: IN PROGRESS
- Agent Testing Done: N
- Which testing method agent to use? both. O agente deve:
    1.  Atualizar o backend () para salvar o novo campo  no endpoint .
    2.  Atualizar a lógica de importação de carregamentos elétricos para procurar veículos usando o novo campo .
    3.  Usar o  para garantir que o novo campo pode ser editado e salvo corretamente na página .
    4.  Usar o  com um ficheiro de carregamentos para confirmar que a importação associa corretamente os dados ao veículo através do novo campo.
- User Testing Done: N

**All Pending/In progress Issue list**:
-   Issue 1: (P0) Finalizar a implementação do .
-   Issue 2: (P0) Bugs recorrentes na gravação de dados nos formulários  e .
-   Issue 3: (P1) A criação de relatórios de Rascunho após a importação não está a funcionar como esperado; os relatórios são criados como Pendente.
-   Issue 4: (P3) Refatoração do ficheiro monolítico .
-   Issue 5: (P4) Perda intermitente de dados de teste na base de dados.

Issues Detail:
-   Issue 1:
    -   Attempted fixes: O campo foi adicionado ao frontend. A lógica do backend ainda não foi modificada.
    -   Next debug checklist:
        1.  Modificar o endpoint  em  para aceitar e guardar o campo .
        2.  Na função  em , modificar a lógica de importação de carregamentos elétricos ( e ) para usar o  para encontrar o veículo correspondente.
    -   Why fix this issue and what will be achieved with the fix? Vai permitir a correta distinção e associação de custos entre abastecimentos de combustível e carregamentos elétricos.
    -   Status: IN PROGRESS
    -   Is recurring issue? N
    -   Should Test frontend/backend/both after fix? Both
    -   Blocked on other issue: None
-   Issue 2:
    -   Attempted fixes: Várias tentativas foram feitas em forks anteriores, mas o utilizador continua a reportar que os dados não são salvos de forma fiável. O problema foi adiado para corrigir bugs de importação mais urgentes.
    -   Next debug checklist:
        1.  Usar o  para executar um teste E2E rigoroso: editar todos os campos em  e , salvar, recarregar a página e verificar se os dados persistiram.
        2.  Inspecionar os payloads das requisições  e as respostas do servidor no browser.
        3.  Adicionar logging detalhado nos endpoints de atualização do backend ( e de motoristas) para verificar os dados recebidos e o resultado da operação no MongoDB.
    -   Why fix this issue and what will be achieved with the fix? A gestão de veículos e motoristas é uma funcionalidade central e está atualmente inutilizável ou pouco fiável.
    -   Status: NOT STARTED
    -   Is recurring issue? Y
    -   Should Test frontend/backend/both after fix? Both
    -   Blocked on other issue: None
-   Issue 3:
    -   Attempted fixes: O agente criou uma função  e chamou-a no final de cada fluxo de importação. No entanto, o utilizador reportou em  que os relatórios ainda não são criados como rascunho.
    -   Next debug checklist:
        1.  Rever a função  em  para garantir que o campo  está a ser definido como .
        2.  Verificar no  se os relatórios estão a ser filtrados corretamente e se o estado  é exibido.
        3.  Após uma importação bem-sucedida, verificar diretamente na base de dados MongoDB qual o estado do  criado.
    -   Why fix this issue and what will be achieved with the fix? Corresponde a um requisito fundamental do fluxo de trabalho do utilizador: importar dados para rascunho e depois gerar o relatório final.
    -   Status: NOT STARTED
    -   Is recurring issue? Y
    -   Should Test frontend/backend/both after fix? Both
    -   Blocked on other issue: None

**In progress Task List**:
-   Task 1: Concluir a implementação do campo 
    -   Where to resume: No ficheiro . É necessário modificar o endpoint de atualização de veículos e o endpoint de importação de carregamentos.
    -   What will be achieved with this? Separação clara entre os custos de combustível fóssil e carregamentos elétricos.
    -   Status: IN PROGRESS
    -   Should Test frontend/backend/both after fix? Both
    -   Blocked on something: None

**Upcoming and Future Tasks**
-   **Upcoming Tasks:**
    -   (P1) Implementar o método Automático de criação de relatórios (sincronização agendada).
-   **Future Tasks:**
    -   (P2) Refatorar  em múltiplos ficheiros de rotas (ex: , ). Esta é uma necessidade crítica para a manutenibilidade.
    -   (P3) Refatorar os componentes React  e  em componentes mais pequenos.
    -   (P4) Investigar a causa da instabilidade da base de dados de teste.

**Completed work in this session**
-   **Correção de Importação (Várias):** Corrigidos múltiplos bugs de importação para Bolt, GPS, Via Verde (Portagens e Carregamentos), e Combustível, ajustando a lógica para usar os identificadores corretos (UUID, matrícula, OBU, tipos de cartão) e lidar com diferentes formatos de ficheiro e codificações.
-   **Melhoria da UI de Importação:** Adicionados campos de Ano e Semana na página de importação, com lógica de JavaScript para calcular e sincronizar bidirecionalmente as datas de início e fim.
-   **Correção de Erro de Login:** Resolvido um  no backend que impedia o login.
-   **Correção de Autorização:** Ajustada a permissão no endpoint de exclusão de relatórios para permitir que parceiros possam excluir relatórios pendentes.
-   **Correção de Agregação:** Ajustada a lógica de criação de rascunhos para garantir que os valores monetários (ganhos, custos) são corretamente somados.
-   **Frontend:** Adicionado o campo  ao formulário em .

**Earlier issues found/mentioned but not fixed**
-   A refatoração de  e dos componentes React continua pendente.
-   A investigação sobre a instabilidade da base de dados não foi iniciada.

**Known issue recurrence from previous fork**
-   **Perda de dados de teste:** A causa raiz deste problema, observado no fork anterior, continua por investigar.
-   **Bugs de gravação em formulários:** O problema de persistência de dados em  e  é um problema recorrente e de alta prioridade que ainda não foi resolvido.
-   Recurrence count: 2
-   Status: NOT STARTED

**Code Architecture**


**Key Technical Concepts**
-   **Parsing de Ficheiros Dinâmico:** O endpoint  em  tornou-se um sistema extremamente complexo que tenta inferir o formato (CSV/Excel), delimitador, codificação e estrutura de múltiplos tipos de ficheiros de diferentes fontes, usando uma longa cadeia de .
-   **Mapeamento de Identificadores:** O sistema depende de uma lógica de mapeamento complexa para associar dados importados a veículos, usando uma hierarquia de identificadores: , , , , ,  e .
-   **Sincronização de Estado no Frontend:** A página  utiliza  para criar uma sincronização bidirecional entre os campos de Ano/Semana e os campos de Data Início/Fim, melhorando a usabilidade.

**key DB schema**
-   **vehicles**: Contém múltiplos identificadores como , , , . O campo  foi adicionado no frontend e precisa ser implementado no backend.
-   **motoristas**: Contém , , , etc.
-   **relatorios_semanais**: O estado () deve ser  após a importação, mas atualmente parece estar a ser definido como .
-   **Coleções de dados brutos**: , , , , etc., para armazenar os dados importados.

**changes in tech stack**
-   Nenhuma.

**All files of reference**
-   
-   
-   
-   

**Areas that need refactoring**:
-   ****: A refatoração é URGENTE. O ficheiro é excessivamente grande, tornando a depuração e a adição de novas funcionalidades extremamente propensas a erros e regressões. A lógica de importação deve ser dividida em módulos separados por plataforma.
-   ****: A lógica de estado e os handlers de importação podem ser extraídos para hooks customizados para melhorar a legibilidade.

**key api endpoints**
-   : O endpoint central para todas as importações, massivamente modificado e complexo.
-   : Suspeito de conter bugs que impedem a gravação de dados.
-   : Corrigido para funcionar com o estado pendente e para a role PARCEIRO.
-   : Funcionalidade principal que depende da importação correta dos dados.

**Critical Info for New Agent**
-   **Foco Imediato (P0):** A sua primeira tarefa é finalizar a implementação do campo  no backend (), tanto no endpoint de atualização do veículo quanto na lógica de importação de carregamentos elétricos.
-   **Próxima Prioridade (P0):** Imediatamente a seguir, deve dedicar-se a resolver de forma definitiva os bugs de gravação de dados em  e . Este é um problema antigo e uma grande fonte de frustração para o utilizador.
-   **Valide o Fluxo de Rascunho (P1):** Verifique por que motivo os relatórios importados não estão a ser criados com o estado  e corrija.
-   **Código Legado e Complexidade:** Esteja ciente de que o ficheiro  é extremamente frágil. As alterações devem ser feitas com muito cuidado. A lógica de importação tem muitos ramos () e é fácil introduzir regressões. Siga o feedback do utilizador de perto, pois ele é excelente a encontrar casos de borda.

**documents created in this job**
-   Nenhum.

**Last 10 User Messages and any pending user messages**
1.  **User:** Reporta que a importação de carregamentos falha porque procura por  em vez de . **Status: ADDRESSED**.
2.  **User:** Fornece o mapeamento exato de identificadores para cada tipo de importação. **Status: ADDRESSED**.
3.  **User:** Aponta que o ID de Carregamento e Combustível é o mesmo (). **Status: ADDRESSED** (agente confirmou a configuração).
4.  **User:** Reporta que a importação de carregamentos ainda falha porque está a ir buscar o email em vez do ID da frota. **Status: ADDRESSED**.
5.  **User:** Reporta novamente o erro Email do motorista vazio na importação de carregamentos. **Status: ADDRESSED**.
6.  **User:** Reclama que a mesma importação ainda dá o erro Email do motorista vazio. **Status: ADDRESSED** (agente encontrou a causa raiz e corrigiu a estrutura do ).
7.  **User (LATEST PENDING TASK):** Pede para criar um campo  separado para carregamentos. **Status: IN PROGRESS**.
8.  **User:** Reporta que o formulário está a associar o  (combustível) a carregamentos. **Status: ADDRESSED** (levou ao pedido de criação do novo campo).
9.  **User:** Reporta que a importação de carregamentos elétricos dá erro porque está a procurar  em vez do . **Status: ADDRESSED**.
10. **User:** Reporta que o login não funciona. **Status: RESOLVED**.

**Project Health Check:**
-   **Broken**:
    -   Funcionalidade de gravação de dados em  e .
    -   Criação automática de relatórios de Rascunho (são criados como Pendente).
-   **Mocked**:
    -   Nenhum.

**3rd Party Integrations**
-   Nenhuma.

**Testing status**
-   Testing agent used after significant changes: YES. O agente de testes foi usado várias vezes para validar as complexas lógicas de importação e foi fundamental para encontrar bugs (como  errors).
-   Troubleshoot agent used after agent stuck in loop: NO.
-   Test files created: []
-   Known regressions: A funcionalidade de gravação de dados para veículos e motoristas regrediu ou nunca foi totalmente corrigida.

**Credentials to test flow:**
-   Disponíveis no ficheiro .

**What agent forgot to execute**
-   Resolver de forma definitiva o bug P0 de gravação de dados nos formulários, que foi adiado várias vezes.
-   Iniciar a implementação da criação Automática de relatórios, um requisito original do projeto.
-   Verificar e confirmar com o utilizador que a funcionalidade de criação de Rascunhos está a funcionar corretamente após a tentativa de correção.</analysis>
