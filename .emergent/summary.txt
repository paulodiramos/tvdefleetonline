<analysis>**original_problem_statement:**
O utilizador pretende construir um **Sistema de Integrações Configurável** para a sua aplicação de gestão de frotas. O objetivo é permitir que um administrador defina e configure integrações com vários fornecedores (combustível, TVDE, GPS, etc.). O sistema deve suportar métodos de integração via RPA (com um browser virtual para gravação de passos) e API. O administrador deve poder criar fornecedores, agrupar por categorias, definir os passos de automação, lidar com datas dinâmicas e mapear dados de ficheiros descarregados. Este novo sistema substituirá a lógica de sincronização codificada existente.

**PRODUCT REQUIREMENTS:**
Referir a  para a lista detalhada de requisitos, que foi atualizada para refletir a nova arquitetura de plataformas configuráveis e a implementação do browser virtual.

**User's preferred language**: Portuguese (Portugal)

**what currently exists?**
A aplicação possui um backend em FastAPI e um frontend em React. No ambiente de desenvolvimento, foi implementado um sistema de RPA com um browser virtual (Playwright) que permite aos administradores gravar, testar e executar automações. As funcionalidades mais recentes incluem um seletor de credenciais de parceiro para testar automações de forma segura (sem expor as senhas), a injeção dessas credenciais nos campos de login, e uma UI refinada para maximizar o espaço do browser. O código-fonte completo da aplicação foi exportado para um repositório no GitHub. Atualmente, está a decorrer um processo de deployment manual num VPS do utilizador (PTISP). O servidor foi preparado com Ubuntu 22.04, Docker (para a MongoDB), Nginx, Node.js e Python.

**Last working item**:
-   Last item agent was working: Concluir o deployment manual da aplicação no VPS do utilizador. O agente estava a guiar o utilizador na resolução de um erro de arranque do serviço de backend (). O problema foi diagnosticado como a falta do módulo Python usage: pdfplumber [-h] [--structure | --structure-text]
                  [--format {csv,json,text}] [--types TYPES [TYPES ...]]
                  [--include-attrs INCLUDE_ATTRS [INCLUDE_ATTRS ...]]
                  [--exclude-attrs EXCLUDE_ATTRS [EXCLUDE_ATTRS ...]]
                  [--laparams LAPARAMS] [--precision PRECISION]
                  [--pages PAGES [PAGES ...]] [--indent INDENT]
                  [infile]

positional arguments:
  infile

options:
  -h, --help            show this help message and exit
  --structure           Write the structure tree as JSON. All other arguments
                        except --pages, --laparams, and --indent will be
                        ignored
  --structure-text      Write the structure tree as JSON including text
                        contents. All other arguments except --pages,
                        --laparams, and --indent will be ignored
  --format {csv,json,text}
  --types TYPES [TYPES ...]
  --include-attrs INCLUDE_ATTRS [INCLUDE_ATTRS ...]
                        Include *only* these object attributes in output.
  --exclude-attrs EXCLUDE_ATTRS [EXCLUDE_ATTRS ...]
                        Exclude these object attributes from output.
  --laparams LAPARAMS
  --precision PRECISION
  --pages PAGES [PAGES ...]
  --indent INDENT       Indent level for JSON pretty-printing.. O agente forneceu o comando de instalação e estava prestes a verificar se o serviço arrancava com sucesso.
-   Status: IN PROGRESS
-   Agent Testing Done: N
-   Which testing method agent to use? N/A. O trabalho atual é um deployment manual no servidor do utilizador. A verificação será feita através de comandos  e -- No entries -- via SSH no VPS e, por fim, acedendo ao domínio  no browser.
-   User Testing Done: N

**All Pending/In progress Issue list**:
-   Issue 1: Concluir o deployment da aplicação no VPS (P0)
-   Issue 2: Verificar a Execução de Sincronização Dinâmica (P1)
-   Issue 3: A sessão da Prio expira após cada sincronização (P2)
-   Issue 4: Motoristas incorretos/inativos no Resumo Semanal (P2)
-   Issue 5: Fragilidade da Extração Prio Elétrico (P2)

**Issues Detail:**
-   **Issue 1: Concluir o deployment da aplicação no VPS (P0)**
    -   **Description:** O serviço de backend () falhou ao iniciar no novo VPS do utilizador devido a dependências em falta.
    -   **Attempted fixes:** O agente analisou os logs (-- No entries --) e identificou a falta do módulo usage: pdfplumber [-h] [--structure | --structure-text]
                  [--format {csv,json,text}] [--types TYPES [TYPES ...]]
                  [--include-attrs INCLUDE_ATTRS [INCLUDE_ATTRS ...]]
                  [--exclude-attrs EXCLUDE_ATTRS [EXCLUDE_ATTRS ...]]
                  [--laparams LAPARAMS] [--precision PRECISION]
                  [--pages PAGES [PAGES ...]] [--indent INDENT]
                  [infile]

positional arguments:
  infile

options:
  -h, --help            show this help message and exit
  --structure           Write the structure tree as JSON. All other arguments
                        except --pages, --laparams, and --indent will be
                        ignored
  --structure-text      Write the structure tree as JSON including text
                        contents. All other arguments except --pages,
                        --laparams, and --indent will be ignored
  --format {csv,json,text}
  --types TYPES [TYPES ...]
  --include-attrs INCLUDE_ATTRS [INCLUDE_ATTRS ...]
                        Include *only* these object attributes in output.
  --exclude-attrs EXCLUDE_ATTRS [EXCLUDE_ATTRS ...]
                        Exclude these object attributes from output.
  --laparams LAPARAMS
  --precision PRECISION
  --pages PAGES [PAGES ...]
  --indent INDENT       Indent level for JSON pretty-printing.. O comando Looking in indexes: https://pypi.org/simple, https://d33sy5i8bnduwe.cloudfront.net/simple/
Requirement already satisfied: pdfplumber in /root/.venv/lib/python3.11/site-packages (0.11.9)
Requirement already satisfied: pdfminer.six==20251230 in /root/.venv/lib/python3.11/site-packages (from pdfplumber) (20251230)
Requirement already satisfied: Pillow>=9.1 in /root/.venv/lib/python3.11/site-packages (from pdfplumber) (12.0.0)
Requirement already satisfied: pypdfium2>=4.18.0 in /root/.venv/lib/python3.11/site-packages (from pdfplumber) (5.3.0)
Requirement already satisfied: charset-normalizer>=2.0.0 in /root/.venv/lib/python3.11/site-packages (from pdfminer.six==20251230->pdfplumber) (3.4.4)
Requirement already satisfied: cryptography>=36.0.0 in /root/.venv/lib/python3.11/site-packages (from pdfminer.six==20251230->pdfplumber) (46.0.3)
Requirement already satisfied: cffi>=2.0.0 in /root/.venv/lib/python3.11/site-packages (from cryptography>=36.0.0->pdfminer.six==20251230->pdfplumber) (2.0.0)
Requirement already satisfied: pycparser in /root/.venv/lib/python3.11/site-packages (from cffi>=2.0.0->cryptography>=36.0.0->pdfminer.six==20251230->pdfplumber) (2.23) foi fornecido como correção.
    -   **Next debug checklist:**
        1.  No VPS, executar  para confirmar se o serviço está .
        2.  Se falhar, executar -- No entries -- para obter os novos logs de erro.
        3.  Após o backend estar funcional, verificar o estado do Nginx com  e os logs com .
        4.  Pedir ao utilizador para aceder a  e verificar se a aplicação carrega e funciona (ex: login).
    -   **Why fix this issue and what will be achieved with the fix?** Para colocar a aplicação em produção no servidor do utilizador, concluindo o objetivo da sessão atual.
    -   **Status:** IN PROGRESS
    -   **Is recurring issue?** N
    -   **Should Test frontend/backend/both after fix?** Teste manual e E2E no ambiente de produção.
    -   **Blocked on other issue:** Não.

**In progress Task List**:
-   **Task 1: Finalizar o Deployment no VPS (P0)**
    -   **Where to resume:** O utilizador está conectado ao VPS via SSH. O próximo comando a executar é  para verificar se a instalação do usage: pdfplumber [-h] [--structure | --structure-text]
                  [--format {csv,json,text}] [--types TYPES [TYPES ...]]
                  [--include-attrs INCLUDE_ATTRS [INCLUDE_ATTRS ...]]
                  [--exclude-attrs EXCLUDE_ATTRS [EXCLUDE_ATTRS ...]]
                  [--laparams LAPARAMS] [--precision PRECISION]
                  [--pages PAGES [PAGES ...]] [--indent INDENT]
                  [infile]

positional arguments:
  infile

options:
  -h, --help            show this help message and exit
  --structure           Write the structure tree as JSON. All other arguments
                        except --pages, --laparams, and --indent will be
                        ignored
  --structure-text      Write the structure tree as JSON including text
                        contents. All other arguments except --pages,
                        --laparams, and --indent will be ignored
  --format {csv,json,text}
  --types TYPES [TYPES ...]
  --include-attrs INCLUDE_ATTRS [INCLUDE_ATTRS ...]
                        Include *only* these object attributes in output.
  --exclude-attrs EXCLUDE_ATTRS [EXCLUDE_ATTRS ...]
                        Exclude these object attributes from output.
  --laparams LAPARAMS
  --precision PRECISION
  --pages PAGES [PAGES ...]
  --indent INDENT       Indent level for JSON pretty-printing. resolveu o problema de arranque do serviço.
    -   **What will be achieved with this?** A aplicação estará totalmente operacional no domínio .
    -   **Status:** IN PROGRESS
    -   **Should Test frontend/backend/both after fix?** Teste manual do site em produção.
    -   **Blocked on something:** Não.

**Upcoming and Future Tasks**
*   **Upcoming Tasks:**
    *   **(P0) Configurar SSL/HTTPS:** Instalar Certbot no VPS e configurar um certificado SSL para o domínio , garantindo que todo o tráfego seja servido via HTTPS.
    *   **(P1) Refatorar a Página de Sincronização do Parceiro:** Modificar a UI do parceiro para que os botões de sincronização chamem o novo endpoint dinâmico ().
    *   **(P2) Pedir Validação ao Utilizador:** Planear um ponto de paragem para perguntar ao utilizador se os problemas da sessão da Prio e dos motoristas no resumo foram resolvidos.
*   **Future Tasks:**
    *   Implementar integração com WhatsApp (QR Code + API).
    *   Refatorar God Components como .
    *   Implementar funcionalidades Alertas Avançados e Comissões Avançadas.
    *   Arquivar dados antigos da base de dados.

**Completed work in this session**
-   **Fluxo de UI do RPA (Corrigido e Melhorado):**
    -   Resolvido o bug que fazia o browser virtual iniciar automaticamente.
    -   Corrigido o botão de gravação que dependia erradamente de uma conexão WebSocket; agora funciona com a sessão REST.
-   **Injeção Segura de Credenciais:**
    -   Implementado um novo endpoint e botões na UI (Inserir Email, Inserir Password) que permitem ao admin usar as credenciais de um parceiro durante a gravação de um RPA sem nunca as visualizar.
-   **Refatoração da UI do Browser Virtual:**
    -   Os controlos de gravação, os botões de injeção de credenciais e o botão de terminar foram movidos para o cabeçalho, libertando mais espaço vertical para a visualização do browser.
    -   Corrigido um problema de layout que escondia parte dos controlos.
-   **Correções de Lógica de Dados:**
    -   O backend foi adaptado para procurar credenciais de parceiros numa coleção secundária (), resolvendo um problema em que os dados do utilizador Tomas não eram encontrados.
-   **Guia de Deployment Manual no VPS:**
    -   Guiou o utilizador, passo a passo, a reinstalar o OS (Ubuntu 22.04) no seu VPS.
    -   Forneceu todos os comandos para instalar e configurar o ambiente de produção: Docker, MongoDB, Nginx, Node.js 20, Python 3, e as dependências da aplicação.
    -   Configurou o Nginx como reverse proxy e criou um serviço  para o backend.

**Earlier issues found/mentioned but not fixed**
-   **Issue 1: Fragilidade da Extração Prio Elétrico**
    -   **Debug checklist:** A causa do erro (possível bloqueio de proxy, seletores frágeis) precisa ser investigada. O novo executor dinâmico deve ter logging robusto para facilitar este diagnóstico.
    -   **Why to solve this issue and what will be achieved with this?** Garante uma extração de dados fiável, que é um requisito central da aplicação.
    -   **Should Test frontend/backend/both after fix:** backend
    -   **Is recurring issue?** Y

**Known issue recurrence from previous fork**
-   **Issue recurrence in previous fork:** Persistência da Sessão Prio.
-   **Recurrence count:** 3+
-   **Status:** USER VERIFICATION PENDING

**Code Architecture**


**Key Technical Concepts**
-   **Backend:** FastAPI, Pydantic, MongoDB.
-   **Frontend:** React.js.
-   **RPA:** Playwright.
-   **Deployment:** Deployment manual num VPS Linux (Ubuntu), Nginx como reverse proxy,  para gestão de serviços, Docker para a base de dados.

**key DB schema**
-   **plataformas:** Armazena a configuração para cada fornecedor (Prio, Via Verde, etc.).
-   **parceiros:** Dados dos parceiros da frota.
-   **rpa_rascunhos:** Guarda rascunhos de passos RPA durante a gravação.
-   **credenciais_plataforma:** Coleção separada para guardar as credenciais encriptadas dos parceiros para as várias plataformas.

**All files of reference**
-   : Componente principal do browser virtual, extensivamente modificado.
-   : Endpoints que controlam a sessão Playwright.
-   : Endpoints relacionados com a gestão das plataformas.
-   : (No VPS) Configuração do Nginx.
-   : (No VPS) Ficheiro de definição do serviço do backend.

**key api endpoints**
-   : (NOVO) Injeta uma credencial (email/password) na sessão do browser de forma segura.
-   : (MODIFICADO) Lista parceiros com credenciais para uma dada plataforma.
-   : Dispara a execução de uma sincronização RPA.

**Critical Info for New Agent**
-   O foco principal é **concluir o deployment no VPS do utilizador**. Não deve iniciar novas funcionalidades até que a aplicação esteja estável em produção.
-   Está a interagir com o utilizador para executar comandos num servidor real via SSH. Ferramentas internas como  ou  não são aplicáveis.
-   O próximo passo é verificar o estado do serviço  no VPS.
-   Após o backend estar funcional, é crucial guiar o utilizador a testar o site em .
-   Uma tarefa de alta prioridade, assim que o site estiver no ar, é **configurar o SSL (HTTPS)**.
-   **Credenciais do VPS:**
    -   IP: 
    -   Utilizador: 
    -   Password: 

**documents and test reports created in this job**
-    (Atualizado)

**Last 10 User Messages and any pending HUMAN messages**
O utilizador está a seguir as instruções do agente para fazer o deployment manual da aplicação no seu VPS. A comunicação é uma sequência de comandos e respostas do terminal. Os últimos passos foram a instalação de dependências e a tentativa de iniciar o serviço de backend, que falhou e está a ser depurada. A última mensagem do utilizador () confirma que recebeu a instrução de instalar o usage: pdfplumber [-h] [--structure | --structure-text]
                  [--format {csv,json,text}] [--types TYPES [TYPES ...]]
                  [--include-attrs INCLUDE_ATTRS [INCLUDE_ATTRS ...]]
                  [--exclude-attrs EXCLUDE_ATTRS [EXCLUDE_ATTRS ...]]
                  [--laparams LAPARAMS] [--precision PRECISION]
                  [--pages PAGES [PAGES ...]] [--indent INDENT]
                  [infile]

positional arguments:
  infile

options:
  -h, --help            show this help message and exit
  --structure           Write the structure tree as JSON. All other arguments
                        except --pages, --laparams, and --indent will be
                        ignored
  --structure-text      Write the structure tree as JSON including text
                        contents. All other arguments except --pages,
                        --laparams, and --indent will be ignored
  --format {csv,json,text}
  --types TYPES [TYPES ...]
  --include-attrs INCLUDE_ATTRS [INCLUDE_ATTRS ...]
                        Include *only* these object attributes in output.
  --exclude-attrs EXCLUDE_ATTRS [EXCLUDE_ATTRS ...]
                        Exclude these object attributes from output.
  --laparams LAPARAMS
  --precision PRECISION
  --pages PAGES [PAGES ...]
  --indent INDENT       Indent level for JSON pretty-printing., mas ainda não executou o comando seguinte para verificar o estado do serviço.

**Project Health Check:**
-   **Broken:** A aplicação não está totalmente funcional no servidor de produção do utilizador. O serviço de backend é o principal ponto de falha neste momento.
-   **Mocked:** N/A

**3rd Party Integrations**
-   **Playwright:** Essencial para a funcionalidade de RPA.
-   **Docker:** Usado para correr a base de dados MongoDB no VPS.
-   **Nginx:** Usado como reverse proxy no VPS.

**Testing status**
-   **Testing agent used after significant changes:** NO (Não aplicável nesta sessão de deployment)
-   **Troubleshoot agent used after agent stuck in loop:** NO
-   **Test files created:** None
-   **Known regressions:** A persistência da sessão Prio é um problema recorrente que aguarda verificação do utilizador.

**Credentials to test flow:**
-   **VPS:**  (Password: )
-   **App Test User:** Tomas (), Password:  (para a plataforma Via Verde)

**What agent forgot to execute**
O agente estava a meio de um processo de depuração e não se esqueceu de nada. No entanto, um passo crucial para o futuro deployment não foi explicitamente planeado: a **configuração do SSL/HTTPS** com Certbot/Let's Encrypt. Isto deve ser uma prioridade após a aplicação estar a funcionar em HTTP.</analysis>
