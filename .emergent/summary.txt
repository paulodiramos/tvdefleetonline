<analysis>**original_problem_statement:**
A sessão começou com vários pedidos de funcionalidades:
1.  **Gestão de Turnos de Veículos.**
2.  **Sistema de Sincronização Automática:** Recolha de dados da Uber, Bolt, Via Verde, etc.
3.  **Refatoração do Backend:** Mover lógica do  monolítico.
4.  **Sistema de Exportação de Dados:** Exportar dados para CSV.
5.  **Sistema de Importação de Dados:** Atualizar dados via CSV.
6.  **Página Meu Plano e Loja:** Para os parceiros gerirem as suas subscrições.
7.  **Consolidação de Menus:** Unificar páginas de configuração.
8.  **Integração com a API oficial da Bolt:** Substituir o método de scraping.
9.  **Refinar Lógica de Sincronização:** Associar dados (motoristas, veículos) automaticamente, criar registos de ganhos/despesas e permitir agendamento com regras específicas (ex: atraso para a Via Verde).
10. **Prevenção de Criação de Dados:** Garantir que a sincronização não cria novos motoristas nem os move entre parceiros, apenas associa os existentes.
11. **Correção do Resumo Semanal:** Assegurar que os valores sincronizados da Bolt aparecem corretamente no resumo semanal.

**User's preferred language**: Portuguese (português)

**what currently exists?**
-   A aplicação está largamente funcional, com sistemas de gestão de planos, comissões, turnos e exportação de dados implementados.
-   A refatoração do backend está em progresso.
-   O bug de importação de CSV foi corrigido; a funcionalidade está operacional.
-   As páginas Meu Plano e Loja de Planos estão criadas e funcionais.
-   Os menus de configuração foram consolidados na página Configurações Parceiro, que agora tem várias tabs (Plataformas, Sincronização, etc.).
-   A **integração com a API oficial da Bolt está totalmente implementada e funcional**, incluindo a autenticação via OAuth2 com as credenciais fornecidas pelo utilizador.
-   O sistema de sincronização foi atualizado para usar a API da Bolt, associando motoristas e veículos existentes e criando registos de ganhos na coleção .
-   A UI de sincronização foi melhorada para permitir a escolha do método (API vs. Manual) e adicionar botões de atalho na página de Resumo Semanal.

**Last working item**:
-   **Last item agent was working:** O agente estava a corrigir dois problemas críticos na funcionalidade de sincronização da Bolt, conforme solicitado pelo utilizador:
    1.  A sincronização não deve criar motoristas novos nem reatribuí-los se pertencerem a outro parceiro. O agente aplicou uma correção à query de busca de motoristas em  para torná-la mais restrita.
    2.  Os valores de ganhos sincronizados da Bolt não estavam a ser exibidos no resumo semanal das semanas 1 e 2. O agente estava a investigar a causa.
-   **Status:** IN PROGRESS
-   **Agent Testing Done:** N
-   **Which testing method agent to use?** backend testing agent. O agente deve criar testes para o endpoint  (fonte 'bolt') para verificar o seguinte:
    1.  **Associação Correta:** Confirma que um motorista da Bolt é associado a um motorista local se pertencerem ao mesmo parceiro.
    2.  **Prevenção de Associação Cruzada:** Confirma que um motorista da Bolt **não** é associado se o motorista local correspondente pertencer a um parceiro diferente.
    3.  **Prevenção de Criação:** Confirma que **não** são criados novos motoristas se não for encontrada correspondência.
    4.  **Validação do Resumo Semanal:** Após uma sincronização bem-sucedida de uma semana com dados de ganhos, o agente deve chamar o endpoint  e verificar se a coluna Bolt contém os valores corretos.
-   **User Testing Done:** N

**All Pending/In progress Issue list**:
-   **Issue 1: (P0) Valores da Bolt não aparecem no Resumo Semanal**
    -   **Attempted fixes:** O agente identificou que o endpoint do resumo semanal () agrega dados da coleção . A lógica de sincronização foi corrigida para usar os campos  e  corretamente. No entanto, o problema persiste, sugerindo que a pipeline de agregação no endpoint do relatório pode não estar a somar os valores corretamente para a semana selecionada.
    -   **Next debug checklist:**
        1.  No ficheiro , analisar a pipeline de agregação do MongoDB no endpoint .
        2.  Verificar como os ganhos da Bolt () são processados e somados.
        3.  Executar uma sincronização para uma semana passada que tenha viagens (se possível) e depois depurar a query de agregação para ver porque o valor resultante é zero.
    -   **Why fix this issue and what will be achieved with the fix?** É um requisito central da funcionalidade. Sem isto, a sincronização é inútil, pois os dados não são visíveis para o utilizador.
    -   **Status:** IN PROGRESS
    -   **Is recurring issue?** Y
    -   **Should Test frontend/backend/both after fix?** backend
    -   **Blocked on other issue:** N/A

**In progress Task List**:
-   **Task 1: (P0) Finalizar e verificar a lógica de sincronização de dados.**
    -   **Where to resume:** Verificar a correção aplicada em  (função que executa a sincronização da Bolt) para garantir que a associação de motoristas é segura e não cria/move dados indevidamente.
    -   **What will be achieved with this?** Uma funcionalidade de sincronização robusta, segura e que cumpre todos os requisitos do utilizador, prevenindo a corrupção de dados entre parceiros.
    -   **Status:** IN PROGRESS
    -   **Should Test frontend/backend/both after fix?** backend
    -   **Blocked on something:** A correção do Issue 1.

**Upcoming and Future Tasks**
-   **Upcoming Tasks:**
    -   **(P2) Implementar simulação de extração de CSV para Admins:** Permitir que o admin programe extrações simuladas para outras plataformas, carregando os dados diretamente.
    -   **(P2) Implementar atraso na sincronização da Via Verde:** O utilizador pediu para poder configurar um atraso de 1 ou 2 semanas. A UI foi adicionada, mas a lógica de backend está pendente.
    -   **(P2) Testar o parser de CSV da Via Verde:** Requisito antigo que continua pendente.
    -   **(P2) Criar uma página dedicada para o histórico de execuções de sincronização.**
-   **Future Tasks:**
    -   **(P1) Implementar Integração Ifthenpay:** (Adiado pelo utilizador).
    -   **(P1) Implementar Integração Moloni:** (Adiado pelo utilizador).
    -   **(P3) Refatoração Contínua do :** Ainda existem muitos endpoints no ficheiro monolítico.
    -   **(P3) Decidir o futuro do módulo de Comissões:** O utilizador pediu para que fosse um módulo, mas a conversa foi interrompida. É preciso clarificar se a página de comissões deve ser acessível apenas com um módulo pago específico.

**Completed work in this session**
-   **Correção de Bug na Importação CSV:** O problema era de dados de teste inválidos, não de código. A funcionalidade foi validada e está a funcionar.
-   **Implementação da Página Meu Plano:** Página criada e API corrigida para calcular e exibir os custos corretamente.
-   **Implementação da Loja de Planos e Módulos:** UI criada para exibir planos e módulos disponíveis para compra/upgrade.
-   **Consolidação de Menus:** As páginas de configuração foram unificadas na página  e o menu de navegação foi simplificado.
-   **Integração Completa da API da Bolt:**
    -   Implementado o fluxo de autenticação OAuth2.
    -   Corrigidos problemas de bloqueio do Cloudflare e erros 403.
    -   Validadas e guardadas as credenciais reais do utilizador.
    -   Implementados endpoints para sincronizar empresas, motoristas, veículos e viagens.
-   **Melhoria da Lógica de Sincronização:**
    -   A sincronização agora associa motoristas e veículos da Bolt a registos locais com base em telefone/matrícula.
    -   Cria registos de ganhos na coleção .
    -   A UI foi atualizada para escolher o método de sincronização (API Oficial).
    -   Foram adicionados botões de atalho para sincronização na página de Resumo Semanal.

**Known issue recurrence from previous fork**
-   **Issue recurrence in previous fork:** Refatoração do Backend ( monolítico).
-   **Recurrence count:** 19
-   **Status:** IN PROGRESS

**Code Architecture**


**Key Technical Concepts**
-   **OAuth2 Client Credentials Flow:** Usado para autenticação com a Bolt API.
-   **Tratamento de Proteções de API:** Foi necessário adicionar um  para contornar a proteção anti-bot do Cloudflare na API da Bolt.
-   **Arquitetura de Serviços Modulares:** A lógica da Bolt API foi encapsulada em , que é chamado pelo  e pelas rotas, promovendo a reutilização de código.
-   **Associação de Dados (Data Matching):** A sincronização associa dinamicamente registos externos (da Bolt) com registos internos (no MongoDB da aplicação) usando identificadores comuns (telefone, email, matrícula).
-   **Pipelines de Agregação (MongoDB):** Usadas extensivamente no endpoint de relatórios para calcular os resumos semanais, embora necessitem de depuração.

**key DB schema**
-   ****: Armazena ,  e o  temporário para a API da Bolt.
-   ****: O campo  foi adicionado e é preenchido para ligar o motorista local ao seu ID na Bolt.
-   ****: Coleção onde são criados os registos de ganhos após cada sincronização. Contém , , , , e totais de ganhos.
-   ****: O documento de configuração para a sincronização agora suporta  para a fonte  e tem um campo  para .

**All files of reference**
-   : Contém a lógica de execução da sincronização que precisa de verificação.
-   : Contém a pipeline de agregação do resumo semanal que precisa ser depurada.
-   : Serviço que interage com a API da Bolt.
-   : Página onde o resultado final deve ser visível.

**Critical Info for New Agent**
-   A sua prioridade máxima é dupla:
    1.  **Corrigir o Resumo Semanal:** Os valores da Bolt sincronizados não estão a aparecer. A falha está provavelmente na pipeline de agregação do MongoDB em . Esta é a parte mais crítica, pois afeta diretamente a visibilidade dos dados para o utilizador.
    2.  **Validar a Segurança da Sincronização:** Testar exaustivamente a correção feita em  para garantir que a associação de motoristas é segura e nunca move dados entre parceiros ou cria registos indesejados.
-   As credenciais da API da Bolt para o parceiro de teste () estão guardadas e a funcionar. Pode usar os endpoints de sincronização diretamente.

**documents and test reports created in this job**
-    (atualizado extensivamente)

**Last 10 User Messages and any pending HUMAN messages**
1.  **User:**  - Reporta os dois bugs principais: a sincronização não deve criar/mover motoristas e os valores não aparecem no resumo. **(In Progress)**
2.  **User:**  - Confirma que os motoristas da nova conta Bolt devem ser associados ao parceiro Zeny. **(Done)**
3.  **User:** Confirma que a nova conta Bolt pertence ao parceiro Zeny e pergunta por que os motoristas não estão a ser associados. **(In Progress)**
4.  **User:**  - Fornece as credenciais corrigidas da Bolt API. **(Done)**
5.  **User:**  - Fornece as novas credenciais da Bolt API (com um erro de digitação). **(In Progress)**
6.  **User:** Pede para verificar por que as novas credenciais da Bolt não estão a funcionar. **(In Progress)**
7.  **Agent:** Finaliza a implementação da associação de dados na sincronização e pergunta ao utilizador se deseja continuar.
8.  **User:** Fornece a documentação da API da Bolt. **(Done)**
9.  **Agent:** Pergunta se as credenciais da Bolt estão corretas, pois a conexão está a falhar.
10. **User:**  - Fornece as primeiras credenciais reais da API Bolt. **(Done)**

**Project Health Check:**
-   **Broken:**
    -   A funcionalidade de Resumo Semanal está quebrada, pois não exibe os dados sincronizados da Bolt.
-   **Mocked:**
    -   Integrações com Ifthenpay e Moloni.
    -   A lógica de sincronização para GPS e Combustíveis não foi implementada, apenas os botões na UI.

**3rd Party Integrations**
-   **Bolt API (Official):** Ativa, a funcionar com OAuth2.
-   **WhatsApp Cloud API (Meta):** Ativa.
-   **Playwright:** Ativa (usada para a sincronização RPA da Uber).
-   **Ifthenpay:** Planeada.
-   **Moloni:** Planeada.

**Testing status**
-   **Testing agent used after significant changes:** NO
-   **Test files created:** Nenhum.
-   **Known regressions:** A funcionalidade de resumo semanal, que antes funcionava com dados manuais, agora não mostra os dados sincronizados da Bolt.

**Credentials to test flow:**
-   **Admin:**  / 
-   **Parceiro de teste (Zeny):**  / 
-   As credenciais da API da Bolt para este parceiro já estão guardadas na base de dados.

**What agent forgot to execute**
-   A lógica de backend para a configuração de atraso em semanas para a sincronização da Via Verde não foi implementada, apenas a UI.
-   O requisito de permitir que um admin programe extrações simuladas de CSV não foi abordado.</analysis>
