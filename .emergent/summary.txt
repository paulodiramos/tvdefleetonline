<analysis>**original_problem_statement:**
O utilizador iniciou a sessão com um conjunto de objetivos de refatoração e implementação de funcionalidades. Durante a sessão, o foco mudou para a correção de uma série de bugs críticos e a melhoria do sistema de importação de dados, culminando num novo pedido de funcionalidade:

1.  **Correção de Bugs Críticos (Agora Resolvidos):**
    *   O relatório de ROI do veículo não funcionava com filtros de datas.
    *   Ganhos da Uber e Bolt, bem como despesas (Via Verde, combustível, elétrico) e KMs de GPS não apareciam nos relatórios dos motoristas.
2.  **Melhorias na Importação de Dados (Agora Implementadas):**
    *   Garantir que os ganhos líquidos, portagens e gorjetas dos CSVs da Uber e Bolt são corretamente mapeados e importados.
    *   Associar os dados importados ao motorista correto usando os seus IDs de plataforma (UUIDs).
    *   Ao importar dados para uma semana que já tem um relatório em rascunho, o sistema deve **atualizar** o rascunho existente em vez de criar um novo.
    *   Prevenir a criação de registos duplicados no banco de dados ao reimportar o mesmo ficheiro.
3.  **Melhoria de UI (Agora Implementada):**
    *   Exibir um resumo financeiro (ganhos, despesas, total) na lista principal de motoristas.
4.  **Novo Pedido de Funcionalidade:**
    *   Implementar a importação de despesas da **Via Verde** a partir de um ficheiro Excel (). O sistema deve associar as despesas ao veículo através do ID do OBU, somar os valores e detalhar as transações no relatório final em PDF.

**User's preferred language**: Portuguese (português)

**what currently exists?**
A aplicação é um sistema de gestão de frotas (React + FastAPI + MongoDB). O agente atual resolveu com sucesso uma longa lista de bugs e implementou várias melhorias críticas no sistema de importação de dados. As principais funcionalidades e correções incluem:
-   **Seletores de Semana:** Adicionados seletores de semana/ano às páginas de importação de GPS, combustível e carregamentos elétricos, uniformizando a UI.
-   **Histórico de Atribuições Melhorado:** A página de detalhes do motorista agora exibe um histórico de atribuições mais completo, com detalhes do veículo e do contrato.
-   **Correções no Relatório do Motorista:** O relatório semanal do motorista agora agrega corretamente os ganhos da Uber/Bolt e as despesas de múltiplas fontes de dados (combustível, eletricidade, GPS).
-   **Sistema de Importação Robusto:** A lógica de importação de CSVs da Uber e Bolt foi completamente revista. Agora, o sistema:
    *   Mapeia corretamente todos os campos financeiros (ganhos, gorjetas, portagens).
    *   Associa os dados ao motorista usando os seus IDs únicos da plataforma.
    *   Previne a criação de duplicados através de uma lógica update or create (upsert).
    *   Atualiza relatórios rascunho existentes, permitindo a importação incremental de dados de várias fontes para a mesma semana.
-   **Melhoria na UI da Lista de Motoristas:** A página principal de motoristas agora exibe um resumo financeiro do relatório mais recente para cada motorista, oferecendo uma visão geral rápida da performance.

**Last working item**:
-   **Last item agent was working:** O agente acabou de receber um novo pedido de funcionalidade do utilizador: implementar a importação de despesas da **Via Verde** a partir de um ficheiro Excel. O agente analisou o ficheiro  fornecido para compreender a sua estrutura.
-   **Status:** NOT STARTED
-   **Agent Testing Done:** N/A
-   **Which testing method agent to use?** backend testing agent. O agente deverá:
    1.  Testar o novo endpoint de importação da Via Verde com um ficheiro de teste.
    2.  Verificar se os dados são corretamente guardados numa nova coleção (ex: ).
    3.  Validar que a geração do relatório semanal do motorista inclui corretamente o total das despesas da Via Verde.
    4.  (Numa fase posterior) Validar que o relatório em PDF inclui a lista detalhada das transações.
-   **User Testing Done:** N

**All Pending/In progress Issue list**:
-   **Issue 1: Implementar Importação de Despesas Via Verde a partir de Excel (P0)**
-   **Issue 2: Refatoração do Backend Incompleta (P1)**
-   **Issue 3: Lógica de Automação RPA Não Implementada (P2)**

Issues Detail:
-   **Issue 1: Implementar Importação de Despesas Via Verde a partir de Excel (P0)**
    -   **Attempted fixes:** Nenhuma. É um novo requisito.
    -   **Next debug checklist:**
        1.  Identificar e modificar a função  no ficheiro  para processar o formato do novo ficheiro .
        2.  Para cada linha do Excel, usar o valor da coluna  para encontrar o veículo correspondente na coleção .
        3.  Após encontrar o veículo, identificar o motorista que lhe estava atribuído na data da transação.
        4.  Guardar cada transação (linha do Excel) numa coleção dedicada, por exemplo , incluindo todos os detalhes relevantes (matrícula, serviço, data, local, valor).
        5.  Modificar a lógica de geração de relatórios em  para consultar esta nova coleção e somar os valores no campo  do relatório semanal.
    -   **Why fix this issue and what will be achieved with the fix?** Automatizar a importação de um tipo de despesa fundamental para a frota, completando o ciclo de automação de custos.
    -   **Status:** NOT STARTED
    -   **Is recurring issue?** N
    -   **Should Test frontend/backend/both after fix?** backend

-   **Issue 2: Refatoração do Backend Incompleta (P1)**
    -   **Attempted fixes:** O agente anterior moveu com sucesso vários endpoints para routers modulares, mas  continua a ser um monólito.
    -   **Next debug checklist:** Continuar a migrar grupos lógicos de endpoints (ex: , , ou a lógica de importação) de  para os seus próprios ficheiros de rota ou serviços.
    -   **Why fix this issue and what will be achieved with the fix?** Melhorar a manutenibilidade, escalabilidade e organização do código backend.
    -   **Status:** IN PROGRESS
    -   **Is recurring issue?** Y
    -   **Should Test frontend/backend/both after fix?** backend

-   **Issue 3: Lógica de Automação RPA Não Implementada (P2)**
    -   **Attempted fixes:** Nenhuma. A UI existe mas o backend não está implementado.
    -   **Next debug checklist:** Implementar a função  em  usando Playwright para executar as automações definidas.
    -   **Why fix this issue and what will be achieved with the fix?** Tornar a funcionalidade de automação RPA, que já tem UI, efetivamente operacional.
    -   **Status:** NOT STARTED
    -   **Is recurring issue?** N
    -   **Should Test frontend/backend/both after fix?** backend

**In progress Task List**:
-   None

**Upcoming and Future Tasks**
-   **Upcoming Tasks:**
    -   (P0) **Issue 1**: Implementar importação de despesas Via Verde a partir de Excel.
    -   (P1) **Issue 2**: Continuar a refatoração do backend.
-   **Future Tasks:**
    -   (P2) **Issue 3**: Implementar o motor de execução RPA.
    -   (P3) Modificar a geração do PDF do relatório semanal para incluir a lista detalhada das transações da Via Verde.
    -   (P4) Criar um editor visual para os passos de automação RPA.
    -   (P5) Expandir o sistema RPA para suportar novos fornecedores.

**Completed work in this session**
-   **Correção de Bugs de Relatórios:**
    -   Resolvido o bug do cálculo de ROI na ficha do veículo com a adição de um filtro de datas personalizado (Entre Datas).
    -   Corrigida a lógica de geração de relatórios () para agregar corretamente os ganhos da Uber/Bolt e despesas de combustível, eletricidade e KMs de GPS, consultando múltiplas coleções.
-   **Melhoria da Importação de Dados (Uber/Bolt):**
    -   Refinada a lógica de importação em  para mapear corretamente todos os campos financeiros (ganhos líquidos, gorjetas, portagens).
    -   Assegurada a associação correta dos dados ao motorista através dos seus UUIDs de plataforma.
    -   Implementada uma lógica de update or create para **prevenir a criação de registos duplicados** em reimportações.
    -   Implementada a **atualização de relatórios rascunho existentes**, permitindo a importação faseada de dados de diferentes plataformas para a mesma semana.
    -   Realizada uma limpeza completa de dados duplicados existentes nas coleções  e .
-   **Melhorias de UI:**
    -   Adicionada a funcionalidade de seletores de semana/ano a todas as páginas de importação.
    -   Melhorada a vista de histórico de atribuições na página do motorista.
    -   Adicionado um resumo financeiro (Ganhos, Despesas, Líquido) ao card de cada motorista na página principal .

**Earlier issues found/mentioned but not fixed**
-   None.

**Known issue recurrence from previous fork**
-   None.

**Code Architecture**


**Key Technical Concepts**
-   **Lógica de Upsert (Update or Create):** O agente implementou uma lógica crucial em  para a importação de dados. Antes de inserir um novo registo da Uber/Bolt, o sistema verifica se já existe um para o mesmo motorista, semana e ano. Se existir, atualiza-o; caso contrário, cria um novo. Isto previne a duplicação de dados.
-   **Atualização de Relatórios Rascunho:** A função  foi modificada para, em vez de ignorar, encontrar e **atualizar** um relatório rascunho existente quando novos dados da mesma semana são importados, permitindo uma consolidação de dados de múltiplas fontes.
-   **Agregação de Dados de Múltiplas Coleções:** A lógica de geração de relatórios em  foi corrigida para fazer queries a várias coleções (, , , etc.) e somar os totais corretamente.
-   **Frontend Dinâmico:** A página  agora faz uma chamada a um novo endpoint () para obter e exibir dinamicamente os totais financeiros mais recentes para cada motorista.

**key DB schema**
-   ** / **: Coleções que agora armazenam os dados de ganhos de forma única (sem duplicados), com campos detalhados como  e .
-   ****: O schema foi enriquecido com campos para , , , . A lógica de atualização desta coleção agora soma corretamente os valores de importações incrementais.
-   ****: Contém os campos  e , que são essenciais para a associação automática de dados durante a importação.

**changes in tech stack**
-   Nenhuma.

**All files of reference**
-   **/app/backend/server.py**: Ficheiro central para toda a lógica de importação, que foi significativamente refatorado para garantir a integridade dos dados.
-   **/app/backend/routes/relatorios.py**: Ficheiro principal para a geração de relatórios, corrigido para agregar dados corretamente e enriquecido com um novo endpoint de resumo.
-   **/app/frontend/src/pages/Motoristas.js**: Página principal de motoristas, agora com resumos financeiros por motorista.
-   **/app/frontend/src/pages/FichaVeiculo.js**: Página de detalhes do veículo, onde o relatório financeiro foi corrigido.
-   **, , **: Ficheiros de exemplo fornecidos pelo utilizador, cruciais para o desenvolvimento.

**Areas that need refactoring**:
-   ****: A lógica de importação, apesar de funcional, é complexa e está toda dentro de . Extrair esta lógica para um módulo de serviço () seria o próximo passo ideal na refatoração.
-   ****: Continua a ser um componente muito grande e complexo, necessitando de ser dividido em subcomponentes.

**key api endpoints**
-   : Lógica de backend em  foi fortemente modificada para incluir de-duplicação e atualização de rascunhos.
-   : Novo endpoint em  que fornece os dados para os resumos financeiros na lista de motoristas.
-   : Lógica em  foi corrigida para agregar dados de múltiplas coleções.

**Critical Info for New Agent**
-   **Prioridade Máxima:** A tarefa mais importante é implementar a importação de despesas da Via Verde a partir do ficheiro Excel, conforme o último pedido do utilizador.
-   **Integridade dos Dados é Chave:** O agente anterior dedicou muito esforço a corrigir problemas de duplicação e agregação de dados. A lógica de upsert implementada na importação da Uber/Bolt em  é um padrão a seguir para a nova importação da Via Verde para evitar problemas semelhantes.
-   **Nome da Base de Dados:** Para qualquer operação manual ou de verificação na base de dados, é crucial usar o nome correto da DB, que é ****, obtido da variável de ambiente .

**documents and test reports created in this job**
-    (atualizado consistentemente)
-   Artefactos de utilizador: , , 

**Last 10 User Messages and any pending HUMAN messages**
1.  **User ():** Aponta que os ganhos não aparecem na lista de motoristas.
2.  **Agent:** Implementa a funcionalidade, adicionando um resumo financeiro a cada motorista na lista.
3.  **User ():** Pede para configurar a importação da Via Verde a partir de um ficheiro Excel, detalhando os requisitos. (PENDING)
4.  **User ():** Aponta que a correção dos duplicados deve aplicar-se a todos os motoristas, não apenas a um.
5.  **Agent:** Executa uma limpeza completa dos dados duplicados para todos os motoristas e valida que os totais estão corretos.
6.  **User ():** Reporta que os valores de ganhos do motorista estão incorretos e muito altos.
7.  **Agent:** Investiga e descobre que o problema são registos duplicados de múltiplas importações, implementando uma lógica para prevenir duplicados.
8.  **User ():** Pede para melhorar a importação da Uber/Bolt, detalhando todas as colunas a serem mapeadas.
9.  **Agent:** Implementa o mapeamento detalhado para Uber e Bolt, incluindo gorjetas e portagens.
10. **User ():** Pede que, ao importar um ficheiro, o sistema atualize um relatório rascunho existente em vez de criar um novo.
11. **Agent:** Implementa com sucesso a lógica de atualização de relatórios rascunho.

**Project Health Check:**
-   **Broken:** Nenhuma funcionalidade crítica está quebrada.
-   **Mocked:** O serviço de execução de automação RPA () permanece como um placeholder.

**3rd Party Integrations**
-   **Playwright:** Instalado para automação RPA (execução pendente).
-   **Cryptography:** Usado para encriptação de credenciais.
-   **pandas / openpyxl / xlrd:** Usados para ler ficheiros CSV e Excel durante a importação.

**Testing status**
-   **Testing agent used after significant changes:** YES. O agente usou o testing agent de forma consistente e com sucesso para validar todas as correções e novas funcionalidades.
-   **Troubleshoot agent used after agent stuck in loop:** NO
-   **Test files created:** None
-   **Known regressions:** None

**Credentials to test flow:**
-   **Admin:**  / 
-   **Parceiro:**  / 

**What agent forgot to execute**
-   O agente não se esqueceu de nada. Concluiu uma longa e complexa série de correções e melhorias solicitadas pelo utilizador e está pronto para iniciar o próximo grande requisito.</analysis>
