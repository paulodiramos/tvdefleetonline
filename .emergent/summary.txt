<analysis>**original_problem_statement:**
O utilizador solicitou uma vasta gama de novas funcionalidades e melhorias para o sistema de gestão de frotas TVDEFleet.

**REQUISITOS DO PRODUTO (Baseado nas últimas mensagens do utilizador):**
1.  **Integrações:**
    *   Implementar integração com **Moloni** para faturação automática.
        *   No perfil do motorista, deve haver uma opção para ativar a auto-faturação, que acarreta um custo extra mensal associado ao plano.
        *   A integração Moloni também deve ser usada pelo webapp para cobrar os planos de subscrição.
    *   Implementar integração com o serviço de armazenamento em nuvem **Terabox**.
    *   Avançar com as integrações de **Email** e **WhatsApp** para notificações e envio de relatórios.
    *   Avançar com a integração de **Pagamentos**.

2.  **Funcionalidades de Vistorias de Veículos:**
    *   Criar um sistema para agendar e realizar vistorias de veículos.
    *   Permitir o upload de fotos durante a vistoria.
    *   Converter o relatório da vistoria (com fotos) para um PDF.
    *   Permitir o download do PDF da vistoria.
    *   O histórico de vistorias deve ficar associado ao veículo.
    *   O agendamento pode ser periódico ou manual (por Parceiro ou Gestor).

3.  **Melhorias na UI/UX e Estrutura:**
    *   No menu Contratos, criar um submenu com Lista de Contratos e Criar Contrato. O item de menu Mensagens Contratos deve ser movido para dentro de Parceiros > Contratos.
    *   No painel de controlo, a página Pendentes está a apresentar um erro Erro ao carregar documentos pendentes.
    *   Nos ecrãs Financeiro e Pagamentos, para além da data, deve ser exibido o **número da semana**.
    *   O plano ativo do motorista deve ser visível na lista de utilizadores e nos detalhes, tal como já acontece com os parceiros.
    *   O tipo de contrato (na criação) deve assumir automaticamente as condições do veículo (comissão ou aluguer). A alteração destas condições pré-definidas deve ser possível (para parceiro, gestor, admin) através de um visto de confirmação com um pop-up.
    *   Adicionar no footer links para Termos e Condições e Política de Privacidade, que abrem um pop-up com texto configurável na área de administração.
    *   Remover completamente a role Operacional de todos os select/dropdowns e lógica da aplicação.

**User's preferred language**: Portuguese (português)

**what currently exists?**
O agente implementou um grande volume de funcionalidades e correções. As duas tarefas prioritárias da sessão anterior (correção da eliminação de planos e exibição do plano do utilizador) foram concluídas com sucesso. O backend foi modificado para desagregar o plano do utilizador antes de o eliminar, e o frontend foi corrigido para usar o URL de API correto. A lista de utilizadores agora exibe o nome do plano atribuído.

Foram implementadas as bases de um novo e complexo sistema de upload de documentos para o registo de motoristas e parceiros, incluindo novos endpoints no backend e campos de upload nos formulários de registo. Foi criada uma nova página Pendentes para administradores aprovarem esses documentos.

Adicionalmente, foram feitas várias melhorias de UI, como a reorganização do menu de administração, a adição de um rodapé com links para termos de privacidade e a implementação de um fluxo de criação de contratos mais inteligente, que pré-preenche as condições com base no veículo selecionado. Foi também criado um endpoint de backend para gerar relatórios complexos em PDF usando .

**Last working item**:
-   Last item agent was working: O agente estava a iniciar a implementação das várias integrações solicitadas pelo utilizador (Moloni, Terabox, Email, WhatsApp). Começou por planear a estrutura e criar um resumo para confirmar o plano com o utilizador antes de avançar com a implementação do backend da integração Moloni.
-   Status: NOT STARTED
-   Agent Testing Done: N
-   Which testing method agent to use? both
-   User Testing Done: N

**All Pending/In progress Issue list**:
-   Issue 1: A página Pendentes falha ao carregar dados (P0)
-   Issue 2: A role Operacional continua a aparecer em vários locais da UI (P1)
-   Issue 3: O plano atribuído ao Motorista não é visível na UI (P2)

**Issues Detail**:
-   Issue 1: **A página Pendentes falha ao carregar dados (P0)**
    -   Attempted fixes: O agente identificou que a rota  não estava a ser registada porque o código foi adicionado em  *depois* da linha . O agente moveu o bloco de código dos endpoints de documentos para a posição correta (antes do ) e reiniciou o backend. Um teste com  confirmou que o endpoint passou a responder com  e uma lista vazia. **No entanto, a página frontend nunca foi testada após a correção do backend.**
    -   Next debug checklist:
        1.  Navegar para a página  no frontend e verificar a consola do browser para ver se o erro Erro ao carregar documentos pendentes persiste.
        2.  Se persistir, verificar a chamada de rede para  para garantir que está a ser feita corretamente.
        3.  Implementar a lógica na página  para renderizar os dados recebidos do endpoint.
    -   Why fix this issue and what will be achieved with the fix?: É uma funcionalidade central para o novo processo de aprovação de utilizadores.
    -   Status: IN PROGRESS
    -   Is recurring issue? Y
    -   Should Test frontend/backend/both after fix? Frontend
    -   Blocked on other issue: None

-   Issue 2: **A role Operacional continua a aparecer em vários locais da UI (P1)**
    -   Attempted fixes: O agente removeu a opção Operacional de alguns dropdowns em  e removeu lógica relacionada em . No entanto, o utilizador reportou novamente a sua presença, indicando que a remoção não foi completa.
    -   Next debug checklist:
        1.  Executar um  global por operacional em todo o diretório .
        2.  Remover sistematicamente todas as ocorrências em componentes, lógica de permissões e texto estático.
    -   Why fix this issue and what will be achieved with the fix?: Completa a refatoração de roles iniciada na sessão anterior e elimina a confusão para o utilizador.
    -   Status: IN PROGRESS
    -   Is recurring issue? Y
    -   Should Test frontend/backend/both after fix? Frontend
    -   Blocked on other issue: None

-   Issue 3: **O plano atribuído ao Motorista não é visível na UI (P2)**
    -   Attempted fixes: O agente investigou com  e descobriu que o problema não era de código, mas sim de dados. O utilizador motorista de teste simplesmente não tinha um  atribuído no banco de dados. O agente atribuiu um plano manualmente via API e confirmou que o backend passou a retornar o nome do plano.
    -   Next debug checklist: Esta não é uma questão de código. O sistema funciona. A solução é garantir que os motoristas tenham planos atribuídos (o que será feito com a funcionalidade de atribuição de plano base gratuito após aprovação de documentos).
    -   Why fix this issue and what will be achieved with the fix?: Fornece consistência visual e informação importante ao admin.
    -   Status: RESOLVED (Funcionalidade está correta, era um problema de dados de teste).
    -   Is recurring issue? N
    -   Should Test frontend/backend/both after fix? None
    -   Blocked on other issue: None

**In progress Task List**:
-   Task 1: Implementação das Integrações (Moloni, Terabox, etc.) (P0)

**Task Detail**:
-   Task 1: **Implementação das Integrações (Moloni, Terabox, etc.) (P0)**
    -   Where to resume: O agente criou um plano geral para as integrações. O próximo passo é implementar o backend para a integração Moloni, começando pelos endpoints para guardar as API keys e a lógica para a auto-faturação.
    -   What will be achieved with this?: Permitirá a faturação automática de planos e serviços, e o armazenamento de ficheiros em cloud.
    -   Status: NOT STARTED
    -   Should Test frontend/backend/both after fix? Both
    -   Blocked on something: Nenhum.

**Upcoming and Future Tasks**
*   **Upcoming Tasks:**
    *   (P0) Criar sistema de vistorias de veículos com upload de fotos e geração de PDF.
    *   (P1) Implementar frontend da página Pendentes para listar, visualizar e aprovar/rejeitar documentos.
    *   (P1) Implementar o envio de notificações por Email e WhatsApp.
    *   (P2) Implementar frontend da página Lista de Contratos.
    *   (P2) Na aprovação de um novo utilizador, atribuir automaticamente o plano base gratuito.
*   **Future Tasks:**
    *   (P2) Implementar a interface de criação de relatórios no frontend, utilizando o endpoint de PDF já criado.
    *   (P3) Implementar a configuração de textos para Termos e Condições e Política de Privacidade na área de admin.

**Completed work in this session**
-   **Resolução de Issues Críticas:**
    -   Corrigida a funcionalidade de **eliminação de planos**, que agora remove o plano de todos os utilizadores associados antes da eliminação.
    -   Implementada a **exibição do plano atribuído** na lista e detalhes de utilizadores.
-   **Novas Funcionalidades:**
    -   **Sistema de Documentos (Backend):** Criados endpoints para upload de documentos, listagem de pendentes e aprovação/rejeição.
    -   **Sistema de Documentos (Frontend):** Atualizados os formulários de registo de Motorista e Parceiro para incluir campos de upload de múltiplos ficheiros.
    -   **Sistema de Contratos Melhorado:** O formulário de criação de contrato agora deteta o tipo de contrato do veículo e bloqueia/permite a edição de condições com um modal de confirmação.
    aniais.**
    -   **Sistema de Relatórios (Backend):** Criado um endpoint robusto () que gera um PDF complexo com .
-   **Melhorias de UI/UX:**
    -   Menus de navegação (principal e de admin) foram extensivamente reorganizados e reestruturados múltiplas vezes de acordo com o feedback do utilizador.
    -   Adicionado o número da semana aos ecrãs de pagamentos.
    -   Adicionado um rodapé global com modais para Termos e Condições e Política de Privacidade, com conteúdo dinâmico do backend.
    -   Removidas múltiplas referências à role Operacional.

**Earlier issues found/mentioned but not fixed**
-   **Incomplete Operacional Role Removal**: O agente removeu a role de vários locais, mas o utilizador continua a encontrá-la. Uma verificação global e remoção sistemática são necessárias.

**Known issue recurrence from previous fork**
-   None.

**Code Architecture**


**Key Technical Concepts**
-   **FastAPI Route Registration:** Um erro crítico foi causado pela adição de rotas em  *após* a inclusão do router (). A ordem é fundamental.
-   **Backend PDF Generation:** Foi utilizada a biblioteca  para criar um endpoint que gera dinamicamente um PDF complexo a partir de dados JSON.
-   **MongoDB Aggregation:** O endpoint  foi melhorado com um pipeline de agregação () para juntar a coleção  e obter o nome do plano.
-   **Frontend State Management:** Lógica complexa de estado foi implementada em  para gerir o bloqueio de campos, a visibilidade de avisos e o fluxo de confirmação do utilizador.
-   **Iterative UI Development:** O agente demonstrou capacidade de se adaptar a pedidos frequentes e contraditórios de alteração da UI, especialmente no .

**key DB schema**
-   **users** (collection): Implicitamente atualizada para suportar um array de documentos () e um status geral de aprovação ().
-   **configuracoes** (collection): Nova coleção para armazenar textos configuráveis, como .

**changes in tech stack**
-   **reportlab**: Adicionada como dependência (implícita) para a geração de PDFs no backend.

**All files of reference**
-   **Criados**:
    -   
    -   
    -   
    -   
    -   
    -    (posteriormente abandonada)
-   **Atualizados/Refatorados**:
    -   : Principal ficheiro modificado, com múltiplos novos endpoints e lógica de negócio.
    -   : Ficheiro com mais edições, refletindo os constantes pedidos de reorganização do menu.
    -   : Implementou a nova lógica de contratos inteligentes.
    -   , : Adicionados os campos de upload.
    -   : Adicionadas e removidas rotas para suportar as novas páginas.
    -   : Adicionado o badge do plano.

**Areas that need refactoring**:
-   ** Monolith**: O ficheiro continua a crescer e a acumular responsabilidades (autenticação, utilizadores, planos, documentos, relatórios PDF, configurações). A separação da lógica em routers/módulos distintos é cada vez mais necessária.

**key api endpoints**
-   : Agora remove o  dos utilizadores antes de apagar o plano.
-   : Agora inclui o  através de um .
-   : Novo endpoint para fazer upload de ficheiros.
-   : Novo endpoint para listar utilizadores com documentos pendentes.
-   : Novo endpoint para aprovar/rejeitar documentos.
-   : Novo endpoint para buscar textos de configuração (termos, etc.).
-   : Novo endpoint que recebe dados e retorna um relatório em PDF.

**Critical Info for New Agent**
-   **Atenção à Ordem das Rotas no FastAPI**: Ao adicionar novos endpoints em , certifique-se de que o código está posicionado **antes** da linha . O agente anterior perdeu tempo a depurar um erro de Not Found por causa disto.
-   **Problemas de Feature não funciona podem ser Problemas de Dados**: Antes de assumir que uma funcionalidade está quebrada (ex: plano do motorista não aparece), verifique com  se os dados de teste no banco de dados estão corretos. O sistema pode estar a funcionar como esperado.
-   **O Utilizador Muda de Ideias Frequentemente (UI)**: Esteja preparado para fazer e refazer alterações na UI, especialmente na navegação (). Confirme sempre o layout final com um screenshot.
-   **Refatoração Incompleta**: A role Operacional ainda existe em partes do código. É necessário um esforço concertado para a remover completamente e evitar que o utilizador a reporte novamente.

**documents created in this job**
-   None.

**Last 10 User Messages and any pending user messages**
1.  **User**: Avançar com integração de email/WhatsApp e pagamentos, e remover menu duplicado Contratos. - **Status**: PARCIALMENTE COMPLETO (menu duplicado removido, integrações planeadas mas não implementadas).
2.  **User**: Implementar sistema de vistorias de veículos e reorganizar menu Contratos. - **Status**: PARCIALMENTE COMPLETO (menu reorganizado, vistorias planeadas mas não implementadas).
3.  **User**: Ativar auto-faturação Moloni no perfil do motorista e usar Moloni para cobrar planos. Integrar com Terabox. - **Status**: PENDENTE.
4.  **User**: Reorganizar menu principal. Corrigir visibilidade do plano do motorista. Iniciar integração Moloni. - **Status**: PARCIALMENTE COMPLETO (Menu reorganizado, visibilidade do plano diagnosticada, Moloni iniciada).
5.  **User**: Reverter menu Relatórios para um submenu e remover links do topo. - **Status**: COMPLETO.
6.  **User**: Remover links duplicados do menu de relatórios. - **Status**: COMPLETO.
7.  **User**: Criar menu Relatórios com sub-itens e implementar backend para PDF. - **Status**: COMPLETO.
8.  **User**: Implementar sistema de contratos melhorado (baseado no veículo). - **Status**: COMPLETO.
9.  **User**: Adicionar número da semana aos pagamentos e footer com links para Termos/Privacidade. Corrigir visibilidade do plano do motorista. - **Status**: PARCIALMENTE COMPLETO (Semana e footer feitos, visibilidade do plano por corrigir).
10. **User**: Remover Operacional, corrigir erro em Pendentes, melhorar contratos e pagamentos, adicionar footer. - **Status**: PENDENTE (Esta é a lista de tarefas atual).

**Project Health Check:**
-   **Broken**: A página  muito provavelmente ainda exibe um erro no frontend, pois a correção do backend nunca foi validada na UI. A remoção da role Operacional está incompleta.
-   **Mocked**: As páginas , ,  são placeholders sem funcionalidade real.

**3rd Party Integrations**
-   **ReportLab**: Utilizada no backend para geração de PDFs.
-   **Moloni**: Solicitada para faturação. Planeada, mas não implementada.
-   **Terabox**: Solicitada para armazenamento de ficheiros. Planeada, mas não implementada.
-   **WhatsApp**: Solicitada para notificações. Planeada, mas não implementada.

**Testing status**
-   **Testing agent used after significant changes**: NO
-   **Troubleshoot agent used after agent stuck in loop**: NO
-   **Test files created**: None.
-   **Known regressions**: A página Pendentes foi criada mas nunca funcionou. A remoção da role Operacional é uma regressão de refatoração, pois não foi concluída.

**Credentials to test flow:**
-   Disponíveis em .

**What agent forgot to execute**
-   O agente corrigiu o endpoint  no backend, mas **esqueceu-se de testar se a página  no frontend passou a funcionar** após a correção.
-   O agente não realizou uma busca e substituição global pela role operacional, deixando várias ocorrências no código.
-   As implementações das páginas ,  e  ficaram como placeholders.
-   A implementação do frontend da página  para listar e interagir com os documentos nunca foi feita.</analysis>
