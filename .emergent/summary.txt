<analysis>**original_problem_statement:**
O utilizador iniciou com um pedido para um **Sistema de Integrações Configurável**, que evoluiu para um sistema de gestão de frotas completo. Os requisitos mais recentes, incluindo os do último pedido do utilizador, são:

-   **Sistema de Recibos e Faturação por Entidade:** Concluído. Permite que parceiros definam múltiplas Empresas de Faturação e emitam recibos em nome delas.
-   **Dashboard de Faturação:** Concluído. Exibe os totais faturados por cada entidade anualmente.
-   **Gestão de Acessos e Permissões:**
    -   Refinar a visibilidade nos dashboards (parceiro vs. gestor vs. admin).
    -   Permitir eliminação de utilizadores e motoristas pelo admin.
    -   Permitir que parceiros aprovem motoristas.
    -   Permitir que o admin atribua/altere o parceiro de um motorista.
-   **Melhorias na Gestão de Veículos:**
    -   Corrigir exibição de fotos de veículos (Concluído).
    -   Melhorar anúncios com carrossel de fotos (Concluído).
    -   Implementar gestão de quilometragem (km\_inicial, atualizações manuais) (Concluído).
-   **Histórico e Relatórios:**
    -   Filtrar resumo semanal por motoristas ativos na semana selecionada (Concluído).
    -   Implementar histórico de atividade e rendimentos para cada motorista (Concluído).
-   **Preços Especiais:** Implementar UI para o admin definir um preço específico para um parceiro/gestor (Concluído).
-   **Sistema de Backup:** Interface para o admin realizar e descarregar backups (Concluído).

**Novos Requisitos do Utilizador (da última mensagem):**
1.  Na ficha do cliente (motorista), mostrar os valores dos recibos associados a cada empresa de faturação.
2.  No dashboard de faturação, mostrar o valor acumulado anual do motorista associado a cada empresa (em percentagem).
3.  Garantir que todos os menus das categorias principais estejam sempre visíveis no menu superior.
4.  Ajustar a lista de utilizadores no perfil de admin para ser mais compacta (conforme imagem em anexo que não foi processada), mostrando ícones para ações, apenas um nome de parceiro, etc.
5.  Clarificar onde se podem definir os preços especiais para um parceiro/gestor de forma simples e com data de validade.

**User's preferred language**: Portuguese (Portugal)

**what currently exists?**
A aplicação full-stack (FastAPI, React, MongoDB) está funcional no ambiente de desenvolvimento. O agente anterior implementou com sucesso várias funcionalidades-chave, incluindo um sistema completo de Empresas de Faturação (backend e frontend), um dashboard de faturação anual com gráficos, o histórico de atividade e rendimentos do motorista, a gestão de quilometragem de veículos, e uma interface para o admin gerir preços especiais. Foram também corrigidos vários bugs e feitos ajustes de UX.

**Last working item**:
-   Last item agent was working: O agente recebeu um novo conjunto de requisitos de UI/UX do utilizador e estava prestes a começar a análise, verificando as imagens em anexo (que não foram processadas com sucesso) para entender os ajustes pretendidos na lista de utilizadores do perfil de administrador.
-   Status: NOT STARTED
-   Agent Testing Done: N
-   Which testing method agent to use? frontend testing agent
-   User Testing Done: N

**All Pending/In progress Issue list**:
-   Issue 1: Implementar novos ajustes de UI/UX e funcionalidades (P0)
-   Issue 2: A base de dados de produção () está desatualizada (P0 - Bloqueador Crítico)
-   Issue 3: Fragilidade da extração de dados RPA Prio Elétrico (P2)
-   Issue 4: A sessão da Prio expira após cada sincronização (P2)

**Issues Detail:**
-   **Issue 1: Implementar novos ajustes de UI/UX e funcionalidades (P0)**
    -   **Description:** O utilizador solicitou um conjunto de alterações e novas funcionalidades na sua última mensagem, focadas em melhorar a visualização de dados e a usabilidade da interface de administração.
        -   1. Mostrar valores de recibos por empresa na ficha do motorista.
        -   2. Mostrar valor acumulado anual por motorista no dashboard de faturação.
        -   3. Garantir visibilidade permanente dos menus principais.
        -   4. Compactar a lista de utilizadores na página de administração.
        -   5. Clarificar/Simplificar a UI de gestão de Preços Especiais.
    -   **Attempted fixes:** Nenhum.
    -   **Next debug checklist:**
        1.  Analisar novamente as imagens anexadas pelo utilizador (se disponíveis no próximo fork) para entender o requisito de compactação da lista de utilizadores.
        2.  Rever  para adicionar os valores dos recibos.
        3.  Rever  e o endpoint de backend correspondente para incluir os dados por motorista.
        4.  Rever  para garantir a visibilidade dos menus.
        5.  Rever  para implementar a UI compacta.
        6.  Rever  para melhorar a clareza.
    -   **Why fix this issue and what will be achieved with the fix?** Atende a um pedido direto do utilizador para melhorar a densidade da informação e a usabilidade geral da aplicação.
    -   **Status:** NOT STARTED
    -   **Is recurring issue?** N
    -   **Should Test frontend/backend/both after fix?** Both.
    -   **Blocked on other issue:** Não.

-   **Issue 2: A base de dados de produção () está desatualizada (P0 - Bloqueador Crítico)**
    -   **Description:** O ambiente de produção não reflete o código nem os dados do ambiente de desenvolvimento, causando bugs críticos que impedem o utilizador de usar a aplicação.
    -   **Attempted fixes:** O agente anterior diagnosticou o problema e instruiu o utilizador a usar a funcionalidade Deploy com a opção **Use new database**.
    -   **Next debug checklist:** A resolução depende da ação do utilizador. O próximo agente deve reforçar esta instrução e confirmar se o deploy foi efetuado.
    -   **Why fix this issue and what will be achieved with the fix?** Sincronizará a produção com o desenvolvimento, tornando a aplicação funcional para o utilizador e resolvendo múltiplos bugs.
    -   **Status:** BLOCKED
    -   **Is recurring issue?** Y
    -   **Should Test frontend/backend/both after fix?** Both.
    -   **Blocked on other issue:** Não.

-   **Issue 3: Fragilidade da extração de dados RPA Prio Elétrico (P2)**
    -   **Description:** A automação Playwright para este fornecedor é instável.
    -   **Status:** NOT STARTED
    -   **Is recurring issue?** Y

-   **Issue 4: A sessão da Prio expira após cada sincronização (P2)**
    -   **Description:** A sessão de login na plataforma Prio não persiste, exigindo re-autenticação.
    -   **Status:** NOT STARTED
    -   **Is recurring issue?** Y

**In progress Task List**:
Nenhuma. As tarefas anteriores foram concluídas e as novas (do Issue 1) ainda não foram iniciadas.

**Upcoming and Future Tasks**
*   **Upcoming Tasks:**
    *   (P2) Implementar integração com WhatsApp.
*   **Future Tasks:**
    *   Refatorar God Components como .
    -   Implementar funcionalidades de Alertas Avançados e Comissões Avançadas.
    -   Criar um sistema para arquivar dados antigos da base de dados.

**Completed work in this session**
-   **Sistema de Empresas de Faturação**: Implementação completa do backend (rotas, modelos) e frontend (página de gestão e integração no fluxo de upload de recibos).
-   **Dashboard de Faturação Anual**: Criada uma nova página () com gráficos (recharts) e tabelas para analisar as receitas anuais por empresa.
-   **Histórico do Motorista**: Criados endpoints de backend e uma nova tab na Ficha do Motorista para exibir o histórico de atividade (ativo/inativo) e o histórico de rendimentos semanais.
-   **Filtro do Resumo Semanal**: A lógica do backend foi melhorada para filtrar e mostrar apenas os motoristas que estiveram ativos durante o período da semana selecionada.
-   **Gestão de KM de Veículos**: Criado um componente () e um endpoint de backend para visualizar o histórico de quilometragem e permitir atualizações.
-   **UI de Preços Especiais**: Criada uma nova página () para o administrador gerir os preços especiais para parceiros.
-   **Correções de Bugs e UX**: Resolvidos múltiplos bugs de serialização, caminhos de importação e lógica, com a ajuda do . O menu de navegação foi ajustado para melhor visibilidade.

**Earlier issues found/mentioned but not fixed**
-   **Issue 1: Fragilidade da extração de dados RPA Prio Elétrico**
-   **Issue 2: Sessão da Prio expira após cada sincronização**

**Known issue recurrence from previous fork**
-   **Issue recurrence in previous fork:** Problemas com a automação da Prio.
-   **Recurrence count:** Múltiplas vezes.
-   **Status:** NOT STARTED

**Code Architecture**


**Key Technical Concepts**
-   **Backend:** FastAPI, Pydantic, MongoDB
-   **Frontend:** React, Shadcn UI, Lucide React, **Recharts**
-   **Deployment:** Plataforma Emergent
-   **Database:** Serialização de BSON ()

**key DB schema**
-   **historico\_atividade\_motoristas:** Utilizada para guardar o histórico de alterações de estado (ativo, inativo, bloqueado).
-   **veiculos_km:** Utilizada para guardar o histórico de atualizações de quilometragem.
-   **recibos:** O endpoint de upload foi modificado para aceitar .

**All files of reference**
-   **Created:**
    -   : UI para parceiros gerirem as suas empresas de faturação.
    -   : UI do dashboard de faturação anual.
    -   : UI para o admin gerir preços especiais.
    -   : Componente reutilizável para gerir a quilometragem de um veículo.
-   **Updated:**
    -   : Adicionados endpoints para histórico de atividade/rendimentos e lógica para registar alterações de estado.
    -   : Atualizado endpoint de upload de recibo para associar a uma empresa de faturação.
    -   : Adicionado endpoint para obter o histórico de KM.
    -   : Adicionadas as rotas para as novas páginas.
    -   : Adicionados os links de menu para as novas páginas.
    -   : Adicionado seletor de empresa de faturação no diálogo de upload de recibo.
    -   : Adicionada a nova tab Histórico.
    -   : Integrado o novo componente .
    -   : Atualizado com as funcionalidades concluídas.

**Areas that need refactoring**:
-   O componente  continua muito grande, apesar da extração do componente de gestão de KM. Pode ser dividido ainda mais.
-   A página  provavelmente precisará de refatoração para atender ao novo requisito de uma UI mais compacta.

**key api endpoints**
-   : Atualizado para aceitar .
-   : Obtém o histórico de alterações de estado de um motorista.
-   : Obtém o histórico de rendimentos semanais de um motorista.
-   : Obtém o histórico de atualizações de KM de um veículo.
-   Endpoints CRUD para .
-   Endpoints CRUD para .

**Critical Info for New Agent**
-   **Prioridade Máxima:** A prioridade absoluta é o último pedido do utilizador (), que define um novo conjunto de tarefas de UI/UX. Comece por aí. Tente obter as imagens em anexo para entender o requisito de design para a página de utilizadores.
-   **Bloqueador de Produção:** O problema de dessincronização da base de dados de produção ainda está pendente de uma ação do utilizador (Deploy com Use new database). Lembre o utilizador disto, pois é a causa de muitos problemas que ele pode experienciar no ambiente live.
-   **Testing Agent é Eficaz:** O agente anterior usou o  com muito sucesso, que corrigiu vários bugs críticos de frontend (paths de API, variáveis indefinidas). Confie e utilize este subagente após implementar as novas funcionalidades.

**documents and test reports created in this job**
-    (Atualizado)
-   
-   
-   

**Last 10 User Messages and any pending HUMAN messages**
1.  **** (Message 254): Utilizador aprova o plano para implementar a Gestão de KM e os Preços Especiais. (CONCLUÍDO)
2.  **** (Message 339): **Pedido de alta prioridade com múltiplos novos requisitos de UI/UX**, incluindo ajustes no dashboard de faturação, ficha do cliente e página de utilizadores do admin. (PENDENTE)

**Project Health Check:**
-   **Broken:** O ambiente de produção () permanece instável e dessincronizado. A resolução está bloqueada, aguardando uma ação de deploy por parte do utilizador.

**3rd Party Integrations**
-   **Playwright:** Usado para automações RPA (ex: Prio).
-   **Recharts:** Usado para os gráficos no Dashboard de Faturação.

**Testing status**
-   **Testing agent used after significant changes:** YES (usado 3 vezes com sucesso)
-   **Troubleshoot agent used after agent stuck in loop:** NO
-   **Test files created:** None
-   **Known regressions:** A automação da Prio continua a ser frágil.

**Credentials to test flow:**
-   **App Admin User:**  / 
-   **App Partner User (Zeny):**  / 

**What agent forgot to execute**
-   O agente não teve tempo de implementar os novos requisitos da última mensagem do utilizador.
-   As questões de longa data sobre a automação RPA (Prio) não foram abordadas.</analysis>
