<analysis>**original_problem_statement:**
O utilizador iniciou a sessão para continuar o desenvolvimento do sistema de gestão de frotas TVDEFleet. O objetivo era continuar a partir do último trabalho, que era a criação de uma nova página de gestão de planos. No entanto, ao longo da sessão, o utilizador reportou uma avalanche de bugs, regressões e novos pedidos de funcionalidades, abrangendo quase todas as partes da aplicação.

Os principais pedidos e problemas incluem:
1.  **Bugs Críticos e Regressões:**
    *   Erro no dashboard após o login.
    *   Páginas de perfil do parceiro e do motorista com erros, em branco ou a não carregar dados.
    *   Página de ganhos do motorista em branco.
    *   Várias páginas de administração (Integrações, Comunicações, Termos e Privacidade) com links quebrados ou em branco.
    *   A atribuição de planos não funciona ou gera erros.
    *   A criação/edição de planos não guarda os valores de preço introduzidos.
    *   As notificações não funcionavam corretamente.

2.  **Novas Funcionalidades e Melhorias de UX:**
    *   Unificar o sistema de gestão de contratos, permitindo que parceiros/gestores criem os seus próprios tipos de contrato e editem templates.
    *   Implementar um modal de criação de templates de contrato com base numa imagem fornecida.
    *   Melhorar a página de gestão de planos com filtros para utilizadores ativos (parceiros/motoristas) e mostrar o valor do plano ao atribuir.
    *   Implementar um sistema de promoções temporais (com data de início e fim) para os planos.
    *   Permitir que um parceiro compre um plano com desconto para um dos seus motoristas.
    *   Tornar os campos nas páginas de Termos e Privacidade editáveis pelo admin.
    *   Ajustar o tamanho das pop-ups de notificação.
    *   Garantir que a alteração de um plano tem sempre um custo associado.

**User's preferred language**: Portuguese (português)

**what currently exists?**
O agente realizou uma extensa sessão de debugging e implementação, corrigindo inúmeros problemas e adicionando novas funcionalidades.

*   **Correções de Backend:** O agente diagnosticou e corrigiu um bug de routing crítico e recorrente no FastAPI, onde rotas com parâmetros (ex: ) capturavam rotas estáticas (ex: ). A solução foi reordenar as definições de rotas em . Também foram corrigidos endpoints duplicados para a gestão de planos ( e ) que impediam o armazenamento correto dos preços. A lógica de atribuição de planos foi melhorada para suportar tanto planos legados (com ) como novos (com ). A lógica de obtenção de perfis foi corrigida para consultar múltiplas coleções ( e ), resolvendo inconsistências arquiteturais.

*   **Correções de Frontend:** Foram corrigidas múltiplas rotas quebradas no  (ex: Ganhos do Motorista) e foram adicionados redirects para URLs incorretas reportadas pelo utilizador. O sistema antigo de atribuição de planos na página  foi removido e substituído por um redirecionamento para a página de gestão centralizada.

*   **Novas Funcionalidades (Implementadas):**
    *   Foi criado um novo modal para a criação de templates de contrato, conforme a imagem fornecida pelo utilizador, e integrado no menu .
    *   As páginas de Termos e Privacidade foram tornadas editáveis no frontend com suporte de backend.
    *   As notificações foram melhoradas para permitir edição inline e alternar entre o estado de lido/não lido.
    *   A página de Gestão de Planos foi melhorada com filtros funcionais para tipo de utilizador (parceiro/motorista).
    *   Foi implementada a base no backend para um sistema de promoções e para a revenda de planos de parceiros para motoristas.

**Last working item**:
-   Last item agent was working: O agente estava a investigar um erro que ocorria no dashboard () imediatamente após o login do utilizador. O agente confirmou que os endpoints públicos e de estatísticas que o dashboard consome estavam a funcionar, sugerindo que o problema estava na lógica do componente frontend .
-   Status: IN PROGRESS
-   Agent Testing Done: N
-   Which testing method agent to use? Frontend testing agent. A próxima tarefa é fazer login como admin e navegar para  para reproduzir o erro de forma consistente. O agente de teste deve capturar os logs da consola do browser e as respostas de rede para identificar qual componente ou chamada de API está a falhar.
-   User Testing Done: N

**All Pending/In progress Issue list**:
-   Issue 1: (P0) Erro na página  após o login.
-   Issue 2: (P1) A funcionalidade de guardar e atualizar os preços dos planos ainda é reportada como defeituosa pelo utilizador, apesar da correção dos endpoints duplicados.
-   Issue 3: (P1) A funcionalidade de atribuir um plano a um utilizador ainda é reportada como defeituosa.
-   Issue 4: (P2) O perfil do parceiro () foi reportado novamente com erros de carregamento, mesmo após correções.
-   Issue 5: (P3) O ficheiro  continua a ser um monólito, o que causa bugs recorrentes de routing e duplicação de código.

Issues Detail:
-   Issue 1:
    -   Attempted fixes: O agente verificou que os endpoints da API (, ) que alimentam o dashboard estão a funcionar corretamente via .
    -   Next debug checklist:
        1.  Usar o  para fazer login e navegar para .
        2.  Analisar os logs da consola do browser e o  para identificar JavaScript errors ou chamadas de API falhadas no cliente.
        3.  Inspecionar o ficheiro , especificamente os  hooks e a renderização condicional, para encontrar a causa do erro.
    -   Why fix this issue and what will be achieved with the fix? O dashboard é a primeira página após o login, e um erro aqui impede o uso de toda a aplicação.
    -   Status: IN PROGRESS
    -   Is recurring issue? Y
    -   Should Test frontend/backend/both after fix? Frontend
    -   Blocked on other issue: None

-   Issue 2:
    -   Attempted fixes: O agente encontrou e removeu endpoints  e  duplicados em  no ficheiro , que era a causa mais provável do problema.
    -   Next debug checklist:
        1.  Fazer um teste ponta-a-ponta: criar um novo plano com preços na UI de , guardar, recarregar a página e verificar se os preços persistem.
        2.  Editar um plano existente, alterar os preços, guardar e verificar novamente.
        3.  Se falhar, inspecionar a payload enviada no  e os logs do backend ao chamar  e .
    -   Why fix this issue and what will be achieved with the fix? A gestão de planos é uma funcionalidade central e não funciona sem preços.
    -   Status: USER VERIFICATION PENDING
    -   Is recurring issue? Y
    -   Should Test frontend/backend/both after fix? Both
    -   Blocked on other issue: None

-   Issue 3:
    -   Attempted fixes: O agente verificou que o endpoint  funciona via . A UI em  foi revista.
    -   Next debug checklist:
        1.  Na UI, na aba Atribuir Planos, selecionar um utilizador e um plano e clicar em Atribuir.
        2.  Verificar a chamada de API no  e a resposta.
        3.  Se houver um erro, adicionar  na função  em  para inspecionar os IDs e a payload antes do envio.
    -   Why fix this issue and what will be achieved with the fix? A atribuição de planos é a ação principal da página de gestão de planos.
    -   Status: USER VERIFICATION PENDING
    -   Is recurring issue? Y
    -   Should Test frontend/backend/both after fix? Frontend
    -   Blocked on other issue: None

-   Issue 4:
    -   Attempted fixes: O agente corrigiu o endpoint  para procurar o utilizador tanto na coleção  como na coleção .
    -   Next debug checklist:
        1.  Fazer login como parceiro de teste ().
        2.  Navegar para a página de perfil.
        3.  Inspecionar os logs da consola e as chamadas de API no  para ver que dados estão a falhar o carregamento. O ficheiro a verificar é .
    -   Why fix this issue and what will be achieved with the fix? O perfil é uma página essencial para o utilizador parceiro.
    -   Status: USER VERIFICATION PENDING
    -   Is recurring issue? Y
    -   Should Test frontend/backend/both after fix? Frontend
    -   Blocked on other issue: None

-   Issue 5:
    -   Attempted fixes: Nenhuma refatoração estrutural foi feita. O agente corrigiu bugs causados pelo monólito (endpoints duplicados, ordem de rotas).
    -   Next debug checklist: Planear a refatoração. Mover rotas relacionadas com  de  para um novo ficheiro  usando .
    -   Why fix this issue and what will be achieved with the fix? Reduzir a complexidade, eliminar bugs recorrentes e melhorar a manutenibilidade do backend.
    -   Status: NOT STARTED
    -   Is recurring issue? Y
    -   Should Test frontend/backend/both after fix? Both
    -   Blocked on other issue: None

**In progress Task List**:
-   Task 1: Depurar e corrigir o erro no Dashboard.
    -   Where to resume: Investigar o componente .
    -   What will be achieved with this? Permitir o acesso e uso da aplicação após o login.
    -   Status: IN PROGRESS
    -   Should Test frontend/backend/both after fix? Frontend
    -   Blocked on something: Este é o principal bloqueador.

**Upcoming and Future Tasks**
*   **Upcoming Tasks:**
    *   (P1) **Gestão de Contratos do Parceiro**: Permitir que o parceiro crie os seus próprios tipos de contrato e veja uma lista dos seus templates e contratos ativos.
    *   (P2) **Implementar Custo na Alteração de Plano**: Garantir que a lógica de negócio para cobrar uma taxa ao alterar um plano seja implementada.
    *   (P2) **Finalizar UI para Promoções**: A UI para criar promoções com data de início/fim na página de Gestão de Planos precisa ser implementada.
    *   (P2) **Finalizar UI para Revenda de Planos**: Criar a UI para que um parceiro possa comprar e atribuir um plano a um dos seus motoristas.
*   **Future Tasks:**
    *   (P2) **Refatorar **: Decompor o monólito em múltiplos routers.
    *   (P3) **Implementar Relatório de Faturação Mensal para Parceiros**.
    *   (P3) **Teste Ponta-a-Ponta da Faturação Moloni**.

**Completed work in this session**
-   **Correção Crítica de Routing (Backend)**: Resolvido o conflito de rotas no FastAPI movendo rotas estáticas (ex: ) para antes de rotas com parâmetros () em .
-   **Correção de Endpoints Duplicados**: Removidos endpoints  e  duplicados para , que impediam que os preços fossem guardados.
-   **Correção de Inconsistência de Dados**: Atualizados vários endpoints para consultar tanto a coleção  como as coleções /, corrigindo múltiplos bugs de Not Found.
-   **Funcionalidade de Edição de Conteúdo**: As páginas de  e  foram transformadas em conteúdo dinâmico e editável pelo admin, com suporte de frontend e backend.
-   **Melhoria das Notificações**: As notificações agora podem ser editadas inline, e o seu estado (lido/não lido) pode ser alternado. O pop-up foi alargado para 1000px.
-   **Implementação de Modal de Contratos**: Criado e integrado um novo modal para Criar Template de Contrato, com variáveis dinâmicas, conforme a imagem do utilizador.
-   **Correção de Rotas (Frontend)**: Adicionadas rotas em falta (ex: ) e redirects para URLs incorretas em .
-   **Melhoria da Gestão de Planos**: Adicionados filtros funcionais por tipo de utilizador (parceiro/motorista) na página .
-   **Refatoração da UI**: Removida a tab Templates da página de contratos para admin/gestor.

**Code Architecture**


**Key Technical Concepts**
-   **FastAPI Route Order Precedence**: A sessão demonstrou repetidamente que a ordem de definição das rotas em  é crítica. Rotas estáticas (e.g., ) devem ser declaradas ANTES de rotas com parâmetros (e.g., ) para evitar que a rota com parâmetro capture a chamada incorretamente.
-   **Architectural Inconsistency (Dual User Collections)**: A aplicação sofre de uma inconsistência onde a autenticação está na coleção , mas os dados operacionais estão em coleções separadas (, ). Isto exigiu correções em múltiplos endpoints para que consultassem ambas as fontes de dados para encontrar o utilizador correto.
-   **State Management in Complex Components**: Componentes como  e  gerem um estado complexo (múltiplos formulários, modais, dados de API, filtros), tornando-os frágeis e difíceis de depurar.

**All files of reference**
-   **Criados**:
    -   
    -   
    -   
-   **Atualizados/Refatorados (principais)**:
    -   : Múltiplas correções críticas de routing e lógica.
    -   : Múltiplas correções de rotas e adição de redirects.
    -   : Integração de novo modal e ajustes nos menus.
    -   : Adição de filtros e melhorias na UI.
    -   : Transformado em componente com conteúdo editável.
    -   : Funcionalidade de edição adicionada.

**Areas that need refactoring**:
-   **CRÍTICO - **: A necessidade de refatorar este ficheiro para uma arquitetura de múltiplos routers é a principal prioridade técnica para evitar a recorrência de bugs.
-   ****: Este ficheiro tornou-se excessivamente grande e complexo. A lógica de gestão de planos, atribuição e o formulário de edição deveriam ser divididos em componentes mais pequenos.
-   ****: Este ficheiro contém a lógica de menus para múltiplos perfis, modais e estado, tornando-o difícil de manter. A lógica dos menus deveria ser extraída.

**key api endpoints**
-   **Corrigidos (principais):**
    -    e : Corrigidos através da reordenação de rotas.
    -    e : Corrigidos removendo definições duplicadas.
    -   : Corrigido para consultar a coleção  também.
-   **Novos:**
    -   
    -   
    -   
    -   
    -   

**Critical Info for New Agent**
-   **Atenção ao Routing do Backend**: A causa raiz de muitos bugs Not Found ou Not Authorized foi a ordem das rotas no . Sempre que adicionar uma rota estática (ex: ), verifique se ela está definida ANTES de qualquer rota com parâmetro (ex: ).
-   **Inconsistência de Dados do Utilizador**: Lembre-se que os dados do utilizador estão divididos entre a coleção  (para auth) e as coleções / (para dados operacionais). Qualquer consulta a um utilizador pode exigir a verificação em ambas as fontes.
-   **O utilizador reporta bugs em série**: Espere um fluxo contínuo de feedback. Agrupe os problemas por prioridade e tente resolver os bloqueadores críticos primeiro. Comunique claramente o seu plano de ação.
-   **A Refatoração do  é urgente**: Muitos dos problemas que surgiram nesta sessão são sintomas de um backend monolítico. Priorize a sua refatoração para garantir a estabilidade do projeto a longo prazo.

**Last 10 User Messages and any pending user messages**
1.  **User**: Reportou erro no dashboard após o login. - **Status**: IN PROGRESS.
2.  **User**: Reportou que o perfil do parceiro dá erro, pediu para editar notificações, criar tipos de contrato personalizados e que a alteração de plano tenha custo. - **Status**: PARCIALMENTE COMPLETO (Perfil corrigido, notificações editáveis, resto pendente).
3.  **User**: Reportou erro ESLint no . - **Status**: RESOLVIDO.
4.  **User**: Pediu para remover a tab Templates dos contratos, tornar Termos/Privacidade editáveis e reportou que os planos não guardam valores. - **Status**: PARCIALMENTE COMPLETO (Tab removida, Termos editável, bug dos planos pendente de verificação).
5.  **User**: Reportou que a atribuição de planos falha, links de admin estão quebrados e gestão de planos não funciona bem. - **Status**: PARCIALMENTE COMPLETO (Links corrigidos com redirects, resto pendente de verificação).
6.  **User**: Pediu filtros na lista de contratos, que notificações sejam editáveis, reportou que os ganhos do motorista estão em branco e a gestão de planos tem problemas. - **Status**: PARCIALMENTE COMPLETO (Filtros de contrato e correção de ganhos implementados, resto pendente).
7.  **User**: Reportou vários problemas: Ganhos do motorista em branco, perfil do parceiro incorreto, gestão de planos com valores em falta, pediu promoções nos planos, e um sistema de revenda de planos. - **Status**: PARCIALMENTE COMPLETO.
8.  **User**: Confirmou plano de ação (opcao a). - **Status**: COMPLETO.
9.  **User**: Confirmou plano de ação (fase 1 e fase 2 avanacar). - **Status**: COMPLETO.
10. **User**: Reportou uma longa lista de bugs: atribuição de planos antiga, páginas de admin em branco, notificações com largura errada, contratos duplicados, página de documentos do motorista em branco,  do motorista não funciona. - **Status**: PARCIALMENTE COMPLETO.

**Project Health Check:**
-   **Broken**:
    -   A página  falha ao carregar após o login.
    -   As funcionalidades de guardar preços e atribuir planos () são repetidamente reportadas como defeituosas pelo utilizador.
    -   A estabilidade da página de perfil do parceiro () é incerta.
-   **Mocked**:
    -   As integrações com Moloni e Google Drive permanecem por implementar/testar.
    -   A funcionalidade de promoções e revenda de planos tem apenas a base do backend; a UI está por fazer.

**Testing status**
-   Testing agent used after significant changes: NO
-   Troubleshoot agent used after agent stuck in loop: NO
-   Test files created: []
-   Known regressions: A funcionalidade de guardar preços dos planos e a estabilidade do perfil do parceiro são regressões conhecidas e recorrentes. A aplicação inteira parece instável, com novas regressões a aparecer a cada nova funcionalidade.

**Credentials to test flow:**
-   Disponíveis em .

**What agent forgot to execute**
O agente não esqueceu, mas foi constantemente forçado a adiar tarefas de fundo (como a refatoração do  e relatórios de faturação) para lidar com a avalanche de bugs críticos e regressões reportadas pelo utilizador. O agente também não utilizou o testing agent, o que poderia ter ajudado a apanhar regressões mais cedo.</analysis>
