<analysis>**original_problem_statement:**
O utilizador iniciou com a tarefa de adicionar campos de ID para Uber e Bolt, mas a sessão evoluiu para uma série de desenvolvimentos e correções de bugs, incluindo:
1.  Implementação de um sistema de crédito/débito para portagens (Via Verde Acumulado).
2.  Criação de um sistema de Despesas/Créditos Extras com UI na ficha do motorista.
3.  Reformulação da página de Credenciais de Plataformas.
4.  Múltiplas correções e refinamentos na lógica de importação de CSV/Excel (Uber, Via Verde, Combustível, Elétricos), especificando quais colunas usar para os cálculos.
5.  Implementação de uma lógica complexa para o cálculo do aluguer do veículo, considerando épocas alta e baixa.
6.  Melhorias nos relatórios PDF para incluir mais detalhes e separar data e hora.
7.  Correção de uma série de bugs interligados nos cálculos de totais do resumo semanal e do relatório PDF, que é o problema atual.

**User's preferred language**: Portuguese (português)

**what currently exists?**
A aplicação é uma ferramenta de gestão de frotas com funcionalidades de importação de dados (Uber, Bolt, Via Verde, combustível, elétricos), gestão de motoristas e veículos, e geração de relatórios financeiros semanais (em UI e PDF). Recentemente, foi adicionada uma UI para gerir despesas extras diretamente na ficha do motorista e uma nova página para gerir credenciais de plataformas. A lógica de cálculo do aluguer foi tornada mais sofisticada para lidar com preços sazonais. O backend foi modificado para separar data e hora durante a importação para facilitar a sua apresentação.

**Last working item**:
-   **Last item agent was working:** Corrigir um conjunto de bugs inter-relacionados no resumo semanal e no relatório PDF, reportados pelo utilizador. Os problemas incluem:
    1.  A coluna Uber Portagens não está editável.
    2.  Valores inseridos na coluna Extras não são refletidos no cálculo do valor líquido final no resumo semanal.
    3.  O valor do aluguer do veículo não aparece (ou está incorreto) no relatório PDF.
    4.  Os totais gerais no relatório PDF estão incorretos.
-   **Status:** IN PROGRESS
-   **Agent Testing Done:** N
-   **Which testing method agent to use?** both
    -   **Backend:** Utilizar  para testar o endpoint de geração do PDF (). **Crítico:** Antes do teste, é necessário garantir que existe um motorista de teste associado a um veículo que tenha um contrato () com valores de aluguer definidos.
    -   **Frontend:** Utilizar a  para testar a página . O teste deve incluir clicar em Editar, inserir valores nos campos Uber Portagens e Extras, e verificar se o campo Líquido é atualizado corretamente em tempo real.
-   **User Testing Done:** N

**All Pending/In progress Issue list**:
-   **Issue 1: Bugs no Resumo Semanal e Relatório PDF (P0)**
    -   **Description:** O utilizador reportou que (1) a coluna Uber Portagens não é editável, (2) a coluna Extras não afeta o total líquido, e (3) o aluguer e os totais estão incorretos no PDF.
    -   **Attempted fixes:** O agente corrigiu o cálculo do líquido no frontend para incluir os extras e corrigiu a query do backend que busca o veículo para o cálculo do aluguer (usando  em vez de ). No entanto, o teste do aluguer falhou por falta de dados de teste (veículo sem contrato), e a edição da coluna Uber Portagens não foi totalmente resolvida.
    -   **Next debug checklist:**
        1.  **Criar/Verificar Dados de Teste:** Garantir que um motorista de teste está associado a um veículo com um  e valores de aluguer configurados.
        2.  **Testar Backend (PDF):** Gerar o PDF para o motorista de teste e verificar se o aluguer e os totais estão corretos.
        3.  **Testar Frontend (Resumo):** Na página do resumo, entrar em modo de edição e confirmar que (a) o campo Uber Portagens é um input editável e (b) inserir um valor em Extras atualiza imediatamente o campo Líquido.
    -   **Why fix this issue and what will be achieved with the fix?** A precisão dos relatórios financeiros é crítica para a funcionalidade principal da aplicação e para a confiança do utilizador.
    -   **Status:** IN PROGRESS
    -   **Is recurring issue?** Y
    -   **Should Test frontend/backend/both after fix?** both

-   **Issue 2: Discrepância de Dados na Via Verde (P1)**
    -   **Description:** O utilizador reportou um valor incorreto no total da Via Verde. Subsequentemente, instruiu o agente a usar a coluna  em vez de  para todos os cálculos, o que foi implementado.
    -   **Next debug checklist:** A correção no código está feita. O agente deve pedir ao utilizador para reimportar o ficheiro da Via Verde para a semana em questão e confirmar se o problema está resolvido.
    -   **Why fix this issue and what will be achieved with the fix?** Garante a precisão dos relatórios financeiros.
    -   **Status:** USER VERIFICATION PENDING
    -   **Is recurring issue?** N
    -   **Should Test frontend/backend/both after fix?** backend

-   **Issue 3: Refatoração do Backend (P2)**
    -   **Description:** Os ficheiros  e  continuam monolíticos, complexos e difíceis de manter.
    -   **Next debug checklist:** Planear e propor ao utilizador a extração da lógica de importação de  para ficheiros de rotas dedicados (ex: ).
    -   **Why fix this issue and what will be achieved with the fix?** Melhorar a manutenibilidade e escalabilidade do código.
    -   **Status:** NOT STARTED
    -   **Is recurring issue?** Y
    -   **Should Test frontend/backend/both after fix?** backend

**In progress Task List**:
-   Nenhuma. As tarefas atuais são classificadas como correções de bugs.

**Upcoming and Future Tasks**
-   **Future Tasks:**
    -   **(P2) Integração com SendGrid:** A funcionalidade de envio de email continua bloqueada, aguardando a API Key do utilizador.
    -   **(P2) UI de Admin para Fornecedores:** Criar uma área de administração para que o utilizador possa configurar a lista de fornecedores de combustível e GPS, em vez de estarem fixos no código.
    -   **(P3) Lógica de Sincronização Automática (RPA):** Tarefa de longo prazo, ainda não iniciada.

**Completed work in this session**
-   **UI para Sistema de Extras:** Implementada uma nova tab Extras/Dívidas na página  para adicionar e visualizar transações manuais.
-   **Nova Página Credenciais Plataformas:** Criada e integrada uma nova página () para gestão de credenciais.
-   **Coluna Uber Portagens:** Adicionada a coluna Uber Portagens à tabela do .
-   **Lógica de Cálculo de Aluguer Sazonal:** Implementada uma função no backend () que calcula o valor do aluguer com base nos meses de época alta/baixa definidos no contrato do veículo.
-   **Correção de Lógica de Importação:** Ajustadas as funções de importação de Via Verde (para usar ), Carregamentos Elétricos (mapeamento de campos) e Uber (para usar as colunas de rendimentos e portagens corretas).
-   **Separação de Data/Hora:** Modificada a importação para guardar data e hora em campos separados (, ) e atualizados os relatórios PDF para os apresentar em colunas distintas.
-   **Campo Contacto de Energia:** Adicionado um novo campo no modelo do motorista e na UI da  para identificar o motorista em importações de carregamentos elétricos.
-   **Unificação da Coleção Extras:** Corrigido um bug crítico ao unificar todo o código para usar a coleção  para transações manuais.

**Earlier issues found/mentioned but not fixed**
-   Nenhum que não esteja já listado.

**Known issue recurrence from previous fork**
-   **Issue recurrence in previous fork:** Refatoração do Backend ( e  estão demasiado grandes).
-   **Recurrence count:** 2
-   **Status:** NOT STARTED

**Code Architecture**


**Key Technical Concepts**
-   **Lógica de Negócio Complexa:** Implementação de regras de negócio específicas, como o cálculo de aluguer sazonal, diretamente na lógica de relatórios do backend.
-   **Consistência do Modelo de Dados:** A resolução de um bug chave passou pela unificação do uso de coleções da base de dados (usar  em todo o lado).
-   **Dependência de Dados de Teste:** A depuração de vários bugs foi dificultada ou bloqueada pela ausência de dados de teste adequados na base de dados (ex: veículo sem contrato para testar o cálculo do aluguer).

**key DB schema**
-   **motoristas:** Adicionado  (string). Campo  (string, ID) é usado para ligar ao veículo.
-   **veiculos:** O campo  (objeto) contém a lógica de aluguer sazonal (, , ).
-   **despesas_extras:** Coleção unificada para transações manuais.
-   **portagens_viaverde, abastecimentos_combustivel, despesas_combustivel:** As coleções de importação agora contêm os campos  e .

**changes in tech stack**
-   Nenhuma.

**All files of reference**
-   : Contém toda a lógica de geração de relatórios (dados para a UI e ficheiros PDF). É central para os bugs atuais.
-   : Contém toda a lógica de importação de dados.
-   : UI principal para o resumo semanal, onde os bugs de cálculo e interatividade são visíveis.
-   : Página de perfil do motorista.
-   : Modelo Pydantic do motorista.

**Areas that need refactoring**:
-   ** (CRÍTICO):** Continua a ser um ficheiro monolítico com toda a lógica de importação.
-   ** (CRÍTICO):** Ficheiro extremamente grande que mistura lógica de negócio, queries à base de dados e geração de PDFs.

**key api endpoints**
-   : Geração do relatório PDF do motorista.
-   : Fornece os dados para a página do resumo semanal do parceiro.
-   : Adiciona uma nova transação de extra a um motorista.

**Critical Info for New Agent**
-   A prioridade máxima é resolver os bugs reportados na última mensagem do utilizador ().
-   **É fundamental criar dados de teste adequados para depurar.** Especificamente, para testar o cálculo do aluguer, tem de garantir que um motorista de teste está ligado a um veículo com um contrato de aluguer totalmente configurado. Sem isso, não conseguirá verificar a correção.
-   O utilizador é muito detalhado sobre as colunas de CSV a usar. A precisão nos cálculos financeiros é a maior prioridade.
-   A coleção  é agora a única fonte de verdade para transações manuais. Não use .

**documents and test reports created in this job**
-    foi atualizado.

**Last 10 User Messages and any pending HUMAN messages**
1.  : Reportou bugs no resumo semanal e PDF (não editável, cálculo incorreto de extras e aluguer). **Status: IN PROGRESS**
2.  : Reportou novamente bugs no PDF com um screenshot. **Status: IN PROGRESS**
3.  : Deu instruções sobre a lógica de importação da Uber e cálculo de aluguer sazonal. **Status: COMPLETED**
4.  : Clarificou a lógica de importação da Uber. **Status: COMPLETED**
5.  : Reportou bugs no PDF sobre aluguer, Bolt e portagens Uber. **Status: COMPLETED**
6.  : Reportou um bug no cálculo da coluna Extra. **Status: COMPLETED**
7.  : Pediu para adicionar a hora nos detalhes da Via Verde. **Status: COMPLETED**
8.  : Pediu para separar data/hora na importação da Via Verde. **Status: COMPLETED**
9.  : Pediu para separar data/hora em todas as importações. **Status: COMPLETED**
10. : Pediu para separar data e hora nos relatórios PDF. **Status: COMPLETED**

**Project Health Check:**
-   **Broken:**
    -   Cálculos e interatividade na página de Resumo Semanal ().
    -   Cálculo de totais no relatório PDF (dependente de dados de teste corretos).
    -   Integração SendGrid (aguarda API Key).
-   **Mocked:**
    -   Lógica de automação RPA.
-   **Needs Refactoring (High Priority):**
    -   
    -   

**3rd Party Integrations**
-   Pillow, ReportLab, openpyxl, Playwright.
-   SendGrid (configurado mas inativo).

**Testing status**
-   **Testing agent used after significant changes:** NO
-   **Troubleshoot agent used after agent stuck in loop:** NO
-   **Test files created:** N/A
-   **Known regressions:** Os cálculos no resumo semanal e no PDF regrediram ou nunca funcionaram corretamente com todas as novas funcionalidades (extras, aluguer sazonal).

**Credentials to test flow:**
-   **Admin:**  / 
-   **Parceiro:**  / 

**What agent forgot to execute**
-   O agente não concluiu a depuração dos bugs reportados pelo utilizador na última mensagem. Embora tenha identificado as causas prováveis (lógica de frontend, queries de backend), não executou um ciclo de teste completo com os dados corretos para verificar as correções. A questão da coluna Uber Portagens não ser editável também não foi totalmente resolvida.</analysis>
