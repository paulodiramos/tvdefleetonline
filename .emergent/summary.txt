<analysis>**original_problem_statement:**
O utilizador iniciou com a tarefa de adicionar campos de ID para Uber e Bolt. Ao longo da sessão, o escopo expandiu-se para incluir:
1.  **Correção de Bugs P1:** Resolver problemas com a edição do resumo semanal, importação de combustível e um erro na importação de elétricos.
2.  **Lógica de Via Verde (Portagens):** Implementar um sistema de acumulação de crédito de Via Verde, onde o valor das portagens, em vez de ser descontado, é adicionado a um saldo. Implementar uma UI para permitir o abate (desconto) desse saldo.
3.  **Alterações na Importação Uber:** Modificar a importação de CSV da Uber para usar a coluna  como ganho principal e somar as colunas  e  num novo campo .
4.  **Sistema de Despesas/Créditos Extras:** Criar um sistema para adicionar transações manuais aos motoristas, como danos, dívidas ou crédito de dias.
5.  **Correção de Bug de Ganhos Bolt:** Os ganhos da Bolt não apareciam no resumo semanal.
6.  **Correção de Bug de Eliminação Bolt:** A eliminação de dados semanais não apagava os ganhos da Bolt.
7.  **Investigação de Dados Via Verde:** Valores de Via Verde no relatório não correspondiam ao esperado pelo utilizador para a semana 1 de 2026.
8.  **Melhoria no PDF:** Adicionar mais detalhes (local, data/hora, duração) às tabelas de Via Verde e Carregamentos Elétricos no relatório PDF semanal do motorista.

**User's preferred language**: Portuguese (português)

**what currently exists?**
A aplicação está funcional, com várias funcionalidades implementadas e bugs corrigidos. O agente implementou a lógica de backend para adicionar mais detalhes ao relatório semanal em PDF do motorista, especificamente adicionando colunas para Local e Data/Hora na tabela de Via Verde, e uma coluna de Tempo na tabela de carregamentos elétricos. O código foi escrito mas ainda não foi testado para confirmar que o PDF é gerado corretamente com as novas colunas.

**Last working item**:
-   Last item agent was working: Adicionar colunas de detalhe (, , ) às tabelas de Via Verde e Carregamentos Elétricos na função de geração de PDF em .
-   Status: IN PROGRESS
-   Agent Testing Done: N
-   Which testing method agent to use? backend testing agent
-   User Testing Done: N

**All Pending/In progress Issue list**:
-   **Issue 1: Discrepância de dados na Via Verde (P1)**
    -   **Description:** O utilizador reportou que os valores de Via Verde para a S1/2026 estão incorretos no relatório (€14.15 em vez de €20.15). A investigação do agente concluiu que a soma dos dados existentes na base de dados para essa semana é de facto €14.15, indicando um problema de dados (registos em falta ou importados incorretamente) e não um bug de cálculo.
    -   **Next debug checklist:**
        1.  Pedir ao utilizador para fornecer o ficheiro de importação original da Via Verde para a S1/2026.
        2.  Analisar o ficheiro para encontrar os registos em falta que somam a diferença de ~€6.
        3.  Verificar se esses registos foram atribuídos ao veículo/motorista correto durante a importação.
        4.  Considerar a limpeza de dados duplicados ou mal classificados de Via Verde de Dezembro 2025 que foram encontrados durante a investigação.
    -   **Why fix this issue and what will be achieved with the fix?** Garantir a precisão dos relatórios financeiros, que é crucial para a confiança do utilizador na plataforma.
    -   **Status:** IN PROGRESS
    -   **Is recurring issue?** N
    -   **Should Test frontend/backend/both after fix?** backend
    -   **Blocked on other issue:** Aguarda ficheiro de dados do utilizador.

-   **Issue 2: Refatoração do Backend (P2)**
    -   **Description:** Os ficheiros  e  continuam excessivamente grandes e complexos, dificultando a manutenção.
    -   **Next debug checklist:** Planear a extração de mais um grupo de endpoints de  (ex: os restantes de importação) para os seus próprios ficheiros de rotas. Planear a divisão de  em funções utilitárias menores.
    -   **Why fix this issue and what will be achieved with the fix?** Melhorar a manutenibilidade, legibilidade e escalabilidade do código do backend.
    -   **Status:** NOT STARTED (nesta sessão)
    -   **Is recurring issue?** Y
    -   **Should Test frontend/backend/both after fix?** backend

**In progress Task List**:
-   **Task 1: Testar Geração do PDF com Novos Detalhes (P0)**
    -   **Where to resume:** O código em  foi modificado. É necessário chamar o endpoint de geração de PDF () e inspecionar o ficheiro PDF resultante.
    -   **What will be achieved with this?** Confirmar que as novas colunas (Local, Data/Hora, Tempo) aparecem corretamente nas tabelas de detalhes do PDF, sem quebrar a formatação.
    -   **Status:** TESTING PENDING
    -   **Should Test frontend/backend/both after fix?** backend
    -   **Blocked on something:** Não

**Upcoming and Future Tasks**
-   **UI para Sistema de Despesas Extras (P1):** O backend () para adicionar danos, dívidas e créditos está pronto. Falta criar a interface no frontend, provavelmente um modal na ficha do motorista ou no resumo semanal, para adicionar e visualizar estas transações.
-   **Refinar Resumo Semanal (P2):** Adicionar o campo Uber Portagens à tabela de resumo no frontend () para corresponder à alteração já feita no backend.
-   **Integração com SendGrid (P2):** A funcionalidade de envio de email continua bloqueada à espera da API Key do utilizador.
-   **Lógica de Sincronização Automática (RPA) (P3):** Tarefa de longo prazo, ainda não iniciada.

**Completed work in this session**
-   **IDs de Plataforma (Uber/Bolt):** Implementada a funcionalidade completa: UI na ficha do motorista, gravação no backend, e atualização da lógica de importação para usar os novos IDs.
-   **Correção de Edição do Resumo Semanal:** Resolvido o bug que impedia os ajustes manuais de serem refletidos corretamente.
-   **Correção de Importação de Combustível:** Corrigida a lógica de agregação em todo o backend para usar a ordem correta de campos (, , ).
-   **Funcionalidade de Via Verde Acumulado:**
    -   Implementada a lógica no backend para acumular o valor das portagens em vez de descontar, quando a opção está ativa para um motorista.
    -   Criada UI no resumo semanal para mostrar o estado de acumulação, o saldo total e um botão para abater o valor.
    -   Implementado o modal de abate e o endpoint de backend correspondente.
-   **Atualização da Importação Uber:** A função  foi reescrita para usar as novas colunas de ganhos () e calcular o novo campo .
-   **Sistema de Despesas/Créditos Extras:** Criado o endpoint de backend para registar transações manuais (danos, dívidas, etc.).
-   **Correção Ganhos Bolt:** Resolvido o bug que impedia os ganhos da Bolt de aparecerem no resumo, ajustando a query para ler de  e corrigindo o  dos dados de teste.
-   **Correção Eliminação Bolt:** Resolvido o bug que impedia a eliminação de ganhos da Bolt, adicionando a coleção  à lógica de delete.

**Code Architecture**


**Key Technical Concepts**
-   **Debugging de Dados vs. Código:** O agente distinguiu com sucesso entre um bug no código (ex: ganhos Bolt não apareciam) e um problema nos dados (ex: discrepância nos valores de Via Verde), focando a solução no local correto.
-   **Coalescência de Fontes de Dados:** Para corrigir os ganhos da Bolt, o agente modificou a query de resumo para agregar dados de duas coleções diferentes ( e ), resolvendo o problema sem migração de dados.
-   **Feature Flagging Simples:** A implementação do Via Verde Acumulado utiliza um campo de configuração no motorista () para alterar dinamicamente o fluxo de cálculo de despesas, funcionando como uma feature flag a nível de utilizador.

**All files of reference**
-   : Contém a lógica de resumo, eliminação e geração de PDF. **Alvo das últimas modificações.**
-   : Contém a lógica de importação de todos os ficheiros CSV/Excel.
-   : Página do frontend para exibir os resumos semanais.
-   : Contém os endpoints para gerir motoristas, incluindo a nova API de transações.
-   : Página para gerir detalhes de um motorista.

**Areas that need refactoring**:
-   ** (CRÍTICO):** Continua monolítico, com toda a lógica de importação de múltiplos formatos num único ficheiro.
-   ** (CRÍTICO):** Ficheiro extremamente grande que mistura queries de agregação, lógica de negócio e geração de PDFs.

**key api endpoints**
-   : Para gerar o relatório semanal do motorista (precisa de ser testado).
-   : (NOVO) Para adicionar débitos/créditos a um motorista.
-   : Para descontar um valor do saldo de Via Verde acumulado.
-   : Endpoint de eliminação de dados semanais.

**Critical Info for New Agent**
-   A tarefa mais imediata é **testar a geração do PDF** para validar as últimas alterações de código. Use o endpoint  e verifique o ficheiro resultante.
-   O problema dos valores da Via Verde () é um **problema de dados, não de código**. Não tente corrigir o cálculo. O próximo passo é obter e analisar os ficheiros de origem do utilizador.
-   Esteja ciente de que existem duas coleções para os dados da Bolt:  e . A lógica atual lê de ambas, e a lógica de eliminação também apaga de ambas.
-   O backend para despesas extras está pronto, mas o frontend não. Este é um bom próximo passo para propor ao utilizador após concluir as correções pendentes.

**Project Health Check:**
-   **Broken:**
    -   Funcionalidade de envio de email via SendGrid (aguarda API Key).
-   **Mocked:**
    -   Lógica de automação (RPA) para sincronização.
-   **Needs Testing:**
    -   Geração do relatório em PDF com as novas colunas de detalhe.
-   **Needs Refactoring (High Priority):**
    -   
    -   

**3rd Party Integrations**
-   Pillow, ReportLab, SendGrid, Playwright, openpyxl, Google Analytics. Nenhuma nova integração foi adicionada.

**Testing status**
-   **Testing agent used after significant changes:** NO
-   **Troubleshoot agent used after agent stuck in loop:** NO
-   **Test files created:** N/A
-   **Known regressions:** Nenhuma regressão foi identificada nesta sessão. Os bugs reportados foram corrigidos.

**Credentials to test flow:**
-   **Admin:**  / 
-   **Parceiro:**  / 

**What agent forgot to execute**
-   O agente escreveu o código para modificar o relatório PDF em  mas não executou um teste para gerar e verificar o PDF resultante. Este é o passo mais crítico a ser executado a seguir.</analysis>
