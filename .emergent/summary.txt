<analysis>**original_problem_statement:**
O utilizador fez um novo pedido detalhado para refinar o sistema de relatórios semanais para o perfil de parceiro.

**Requisitos Principais:**
1.  Criar um sistema de relatórios semanais simples e eficaz no perfil do parceiro.
2.  O sistema deve importar ficheiros das plataformas: Uber, Bolt, Via Verde, combustível (diesel), elétrico e GPS (com KMs efetuados).
3.  Toda a informação deve estar ligada a um motorista e ao seu veículo associado.
4.  O veículo deve ter configurado: o cartão de frota, a Via Verde, e os detalhes do contrato, incluindo **quilómetros semanais contratados** e o **preço por km extra** (que podem ser fixos ou sazonais).
5.  O utilizador forneceu novos ficheiros (, , , , ) e dois exemplos detalhados:
    *   **Nelson:**
        *   Ganhos Uber: €607,54
        *   Ganhos Bolt: €136,74
        *   Veículo: AS-83-NX
        *   Via Verde ID: 601073900511, Gasto: €27,10
        *   Cartão Combustível: 7824731736480002, Gasto: €5,35
        *   Aluguer Semanal: €249,99
    *   **Jorge Macaia:**
        *   Ganhos Uber: €677,00
        *   Ganhos Bolt: €299,61
        *   Veículo: BQ-32-RS
        *   Cartão Elétrico: PTPRIO6087131736480002, Gasto: €135,80
        *   Aluguer Semanal: €249,99
        *   Via Verde Gasto: €42,60

**User's preferred language**: Portuguese (português)

**what currently exists?**
A aplicação possui um sistema de importação de ficheiros bastante robusto. Foram implementados e testados endpoints e interfaces de utilizador para:
1.  **Importação de Ficheiros**: Lógica para processar ficheiros CSV e Excel de Uber, Bolt, Via Verde, carregamentos elétricos e combustível fóssil. A lógica lida com diferentes formatos e particularidades (ex: BOM em CSVs).
2.  **Relatórios Semanais**: Geração de relatórios que consolidam ganhos e despesas por motorista.
3.  **Interfaces de Utilizador (UI)**:
    *   Uma página unificada para o parceiro importar todos os ficheiros ().
    *   Uma página para o administrador configurar o mapeamento de colunas dos ficheiros ().
    *   Uma página para o parceiro gerir credenciais de plataformas para sincronização automática ().
    *   Uma página de resumo semanal que exibe totais e uma tabela detalhada por motorista ().
4.  **Indicação da Semana na Via Verde**: A UI e a API foram atualizadas para mostrar de que semana são os dados da Via Verde.

Todo este trabalho foi concluído antes do utilizador fornecer o novo requisito detalhado, que agora se tornou a prioridade.

**Last working item**:
*   **Last item agent was working:** O agente estava a iniciar o trabalho no novo e detalhado requisito do utilizador. Começou por analisar os 5 novos ficheiros fornecidos (, , , , ) para compreender os dados para os motoristas Nelson e Jorge Macaia.
*   **Status:** IN PROGRESS
*   **Agent Testing Done:** N
*   **Which testing method agent to use?** both
*   **User Testing Done:** N

**All Pending/In progress Issue list**:
-   **Issue 1: Implementar o novo Sistema de Relatórios Semanais (P0)**
-   **Issue 2: Refatoração do Backend Incompleta (P1)**
-   **Issue 3: Implementar a lógica de Sincronização Automática (RPA) (P2)**

Issues Detail:
-   **Issue 1: Implementar o novo Sistema de Relatórios Semanais (P0)**
    -   **Attempted fixes:** O agente iniciou a análise dos novos ficheiros.
    -   **Next debug checklist:**
        1.  Adicionar os novos campos (, ) ao modelo de dados dos veículos ou a um novo modelo de contratos.
        2.  Atualizar a UI de gestão de veículos/contratos para permitir a configuração destes novos campos.
        3.  Localizar o motorista Jorge Macaia e o veículo BQ-32-RS na base de dados. Se não existirem, criá-los.
        4.  Verificar e atualizar os veículos de Nelson (AS-83-NX) e Jorge (BQ-32-RS) com os IDs de cartão (combustível, elétrico) e Via Verde corretos, conforme a nova solicitação.
        5.  Adaptar a lógica de importação e geração de relatórios para usar os novos dados e calcular os totais de acordo com os exemplos fornecidos.
        6.  Garantir que os relatórios exibem todos os dados solicitados de forma simples e eficaz.
    -   **Why fix this issue and what will be achieved with the fix?** Implementar a versão refinada e final da funcionalidade principal de relatórios do parceiro, conforme a especificação mais recente do utilizador.
    -   **Status:** IN PROGRESS
    -   **Is recurring issue?** N
    -   **Should Test frontend/backend/both after fix?** both

-   **Issue 2: Refatoração do Backend Incompleta (P1)**
    -   **Attempted fixes:** Nenhuma nesta sessão. O ficheiro  continua a ser um monólito que contém toda a lógica de importação de ficheiros.
    -   **Next debug checklist:** Criar um novo diretório  e mover a lógica de importação de cada plataforma (Uber, Bolt, etc.) para módulos separados (ex: ).
    -   **Why fix this issue and what will be achieved with the fix?** Melhora a manutenibilidade, escalabilidade e organização do código, facilitando futuras modificações.
    -   **Status:** NOT STARTED
    -   **Is recurring issue?** Y
    -   **Should Test frontend/backend/both after fix?** backend

-   **Issue 3: Implementar a lógica de Sincronização Automática (RPA) (P2)**
    -   **Attempted fixes:** Foi criada uma UI para configurar a sincronização automática (), mas a lógica de backend não foi implementada.
    -   **Next debug checklist:**
        1.  Implementar a lógica no endpoint  para guardar as configurações de frequência e estado da automação.
        2.  Implementar a função  em  para executar as importações automáticas com base nas credenciais e configurações guardadas.
        3.  Garantir que as senhas são devidamente encriptadas e desencriptadas durante o processo.
    -   **Why fix this issue and what will be achieved with the fix?** Habilitar a funcionalidade de importação automática, um requisito chave do utilizador.
    -   **Status:** NOT STARTED
    -   **Is recurring issue?** N
    -   **Should Test frontend/backend/both after fix?** backend

**In progress Task List**:
-   **Task 1: Análise e planeamento da nova solicitação de relatórios**
    -   **Where to resume:** A análise dos ficheiros foi concluída. O próximo passo é definir o plano de implementação para os novos requisitos: adicionar campos de contrato (KMs), atualizar os dados dos motoristas/veículos (Nelson, Jorge), e adaptar a lógica de cálculo dos relatórios.
    -   **What will be achieved with this?** Um plano claro para modificar a aplicação existente para corresponder aos novos requisitos detalhados do utilizador.
    -   **Status:** IN PROGRESS
    -   **Should Test frontend/backend/both after fix?** both
    -   **Blocked on something:** Não

**Upcoming and Future Tasks**
-   **Upcoming Tasks:**
    -   (P1) **Issue 2**: Refatorar o backend para separar a lógica de importação.
    -   (P2) **Issue 3**: Implementar a lógica de backend para a sincronização automática (RPA).
-   **Future Tasks:**
    -   (P3) Modificar a geração do PDF do relatório semanal para incluir a lista detalhada das transações da Via Verde.
    -   (P4) Adicionar notificações para o parceiro sobre o estado da importação (sucesso/erro).
    -   (P5) Criar um editor visual para os passos de automação RPA.

**Completed work in this session**
-   **Sistema de Importação Melhorado (UI/Config) (CONCLUÍDO):**
    -   Criadas UIs para importação unificada, configuração de mapeamento (admin) e gestão de credenciais (parceiro).
-   **Vista Consolidada Resumo Semanal do Parceiro (CONCLUÍDO):**
    -   Criada uma nova página () e API () que exibe um resumo financeiro e uma tabela detalhada de todos os motoristas de um parceiro para uma dada semana.
-   **Indicação da Semana de Referência da Via Verde (CONCLUÍDO):**
    -   O backend foi modificado para retornar a semana de referência dos dados da Via Verde.
    -   O frontend foi atualizado para exibir essa informação () na UI de relatórios.
-   **Importação de Relatórios de Parceiro (v1) (CONCLUÍDO e TESTADO):**
    -   Implementada e validada com  a importação de ficheiros para Uber, Bolt, Via Verde, Elétrico e Combustível para os motoristas Karen e Nelson. Foram corrigidos múltiplos bugs relacionados com a análise de ficheiros (BOM), associação de dados e duplicação de registos.

**Earlier issues found/mentioned but not fixed**
-   Nenhum. Todos os problemas identificados foram resolvidos ou estão listados como pendentes.

**Known issue recurrence from previous fork**
-   **Refatoração do Backend:** A necessidade de refatorar o  monolítico continua a ser adiada em favor de novas funcionalidades.

**Code Architecture**


**Key Technical Concepts**
-   **Processamento de Ficheiros (Pandas):** Essencial para a importação de ficheiros CSV e Excel.
-   **FastAPI Backend:** Criação e modificação de endpoints, gestão de uploads, e lógica de negócio complexa.
-   **MongoDB (motor):** Uso de queries e agregações para consolidar dados de múltiplas coleções (, , , , ).
-   **React Frontend:** Desenvolvimento de novas páginas e componentes, gestão de estado, e integração com a API via .
-   **Gestão de Credenciais:** Introduzido o conceito de armazenamento de credenciais de plataforma, com encriptação como próximo passo.

**key DB schema**
-   ****: Contém , , . Necessita da adição dos campos  e .
-   ** / **: Coleções que armazenam os ganhos por plataforma.
-   ****: Armazena transações da Via Verde.
-   ****: Armazena abastecimentos de combustível fóssil.
-   ****: Armazena carregamentos elétricos.
-   ****: Nova coleção para armazenar credenciais de plataformas por parceiro.
-   ****: Nova coleção para armazenar configurações de mapeamento de importação.
-   ****: O resultado consolidado que agrega todos os dados.

**All files of reference**
-   **/app/backend/server.py**: Modificado extensivamente para nova lógica de importação, correção de bugs e novos endpoints de configuração.
-   **/app/backend/routes/relatorios.py**: Modificado para adicionar a referência da semana da Via Verde e o novo endpoint de resumo semanal.
-   **/app/frontend/src/pages/ResumoSemanalParceiro.js**: Ficheiro novo para a vista de resumo.
-   **/app/frontend/src/pages/ImportarFicheirosParceiro.js**: Ficheiro novo para a UI de importação unificada.
-   **/app/frontend/src/pages/ConfiguracaoMapeamento.js**: Ficheiro novo para a UI de configuração de mapeamento.
-   **/app/frontend/src/pages/CredenciaisPlataformas.js**: Ficheiro novo para a UI de gestão de credenciais.
-   **/app/frontend/src/App.js**: Modificado para adicionar as novas rotas.
-   **/app/frontend/src/components/Layout.js**: Modificado para adicionar os novos links no menu.
-   , , , , : **Novos ficheiros** fornecidos pelo utilizador para o requisito mais recente.
-   **/app/memory/PRD.md**: Atualizado para refletir o trabalho concluído.

**Areas that need refactoring**:
-   ****: A lógica de importação de ficheiros de múltiplas plataformas deve ser extraída para módulos de serviço dedicados para melhorar a organização e manutenibilidade do código.

**key api endpoints**
-   : Endpoint genérico de importação, modificado para suportar múltiplos formatos.
-   : Novo endpoint para a vista consolidada do parceiro.
-   : Modificado para retornar a semana de referência.
-   : Novo endpoint para guardar credenciais.
-   : Novo endpoint para guardar configurações de mapeamento.

**Critical Info for New Agent**
-   **NOVA PRIORIDADE MÁXIMA:** O foco é total no último pedido do utilizador: um sistema de relatórios semanais refinado. Use os novos ficheiros e os exemplos específicos (Nelson, Jorge Macaia) como a fonte da verdade.
-   **REAPROVEITAR CÓDIGO EXISTENTE:** Grande parte da base necessária já foi construída e testada. A tarefa é adaptar e estender o trabalho anterior para incluir os novos requisitos, como os campos de contrato (KMs e preço extra) e a lógica de cálculo específica.
-   **REQUISITOS DE CONTRATO:** Uma parte fundamental da nova tarefa é adicionar os campos quilómetros atribuídos e preço por km extra ao sistema, tanto na base de dados como na UI, e usá-los nos cálculos dos relatórios.
-   **AUTOMAÇÃO (RPA) É O PRÓXIMO PASSO:** Após a conclusão do relatório manual, a implementação da lógica de backend para a sincronização automática () será a próxima prioridade.

**documents and test reports created in this job**
-   /app/test_reports/iteration_2.json
-   /app/memory/PRD.md

**Last 10 User Messages and any pending HUMAN messages**
1.  **User ():** Pede para melhorar o sistema de importação com uma UI unificada para o parceiro, uma tela de configuração de mapeamento para o admin e o armazenamento encriptado de credenciais.
2.  **User ():** Confirma os detalhes da implementação do sistema de importação melhorado.
3.  **Agent ():** Finaliza a implementação do sistema de importação melhorado e pergunta os próximos passos.
4.  **User ():** **MENSAGEM CRÍTICA.** Fornece um novo requisito muito detalhado para criar um sistema de relatórios semanais simples e eficaz, com novos exemplos de motoristas (Nelson, Jorge Macaia), valores específicos, e anexa 5 novos ficheiros. Este pedido redefine a prioridade atual.
5.  **Agent ( a ):** Começa a trabalhar na nova solicitação, iniciando a análise dos novos ficheiros fornecidos.

**Project Health Check:**
-   **Broken:** Nenhuma funcionalidade principal está quebrada.
-   **Mocked:** A lógica de automação/RPA (sincronização automática) está pendente. As UIs foram criadas, mas o backend que as executa ainda não foi implementado.

**3rd Party Integrations**
-   **Playwright:** Instalado, mas a sua utilização para automação RPA está pendente.
-   **pandas / openpyxl:** Usados extensivamente e de forma crucial para a importação de ficheiros Excel e CSV.

**Testing status**
-   **Testing agent used after significant changes:** YES. Usado com sucesso para validar a primeira versão da funcionalidade de importação de parceiros (v1).
-   **Troubleshoot agent used after agent stuck in loop:** NO
-   **Test files created:**
    -   /app/test_reports/iteration_2.json
-   **Known regressions:** Nenhuma conhecida.

**Credentials to test flow:**
-   **Admin:**  / 
-   **Parceiro:**  / 

**What agent forgot to execute**
-   Nada foi esquecido. O agente seguiu as prioridades do utilizador. As tarefas pendentes (refatoração, RPA) são conhecidas e estão listadas.</analysis>
