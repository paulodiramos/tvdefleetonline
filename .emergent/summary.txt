<analysis>**original_problem_statement:**
O utilizador solicitou a adição de campos para os IDs de motorista das plataformas Uber e Bolt. Estes novos campos,  e , devem ser adicionados à ficha do motorista e passar a ser o método principal de pesquisa durante a importação de dados de ganhos dessas plataformas, substituindo a pesquisa por email.

**User's preferred language**: Portuguese (português)

**what currently exists?**
Uma grande parte da aplicação está funcional, com várias funcionalidades e correções de bugs implementadas na sessão anterior. O agente iniciou a tarefa de adicionar os campos  e  à ficha do motorista. O campo de input para o  já foi adicionado ao ficheiro  no frontend, mas a lógica de gravação e o campo para o  ainda não foram implementados.

**Last working item**:
-   Last item agent was working: Adicionar o campo de input para  na interface do utilizador, no ficheiro . O agente já tinha adicionado o campo para  e estava a replicar o processo para o Bolt.
-   Status: IN PROGRESS
-   Agent Testing Done: N
-   User Testing Done: N
-   Which testing method agent to use? both

**All Pending/In progress Issue list**:
-   **Issue 1: Concluir a edição de dados no resumo semanal (P1)**
    -   **Attempted fixes:** O agente corrigiu a lógica do backend para ler os ajustes manuais, mas o utilizador reportou que a edição continua a não ser gravada.
    -   **Next debug checklist:**
        1.  Rever o endpoint  em .
        2.  Verificar os dados enviados pelo frontend em  para garantir que o payload está correto.
        3.  Testar a gravação e leitura do ajuste diretamente na base de dados.
    -   **Why fix this issue and what will be achieved with the fix?** Permitir que os parceiros façam correções manuais nos resumos semanais, uma funcionalidade essencial para a precisão dos relatórios financeiros.
    -   **Status:** IN PROGRESS
    -   **Is recurring issue?** Y
    -   **Should Test frontend/backend/both after fix?** both

-   **Issue 2: Importação de ficheiro de combustível (P1)**
    -   **Attempted fixes:** O agente corrigiu a função de importação para usar a coluna TOTAL, mas o utilizador reportou que o valor ainda não está correto.
    -   **Next debug checklist:**
        1.  Analisar novamente o ficheiro  para confirmar qual coluna (índice e nome) contém o valor final a ser importado.
        2.  Rever a função  em  e garantir que o  está a ser usado.
        3.  Verificar o cálculo do resumo semanal em  para garantir que o campo correto ( ou ) está a ser somado.
    -   **Why fix this issue and what will be achieved with the fix?** Corrigir a importação de despesas de combustível, crucial para o cálculo do lucro dos motoristas.
    -   **Status:** IN PROGRESS
    -   **Is recurring issue?** Y
    -   **Should Test frontend/backend/both after fix?** backend

-   **Issue 3: Erro de new-line character na importação de elétrico (P2)**
    -   **Attempted fixes:** O agente ajustou o router principal em  para direcionar ficheiros  para a função correta, mas o erro persiste.
    -   **Next debug checklist:**
        1.  Rastrear a chamada do frontend em  para confirmar o endpoint exato e o .
        2.  Rever a lógica de routing em  no endpoint  para garantir que ficheiros Excel de carregamento não caem acidentalmente no processamento de CSV.
    -   **Why fix this issue and what will be achieved with the fix?** Desbloquear a importação de dados de carregamentos elétricos.
    -   **Status:** IN PROGRESS
    -   **Is recurring issue?** Y
    -   **Should Test frontend/backend/both after fix?** both

-   **Issue 4: Refatoração do Backend (P2)**
    -   **Status:** IN PROGRESS (constante)
    -   **Next debug checklist:** Planear a extração de mais um grupo de endpoints de , como os de configuração () ou os restantes de importação, para os seus próprios ficheiros de rotas.
    -   **Why fix this issue and what will be achieved with the fix?** Reduzir a complexidade dos ficheiros monolíticos (, ), melhorando a manutenibilidade e escalabilidade do backend.

**In progress Task List**:
-   **Task 1: Implementar IDs de Plataforma (Uber/Bolt) para Motoristas (P0)**
    -   **Where to resume:** Continuar a edição do ficheiro  para adicionar o campo de input para o .
    -   **What will be achieved with this?** Concluir a interface de utilizador para que os novos IDs possam ser visualizados e editados.
    -   **Status:** IN PROGRESS
    -   **Should Test frontend/backend/both after fix?** both
    -   **Blocked on something:** Não

**Upcoming and Future Tasks**
-   **(P0) Task 1 (Continuação):**
    -   Atualizar o estado no frontend para gerir os novos campos  e .
    -   Atualizar o modelo Pydantic  em  para incluir os novos campos.
    -   Modificar o endpoint  para guardar os novos IDs.
-   **(P1) Atualizar Lógica de Importação (Uber/Bolt):**
    -   Modificar as funções  e  em  para usarem  e  como chaves primárias de pesquisa, com fallback para o email.
-   **(P1) Integração com SendGrid:** Continua bloqueada à espera da API Key do utilizador.
-   **(P3) Implementar lógica de Sincronização Automática (RPA):** Ainda não foi iniciada.

**Completed work in this session**
-   **Funcionalidade de Foto de Perfil do Motorista:** Implementada a funcionalidade completa de upload, visualização e remoção da foto de perfil, incluindo a criação de endpoints dedicados no backend (, , ) e correção da exibição no frontend.
-   **Refatoração do Backend (Fase 2-3):** Movidos múltiplos endpoints de  para novos ficheiros de rotas: , , .
-   **Sistema de Manutenção e Alertas por GPS:**
    -   Criado novo módulo .
    -   Implementado um endpoint para importar ficheiros CSV (ex: Verizon GPS) para atualizar a quilometragem () dos veículos.
    -   O sistema cria automaticamente alertas e notificações quando um veículo se aproxima da quilometragem de revisão.
-   **Correções de Bugs Críticos:**
    -   **Resumo Semanal:** Corrigido bug que impedia motoristas inativos de aparecerem nos relatórios e ajustada a lógica para buscar o valor do aluguer corretamente.
    -   **Eliminar Dados Semanais:** Corrigida a lógica de eliminação de dados (Via Verde, combustível, elétrico) para usar os identificadores corretos do veículo (matrícula, ID do cartão, etc.) em vez de apenas o ID do motorista.
    -   **Importações (Bolt, Combustível, Elétrico):** Corrigidos múltiplos bugs, incluindo a pesquisa de motoristas por email no Bolt, o uso da coluna correta (TOTAL) nos ficheiros de combustível, e a correção da coleção de destino e do campo de valor na importação de elétricos.
    -   **Somas no Resumo Semanal:** Corrigida a lógica de agregação de despesas de combustível e elétrico para usar os campos  e  como fallback, garantindo que dados importados com datas antigas mas para a semana atual sejam incluídos.

**Known issue recurrence from previous fork**
-   **Refatoração do Backend:** A tarefa continua a ser um trabalho em progresso. Os ficheiros  e  continuam a ser muito grandes.
-   **Integração SendGrid:** Continua bloqueada.

**Code Architecture**


**Key Technical Concepts**
-   **Resolução de Erros de Serialização:** Diagnosticado e resolvido um erro  que era causado por uma rota duplicada e desatualizada em  que estava a ser executada antes da rota corrigida e refatorada.
-   **Lógica de Ligação de Dados Complexa:** O agente corrigiu vários bugs onde os dados não eram corretamente associados ao motorista. A solução envolveu seguir a cadeia de ligação (Motorista -> Veículo -> ID do Cartão/Dispositivo) e usar múltiplos identificadores (, , ) nas queries da base de dados.
-   **Desenvolvimento Orientado a Testes (Manual):** O agente usou  e scripts  de forma eficaz para testar cada correção e nova funcionalidade, verificando os dados diretamente na base de dados antes e depois das operações para garantir a correção.

**All files of reference**
-   **/app/frontend/src/pages/FichaMotorista.js**: Onde a UI para os novos IDs está a ser implementada.
-   **/app/backend/models/motorista.py**: Onde o modelo Pydantic do motorista precisa de ser atualizado.
-   **/app/backend/routes/motoristas.py**: Onde o endpoint  para salvar os dados do motorista precisa de ser verificado/atualizado.
-   **/app/backend/server.py**: Contém a lógica de importação de Uber e Bolt que precisa de ser modificada.
-   **/app/backend/routes/relatorios.py**: Ficheiro de relatórios, alvo de várias correções e ainda necessita de refatoração.

**Areas that need refactoring**:
-   ** (CRÍTICO):** Continua com mais de 10.000 linhas e dezenas de endpoints que devem ser movidos para ficheiros de rotas dedicados.
-   ** (CRÍTICO):** É um ficheiro extremamente grande e complexo (mais de 3000 linhas) que lida com toda a lógica de relatórios. Dividi-lo em utilitários e funções mais pequenas é uma alta prioridade.

**key api endpoints**
-   : Para guardar as alterações na ficha do motorista (incluindo os novos IDs).
-   : Endpoint de importação de ganhos da Uber.
-   : Endpoint de importação de ganhos da Bolt.
-   : Para exibir a foto de perfil do motorista.

**Critical Info for New Agent**
-   A tarefa atual é concluir a implementação dos campos  e . Comece por terminar a UI no , depois atualize o backend (modelo e endpoint de gravação) e, por fim, modifique as funções de importação para usarem estes novos IDs.
-   Muitos bugs nesta aplicação derivam de duas causas principais:
    1.  **Modelos Pydantic incompletos** que filtram campos nas respostas . Verifique sempre os dados diretamente na base de dados com uma query  antes de assumir que uma gravação falhou.
    2.  **Lógica de query incompleta** que depende apenas de  quando deveria usar identificadores do veículo associado (, IDs de cartões, etc.).
-   Os ficheiros  e  são muito grandes. Ao trabalhar neles, seja muito cuidadoso e considere mover a lógica para novos ficheiros se a tarefa o permitir.

**documents and test reports created in this job**
-    (atualizado)
-    (NOVO)
-    (NOVO)
-    (NOVO)
-    (NOVO)
-    (NOVO, para teste)

**Project Health Check:**
-   **Broken:**
    -   Funcionalidade de envio de email via SendGrid (aguarda API Key).
    -   Edição de valores no resumo semanal.
    -   Importação de ficheiro de combustível.
-   **Mocked:**
    -   Lógica de automação (RPA) para sincronização.
-   **Needs Refactoring (High Priority):**
    -   
    -   

**3rd Party Integrations**
-   **Pillow, ReportLab, SendGrid, Playwright:** Instalados e utilizados (ou prontos a utilizar).
-   **Google Analytics:** Snippet  adicionado.
-   **openpyxl:** Utilizado para processamento de ficheiros .

**Testing status**
-   **Testing agent used after significant changes:** NO
-   **Troubleshoot agent used after agent stuck in loop:** NO
-   **Test files created:** 
-   **Known regressions:** A edição do resumo semanal parece ter regredido ou nunca foi totalmente corrigida.

**Credentials to test flow:**
-   **Admin:**  / 
-   **Parceiro:**  / </analysis>
