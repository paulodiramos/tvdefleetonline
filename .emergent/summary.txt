<analysis>**original_problem_statement:**
O utilizador solicitou uma vasta gama de novas funcionalidades e melhorias para o sistema de gestão de frotas TVDEFleet.

**REQUISITOS DO PRODUTO (Consolidado a partir do histórico e das últimas mensagens do utilizador):**
1.  **Integrações:**
    *   **Moloni (Faturação):**
        *   No perfil do motorista, permitir a ativação da auto-faturação.
        *   Esta funcionalidade deve estar condicionada a um módulo específico no plano do motorista.
        *   O motorista deve poder introduzir as suas próprias credenciais Moloni.
        *   Quando um relatório é emitido, o sistema deve gerar automaticamente uma fatura Moloni para o parceiro associado ao motorista.
    *   **Terabox (Armazenamento):** Implementar integração para guardar todos os documentos e fotos de motoristas e veículos. A UI de configuração foi adicionada, mas a lógica de backend precisa ser implementada.
    *   **Comunicações (Email & WhatsApp):**
        *   Criar um sistema de notificações para alertas, etc.
        *   A configuração das APIs (ex: SendGrid para email, WhatsApp Business) deve ser feita manualmente pelo administrador.
    *   **Pagamentos (IfthenPay):** Esta integração foi solicitada e depois **removida** pelo utilizador.

2.  **Funcionalidades Principais:**
    *   **Vistorias de Veículos:** Criar um sistema completo para agendar, realizar vistorias com upload de fotos e gerar um relatório em PDF que fica associado ao histórico do veículo. (Não iniciado)
    *   **Mensagens:** Substituir o antigo sistema de Tickets por um novo sistema de Mensagens onde o motorista pode escolher enviar uma mensagem para o Suporte ou para o seu Parceiro associado. (UI/Backend parcialmente implementado)
    *   **Templates de Contrato:** Parceiros devem poder criar os seus próprios templates de contrato. (Implementado)

3.  **Melhorias na UI/UX e Permissões (Perfil de Parceiro):**
    *   Ao criar um contrato, o parceiro logado deve ser pré-selecionado e a lista de outros parceiros deve ser ocultada. (Implementado)
    *   Ao criar um contrato, o parceiro deve ver apenas os motoristas e veículos associados à sua conta. (Implementado)
    *   O dashboard do parceiro (despesas, ganhos) deve refletir apenas os dados da sua conta. (Implementado)
    *   A página Sync Auto para um parceiro deve apenas mostrar opções de sincronização manual/agendada para a sua própria conta, sem listas de outros parceiros. (Parcialmente implementado)

4.  **Melhorias Gerais:**
    *   Adicionar links para Termos e Condições e Política de Privacidade no rodapé da página inicial pública, abrindo páginas de texto. (Implementado)
    *   Corrigir o bug persistente em que a alteração do plano de um motorista não atualizava visualmente o badge do plano na lista de motoristas. (Implementado)

**User's preferred language**: Portuguese (português)

**what currently exists?**
O agente concluiu um volume significativo de trabalho, focando-se em corrigir bugs críticos e implementar funcionalidades solicitadas em cascata pelo utilizador.

**Correções de Bugs:**
*   A página Pendentes (), que anteriormente não carregava, está agora funcional.
*   A página Lista de Contratos (), que apresentava um erro, agora carrega os dados corretamente.
*   O bug persistente onde o badge do plano do motorista não atualizava após a alteração foi corrigido através de modificações no backend (adicionando  ao endpoint ) e no frontend.
*   A role Operacional foi completamente removida de toda a aplicação (lógica, UI e texto) após uma extensa refatoração em mais de uma dezena de ficheiros.
*   O endpoint do dashboard do parceiro () foi corrigido para filtrar corretamente as receitas e despesas.

**Novas Funcionalidades e Melhorias:**
*   **Fluxo do Parceiro:** Foram implementadas melhorias significativas, garantindo que os parceiros vejam apenas dados (motoristas, veículos, contratos) associados à sua própria conta.
*   **Auto-Faturação Moloni:** Foi criada toda a infraestrutura para a funcionalidade. No backend, foram adicionados endpoints para guardar e obter as credenciais Moloni de um motorista, com uma verificação que restringe o acesso a motoristas cujo plano inclua a feature . No frontend, foi adicionado um novo separador no perfil do motorista para configurar o Moloni, que fica desativado se o plano não o permitir.
*   **Mensagens:** O sistema de Tickets foi removido e substituído por uma nova página de Mensagens para o motorista, com um seletor para enviar a mensagem para o Suporte ou para o Parceiro.
*   **UI:** Foi adicionada uma secção de configuração da Terabox na página de integrações e links para Termos e Condições e Política de Privacidade no rodapé da página pública. As integrações de pagamento foram removidas da UI a pedido.

**Last working item**:
-   Last item agent was working: O agente estava a implementar as melhorias na página  para o perfil de parceiro. O objetivo era remover a lista de seleção de parceiros e prepará-la para exibir um dashboard de ganhos/despesas e um botão de sincronização manual.
-   Status: IN PROGRESS
-   Agent Testing Done: N
-   Which testing method agent to use? screenshot tool
-   User Testing Done: N

**All Pending/In progress Issue list**:
Nenhum bug ativo reportado pelo utilizador. As tarefas pendentes são de implementação de novas funcionalidades.

**In progress Task List**:
-   Task 1: Concluir a UI da página Sync Auto para Parceiros (P0)

**Task Detail**:
-   Task 1: **Concluir a UI da página Sync Auto para Parceiros (P0)**
    -   Where to resume: O agente já modificou a página  para esconder a lista de seleção de parceiros quando o utilizador logado é um parceiro. O próximo passo é adicionar os componentes visuais para o dashboard de ganhos/despesas e o botão de sincronização manual, conforme solicitado pelo utilizador.
    -   What will be achieved with this?: Alinhará a página Sync Auto com as restantes melhorias do fluxo de parceiro, mostrando apenas controlos e dados relevantes.
    -   Status: IN PROGRESS
    -   Should Test frontend/backend/both after fix?: Frontend
    -   Blocked on something: None.

**Upcoming and Future Tasks**
*   **Upcoming Tasks:**
    *   (P0) **Implementar Lógica de Backend para Auto-Faturação Moloni**: O frontend e o armazenamento de credenciais estão prontos. É necessário implementar a lógica que, ao gerar um relatório, utiliza as credenciais guardadas do motorista para chamar a API Moloni e criar uma fatura para o parceiro associado.
    *   (P1) **Implementar Sistema de Vistorias de Veículos**: Criar a funcionalidade completa para agendar vistorias, permitir o upload de fotos, gerar um PDF do relatório e associá-lo ao histórico do veículo.
    *   (P1) **Implementar Sistema de Comunicações (Admin UI)**: Criar uma interface na área de administração para que o admin possa configurar manualmente as credenciais para as APIs de Email (ex: SendGrid) e WhatsApp.
    *   (P1) **Implementar Lógica de Backend para Notificações**: Utilizar as configurações do passo anterior para efetivamente enviar notificações (alertas, mensagens do sistema, etc.) por Email e WhatsApp.
    *   (P2) **Implementar Lógica de Backend para Integração Terabox**: O frontend tem um campo para configurar a integração. A lógica de backend para efetivamente guardar os ficheiros no Terabox precisa de ser implementada.
*   **Future Tasks:**
    *   (P2) **Preencher Conteúdo das Páginas de Termos e Privacidade**: As páginas  e  foram criadas como placeholders. Precisam de ser populadas com o conteúdo real.

**Completed work in this session**
-   **Resolução de Bugs Críticos:**
    -   Corrigido o erro de carregamento na página Pendentes.
    -   Corrigido o erro Erro ao carregar contratos na Lista de Contratos, resolvendo um problema de URL duplicado ().
    -   Resolvido o bug recorrente onde o badge do plano do motorista não atualizava na UI após a alteração.
    -   Corrigido o dashboard do parceiro para filtrar corretamente as receitas e despesas.
-   **Refatoração e Melhorias:**
    -   Removida completamente a role Operacional de toda a base de código do frontend.
    -   Implementada a filtragem de dados por parceiro em múltiplos endpoints (, , ) e páginas ().
-   **Implementação de Funcionalidades:**
    -   Implementado o framework completo para auto-faturação Moloni (armazenamento de credenciais no backend e UI de configuração no perfil do motorista, com validação baseada no plano).
    -   Removido o sistema de Tickets e implementada uma nova página de Mensagens para motoristas com seletor de destinatário.
    -   Adicionados links e páginas para Termos e Condições e Política de Privacidade na landing page pública.
    -   Removidas as integrações de pagamento da UI, a pedido do utilizador.
    -   Adicionada a UI para configuração da integração Terabox.

**Earlier issues found/mentioned but not fixed**
-   None. O agente foi extremamente reativo e abordou todos os problemas mencionados pelo utilizador ao longo da sessão.

**Known issue recurrence from previous fork**
-   **Issue**: Remoção da role Operacional.
    -   **Recurrence count**: Pelo menos 2 (mencionada no handoff inicial e novamente pelo utilizador).
    -   **Status**: RESOLVED. O agente realizou uma busca e substituição exaustiva em toda a base de código do frontend.
-   **Issue**: Erro ao carregar a página Pendentes.
    -   **Recurrence count**: 1
    -   **Status**: RESOLVED. O agente validou a correção do backend com testes de frontend.

**Code Architecture**


**Key Technical Concepts**
-   **Filtragem de Dados Baseada na Role**: O backend foi sistematicamente modificado para filtrar dados com base no  e , garantindo que os parceiros só acedem à sua própria informação.
-   **MongoDB Aggregation ()**: Utilizado para enriquecer documentos, como adicionar o  aos dados do motorista, resolvendo um bug de UI persistente.
-   **Feature Gating Baseado no Plano**: Implementada lógica no backend e frontend para ativar/desativar funcionalidades (ex: auto-faturação Moloni) com base numa lista de  no plano do utilizador.
-   **Debugging de API Frontend**: Identificado e corrigido um erro comum de duplicação de path em chamadas API (e.g., ), onde a constante base da API já continha .

**key DB schema**
-   **users** (collection): Implicitamente atualizado para suportar credenciais Moloni por motorista (e.g., ).
-   **planos_sistema** (collection): Implicitamente atualizado para incluir um array  para controlar o acesso a módulos (e.g., ).
-   **contrato_templates** (collection): Nova coleção para armazenar templates de contrato, com um campo  para associar ao criador.
-   **mensagens** (collection): Nova coleção para armazenar as mensagens trocadas entre motoristas e suporte/parceiros.

**changes in tech stack**
-   Nenhuma alteração de dependências principais, mas foi planeada a utilização de SDKs para Moloni, Terabox, Email e WhatsApp.

**All files of reference**
-   **Criados**:
    -   
    -   
    -   
    -    (ou significativamente atualizado de placeholder para funcional)
-   **Atualizados/Refatorados (principais)**:
    -   : Adicionados múltiplos endpoints e lógica de negócio de filtragem.
    -   : Corrigido bug de atualização de estado e UI.
    -   : Melhorias no fluxo do parceiro.
    -   : Refatoração da UI.
    -   : Correção de bug.
    -   : Melhorias no fluxo do parceiro.
    -   : Adicionada configuração Moloni.
    -   : Alterações nos menus de navegação.

**Areas that need refactoring**:
-   ** Monolith**: O ficheiro continua a ser um ponto central de preocupação. Com a adição de lógica para Moloni, templates e mensagens, a necessidade de o dividir em routers/módulos separados (e.g., , , ) é cada vez mais crítica para a manutenibilidade.

**key api endpoints**
-   **Novos:**
    -   : Guarda as credenciais Moloni de um motorista.
    -   : Obtém as credenciais Moloni de um motorista.
    -   : Cria um novo template de contrato.
    -   : Lista templates de contrato (filtrado por parceiro).
    -   : Envia uma nova mensagem (de motorista para suporte/parceiro).
    -   : Obtém mensagens de uma conversa.
-   **Modificados:**
    -   : Agora faz lookup para adicionar  e .
    -   : Agora faz lookup para adicionar . Filtra por parceiro.
    -   : Agora filtra para retornar apenas o próprio parceiro se o utilizador for um parceiro.
    -   : Corrigido para filtrar corretamente receitas/despesas por parceiro.

**Critical Info for New Agent**
-   **API Path Duplication**: Esteja atento ao fazer chamadas de API no frontend. A constante  exportada de  já inclui o prefixo . As chamadas devem ser feitas como  e **NÃO** . Este erro já causou vários bugs.
-   **Data Filtering by Role**: Uma grande parte do trabalho foi garantir a segregação de dados para o perfil 'parceiro'. Ao criar novos endpoints ou modificar existentes, verifique sempre se é necessário aplicar um filtro com base no  do utilizador autenticado.
-   **Feature Gating**: Funcionalidades avançadas como a auto-faturação Moloni estão agora controladas por um array  nos modelos de planos. Ao implementar novas funcionalidades pagas, siga este padrão.

**documents created in this job**
-   None.

**Last 10 User Messages and any pending user messages**
1.  **User**: Pediu 8 tarefas, incluindo T&C na landing page, Moloni no perfil do motorista, filtros para parceiros, remover pagamentos e corrigir o bug do plano. - **Status**: PARCIALMENTE COMPLETO.
2.  **User**: Confirmou para avançar com 3 tarefas prioritárias. - **Status**: COMPLETO.
3.  **User**: Confirmou para avançar com as 5 tarefas restantes. - **Status**: PARCIALMENTE COMPLETO.
4.  **User**: Pediu para implementar o módulo Moloni no perfil do motorista para auto-faturação. - **Status**: COMPLETO.
5.  **User**: Adicionou o requisito de que o módulo Moloni só pode ser ativado se estiver incluído no plano do motorista. - **Status**: COMPLETO.
6.  **User**: Pediu melhorias no fluxo do parceiro (templates de contrato, criar contrato, sync auto). - **Status**: IN PROGRESS.
7.  **User**: ... e 4 mensagens anteriores com listas de tarefas que foram resolvidas.

**Project Health Check:**
-   **Broken**: Nada está criticamente quebrado neste momento.
-   **Mocked**:
    -   As páginas  e  são placeholders.
    -   A UI para configurar **Terabox** e **Comunicações (Email/WhatsApp)** existe, mas a lógica de backend não está implementada.
    -   A UI para **auto-faturação Moloni** está completa, mas a lógica de backend que efetivamente gera a fatura ainda não foi criada.
    -   A página de **Mensagens** permite enviar mensagens para o backend, mas a integração para as enviar para fora do sistema (via Email/WhatsApp) não existe.

**3rd Party Integrations**
-   **Moloni**: Parcialmente implementada. UI de configuração e armazenamento de credenciais estão prontos. A lógica de geração de faturas está pendente.
-   **Terabox**: Planeada. UI de configuração existe, mas a lógica de backend para upload de ficheiros está pendente.
-   **Email / WhatsApp**: Planeadas. A infraestrutura base de mensagens está criada, mas a UI de configuração de admin e a lógica de envio estão pendentes.
-   **IfthenPay**: Removida a pedido do utilizador.
-   **ReportLab**: Utilizada no backend para geração de PDFs.

**Testing status**
-   **Testing agent used after significant changes**: NO
-   **Troubleshoot agent used after agent stuck in loop**: NO
-   **Test files created**: None.
-   **Known regressions**: None in this session. Várias regressões de sessões anteriores foram corrigidas.

**Credentials to test flow:**
-   Disponíveis em .

**What agent forgot to execute**
-   O agente não esqueceu tarefas, mas priorizou as solicitações mais recentes do utilizador em detrimento das tarefas maiores do plano original, como o sistema de **Vistorias de Veículos**. A implementação completa da lógica de backend para as integrações (Moloni, Terabox, Comunicações) também está pendente, embora a infraestrutura base esteja montada.</analysis>
