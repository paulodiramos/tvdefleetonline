<analysis>**original_problem_statement:**
O utilizador solicitou uma série de refinamentos ao sistema de relatórios para parceiros, evoluindo a cada etapa:
1.  **Relatório Semanal Inicial:** Criar um sistema de relatórios semanais que consolide ganhos (Uber, Bolt) e despesas (Via Verde, combustível, elétrico) para cada motorista, com base em ficheiros de exemplo. O relatório deve ser simples e eficaz.
2.  **Dashboards e Histórico:** Adicionar um card de resumo semanal ao dashboard do parceiro e uma página de histórico de todas as importações de ficheiros, visível para o parceiro e gestor, com filtros por período.
3.  **Comissões e Gráficos:** Alterar o cálculo para, em vez de aluguer, mostrar comissões pagas aos motoristas (com base no contrato). O valor líquido passa a ser o que fica para o parceiro. Adicionar gráficos de evolução semanal ao dashboard e funcionalidades para enviar o relatório por WhatsApp ou Email (SendGrid).
4.  **Lógica Financeira Final:** Redefinir o valor líquido do parceiro para ser a soma de:
    *   Todos os alugueres de veículos ativos na semana.
    *   Vendas de veículos realizadas.
    *   Extras (dívidas, cauções parceladas, danos), que devem ser geríveis através de uma nova funcionalidade.

**User's preferred language**: Portuguese (português)

**what currently exists?**
A aplicação tem um sistema de relatórios semanais funcional, com as seguintes características:
-   **Dashboard do Parceiro**: Exibe um card de resumo com gráficos () que mostram a evolução semanal de ganhos, despesas e valor líquido.
-   **Página de Resumo Semanal Detalhada**: Apresenta uma tabela com os ganhos (Uber, Bolt), despesas (combustível, portagens, etc.), comissões e valor líquido para cada motorista. Inclui botões para enviar o relatório individual por WhatsApp (link ) e Email (lógica SendGrid preparada, aguarda API key).
-   **Página de Histórico de Importações**: Lista todos os ficheiros importados (Uber, Bolt, etc.) num determinado período, com totais de registos e valores.
-   **Backend**: Os endpoints calculam em tempo real todos os valores a partir das coleções de dados importados, incluindo o cálculo de comissões com base no contrato do veículo. A integração com SendGrid foi instalada e a estrutura de envio de email está pronta.

**Last working item**:
-   **Last item agent was working:** O agente estava a implementar o requisito final do utilizador para redefinir o cálculo do lucro do parceiro. O trabalho envolveu:
    1.  Adicionar campos de venda (, , ) ao modelo  no .
    2.  Criar um novo modelo Pydantic () e uma nova coleção no MongoDB para gerir Extras (dívidas, danos, etc.).
    3.  Criar endpoints CRUD () para gerir esses extras.
    4.  Começar a modificar o endpoint de resumo semanal () e o card do dashboard () para refletir esta nova lógica de cálculo (Alugueres + Vendas + Extras).
-   **Status:** IN PROGRESS
-   **Agent Testing Done:** N
-   **Which testing method agent to use?** both
-   **User Testing Done:** N

**All Pending/In progress Issue list**:
-   **Issue 1: Finalizar a nova lógica de cálculo do Valor Líquido do parceiro (P0)**
-   **Issue 2: Implementar envio de email com SendGrid (P1)**
-   **Issue 3: Refatoração do Backend (P2)**
-   **Issue 4: Implementar a lógica de Sincronização Automática (RPA) (P3)**

Issues Detail:
-   **Issue 1: Finalizar a nova lógica de cálculo do Valor Líquido do parceiro (P0)**
    -   **Attempted fixes:** O agente já criou os modelos de dados e os endpoints para gerir Extras e Vendas. A lógica no endpoint de resumo semanal () e no componente de frontend () foi parcialmente atualizada.
    -   **Next debug checklist:**
        1.  Reiniciar o backend para aplicar as últimas alterações.
        2.  Testar os novos endpoints CRUD para Extras ().
        3.  Testar o endpoint principal de resumo () via  para garantir que os cálculos de aluguer, vendas e extras estão corretos.
        4.  Verificar a UI no dashboard e na página de resumo para confirmar que os novos totais são exibidos corretamente.
        5.  Criar uma UI para o parceiro/gestor poder adicionar/editar/remover os Extras para cada motorista.
    -   **Why fix this issue and what will be achieved with the fix?** Implementar a lógica financeira final e mais precisa, conforme solicitado pelo utilizador, para o cálculo do lucro do parceiro.
    -   **Status:** IN PROGRESS
    -   **Is recurring issue?** N
    -   **Should Test frontend/backend/both after fix?** both

-   **Issue 2: Implementar envio de email com SendGrid (P1)**
    -   **Attempted fixes:** O pacote  foi instalado e um serviço () e um endpoint () foram criados. Um placeholder  foi adicionado ao .
    -   **Next debug checklist:**
        1.  Obter a API key do utilizador.
        2.  Adicionar a key ao ficheiro  do backend.
        3.  Implementar a lógica de envio de email no serviço  usando a key.
        4.  Testar a funcionalidade de envio de email a partir da UI.
    -   **Why fix this issue and what will be achieved with the fix?** Habilitar o envio de relatórios semanais por email aos motoristas.
    -   **Status:** BLOCKED (aguarda API key do utilizador)
    -   **Is recurring issue?** N
    -   **Should Test frontend/backend/both after fix?** backend

-   **Issue 3: Refatoração do Backend (P2)**
    -   **Attempted fixes:** Nenhuma nesta sessão. O ficheiro  continua monolítico.
    -   **Next debug checklist:** Mover a lógica de endpoints para ficheiros de rotas dedicados (ex: , ) e a lógica de importação para .
    -   **Why fix this issue and what will be achieved with the fix?** Melhorar a manutenibilidade, escalabilidade e organização do código.
    -   **Status:** NOT STARTED
    -   **Is recurring issue?** Y
    -   **Should Test frontend/backend/both after fix?** backend

-   **Issue 4: Implementar a lógica de Sincronização Automática (RPA) (P3)**
    -   **Attempted fixes:** Nenhuma nesta sessão. As UIs existem, mas o backend não está implementado.
    -   **Next debug checklist:** Implementar a lógica no  para executar as importações automáticas com base nas credenciais e configurações guardadas.
    -   **Why fix this issue and what will be achieved with the fix?** Automatizar a importação de dados, uma funcionalidade chave solicitada pelo utilizador.
    -   **Status:** NOT STARTED
    -   **Is recurring issue?** N
    -   **Should Test frontend/backend/both after fix?** backend

**In progress Task List**:
-   **Task 1: Implementação da Lógica Financeira Final (P0)**
    -   **Where to resume:** A implementação está a meio. O agente acabou de modificar os modelos de dados e os endpoints. O próximo passo é testar o backend e depois garantir que a UI reflete as mudanças.
    -   **What will be achieved with this?** A aplicação calculará e exibirá o lucro do parceiro com base em alugueres, vendas de veículos e extras, conforme a definição mais recente do utilizador.
    -   **Status:** IN PROGRESS
    -   **Should Test frontend/backend/both after fix?** both
    -   **Blocked on something:** Não

**Upcoming and Future Tasks**
-   **Upcoming Tasks:**
    -   (P1) **Issue 2**: Finalizar a integração com SendGrid assim que o utilizador fornecer a API key.
    -   (P1) Criar a interface de utilizador para gerir os Extras dos motoristas.
    -   (P2) **Issue 3**: Refatorar o backend.
    -   (P3) **Issue 4**: Implementar a lógica de sincronização automática (RPA).
-   **Future Tasks:**
    -   Modificar a geração do PDF do relatório semanal para incluir a lista detalhada das transações da Via Verde.
    -   Adicionar notificações para o parceiro sobre o estado da importação (sucesso/erro).
    -   Criar um editor visual para os passos de automação RPA.

**Completed work in this session**
-   **Sistema de Relatórios v1 (CONCLUÍDO e TESTADO):** Implementado e validado o relatório semanal com cálculos corretos para ganhos (Uber/Bolt) e despesas de aluguer, correspondendo aos exemplos do utilizador.
-   **Card de Resumo no Dashboard (CONCLUÍDO):** Criado um card no dashboard do parceiro com um resumo financeiro (ganhos, despesas, comissões, líquido) e um gráfico de evolução semanal.
-   **Página de Histórico de Importações (CONCLUÍDA):** Criada uma nova página que lista todos os ficheiros importados num período, com totais por plataforma.
-   **Envio de Relatório por WhatsApp (CONCLUÍDO):** Implementada a geração de um link  para enviar um resumo do relatório a um motorista.
-   **Cálculo de Comissões (CONCLUÍDO):** A lógica de relatório foi atualizada para calcular a comissão do motorista com base no contrato do seu veículo.

**Earlier issues found/mentioned but not fixed**
-   Nenhum.

**Known issue recurrence from previous fork**
-   **Refatoração do Backend:** A necessidade de refatorar o ficheiro monolítico  foi novamente adiada em favor da implementação de novas funcionalidades.

**Code Architecture**


**Key Technical Concepts**
-   **FastAPI Backend:** Modificação extensiva de endpoints, criação de novos modelos Pydantic.
-   **MongoDB (motor):** Uso de queries complexas com ,  e agregações para consolidar dados em tempo real.
-   **React Frontend:** Criação de novos componentes e páginas, gestão de estado, e uso da biblioteca  para gráficos.
-   **Processamento de Ficheiros (Pandas):** Fundamental para a importação de dados.

**key DB schema**
-   ****: Contém , , , e os novos campos:  (bool),  (str),  (float).
-   ****: Nova coleção para armazenar dívidas, cauções, danos, etc. Campos: , , , , .
-   ****: Armazena credenciais para a futura automação RPA.
-   Coleções de dados: , , , ,  (elétrico).

**All files of reference**
-   **/app/backend/server.py**: Modificado para adicionar novos modelos Pydantic (, campos de venda em ) e endpoints CRUD para os extras.
-   **/app/backend/routes/relatorios.py**: Modificado extensivamente para a nova lógica de cálculo de comissões, totais do parceiro, e para os novos endpoints de histórico e envio.
-   **/app/backend/services/envio_relatorios.py**: Ficheiro novo para a lógica de envio (WhatsApp, SendGrid).
-   **/app/frontend/src/pages/Dashboard.js**: Modificado para incluir o novo .
-   **/app/frontend/src/pages/ResumoSemanalParceiro.js**: Modificado para incluir botões de ação para envio de relatórios.
-   **/app/frontend/src/pages/ListaImportacoes.js**: Ficheiro novo para a página de histórico de importações.
-   **/app/frontend/src/components/ResumoSemanalCard.js**: Ficheiro novo, depois modificado, para exibir o resumo financeiro e o gráfico de evolução.
-   **/app/frontend/src/App.js**: Modificado para adicionar a nova rota .
-   **/app/frontend/src/components/Layout.js**: Modificado para adicionar o link para a nova página no menu.
-   **/app/backend/.env**: Modificado para adicionar o placeholder .

**Areas that need refactoring**:
-   : Continua a ser um ficheiro monolítico com modelos e rotas misturados, necessitando de uma separação urgente para melhor organização.

**key api endpoints**
-   : Endpoint principal de relatórios (modificado).
-   : Endpoint para a página de histórico de importações (novo).
-   : Endpoint para os dados do gráfico de evolução (novo).
-   : Endpoint para gerar link de envio por WhatsApp (novo).
-   : Endpoint para envio por email (novo, pendente).
-   : Endpoints para gerir extras (novo).
-   : Endpoints para gerir extras (novo).

**Critical Info for New Agent**
-   **Prioridade Máxima:** A tarefa mais importante é concluir a implementação da nova lógica de cálculo do lucro do parceiro (alugueres + vendas + extras). O trabalho foi iniciado, mas precisa ser testado e finalizado, incluindo a criação de uma UI para gerir os Extras.
-   **SendGrid API Key:** A funcionalidade de envio de email está bloqueada, aguardando que o utilizador forneça a API key da SendGrid. A estrutura no backend está pronta.
-   **Refatoração Pendente:** A dívida técnica de refatorar o  monolítico continua a crescer. Deve ser abordada assim que as funcionalidades de alta prioridade estiverem concluídas.

**documents and test reports created in this job**
-   /app/test_reports/iteration_3.json
-   /app/memory/PRD.md (atualizado múltiplas vezes)

**Last 10 User Messages and any pending HUMAN messages**
-   **#285:** Pede para alterar o cálculo do resumo: despesas devem ser comissões, líquido é o valor do parceiro, e pede gráficos. Pergunta sobre o sistema para enviar relatórios por WhatsApp/Email.
-   **#288:** Confirma que a comissão depende do contrato e escolhe as opções para o envio de relatórios.
-   **#291:** Confirma  para WhatsApp, SendGrid para email, e que a comissão está no contrato do veículo.
-   **#299:** Informa que a API key da SendGrid será fornecida mais tarde.
-   **#355:** Pede uma nova alteração: o valor líquido do parceiro deve ser a soma de alugueres, vendas de veículos e extras.
-   **#358:** Confirma os detalhes da nova lógica: somar todos os alugueres ativos, extras incluem dívidas/danos, e pede para criar os campos necessários.

**Project Health Check:**
-   **Broken:** Nenhuma funcionalidade principal está quebrada.
-   **Mocked:** O envio de emails via SendGrid e a automação RPA estão pendentes (o primeiro por falta de API key, o segundo por falta de implementação).

**3rd Party Integrations**
-   **pandas / openpyxl:** Usado para importação de ficheiros.
-   **recharts:** Usado no frontend para exibir gráficos de evolução.
-   **SendGrid:** Instalado no backend, mas a implementação está bloqueada aguardando a API key.
-   **Playwright:** Instalado, mas a automação (RPA) ainda não foi implementada.

**Testing status**
-   **Testing agent used after significant changes:** YES. Usado com sucesso para validar a v1 do sistema de relatórios.
-   **Troubleshoot agent used after agent stuck in loop:** NO
-   **Test files created:**
    -   /app/test_reports/iteration_3.json
-   **Known regressions:** Nenhuma.

**Credentials to test flow:**
-   **Admin:**  / 
-   **Parceiro:**  / 

**What agent forgot to execute**
-   Nada foi esquecido. As tarefas pendentes (refatoração, RPA, SendGrid) são conhecidas e estão listadas como bloqueadas ou de menor prioridade, conforme as direções do utilizador.</analysis>
