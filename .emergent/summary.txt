<analysis>**original_problem_statement:**
O utilizador pretende evoluir o seu sistema de gestão de frotas. As solicitações do utilizador nesta sessão incluíram:
1.  **Sistema de Mensagens:** Implementar um sistema de mensagens onde os destinatários são filtrados com base na hierarquia de papéis (admin, parceiro, gestor, motorista).
2.  **Correções de Bugs Críticos em Relatórios:**
    *   No **Dashboard de Faturação**, corrigir os totais e as percentagens que estavam incorretos. Garantir que os parceiros veem apenas os dados das suas próprias empresas.
    *   No **Resumo Semanal**, impedir que motoristas desativados e motoristas de outros parceiros apareçam no relatório.
3.  **Refatoração do Componente :** Continuar a refatoração do componente monolítico, extraindo o código das tabs para componentes individuais.
4.  **Arquivo de Motoristas:**
    *   Na página principal de motoristas (), mostrar apenas os motoristas ativos.
    *   Criar uma página de Arquivo para motoristas desativados, que devem manter todos os seus dados históricos.
    *   Ao clicar num motorista arquivado, mostrar uma ficha de detalhes **simplificada**, contendo apenas dados pessoais, documentos, plataformas e histórico de rendimentos.
5.  **Fluxo de Aprovação de Utilizadores:** Modificar o diálogo de aprovação de utilizadores para que o admin possa atribuir um **Plano** e **Preços Especiais** no momento da aprovação.

**PRODUCT REQUIREMENTS:**
-   **Sistema de Mensagens Hierárquico:** O seletor de destinatários nas mensagens deve apresentar apenas os utilizadores permitidos com base no papel do remetente.
-   **Relatórios Financeiros Precisos:** O Dashboard de Faturação e o Resumo Semanal devem apresentar dados corretos, filtrados por parceiro e excluindo entidades inativas ou irrelevantes.
-   **Gestão de Motoristas Ativos/Inativos:** A aplicação deve distinguir claramente entre motoristas ativos e inativos (arquivados), com listas e fichas de detalhe apropriadas para cada estado.
-   **Código Manutenível:** O componente  deve ser progressivamente refatorado para melhorar a manutenibilidade.
-   **Fluxo de Aprovação Completo:** O admin deve conseguir aprovar novos utilizadores e configurar o seu plano de faturação e preços especiais num único passo.

**User's preferred language**: Portuguese (Portugal)

**what currently exists?**
É um sistema de gestão de frotas full-stack (React/FastAPI/MongoDB). Nesta sessão, o agente implementou e corrigiu várias funcionalidades críticas solicitadas pelo utilizador:
1.  **Sistema de Mensagens:** Foi criado um novo endpoint de backend () que implementa a lógica de filtragem de destinatários por hierarquia de papéis. O frontend foi atualizado para usar este endpoint e a funcionalidade foi validada com testes manuais e do testing agent.
2.  **Correção de Relatórios:** Foram corrigidos múltiplos bugs no backend (, ) que causavam inconsistências de dados no Dashboard de Faturação e no Resumo Semanal. As correções envolveram aprimorar queries MongoDB, corrigir cálculos de percentagens e filtrar dados pertencentes a outros parceiros.
3.  **Refatoração Parcial de :** A tab Dispositivos foi extraída com sucesso para o seu próprio componente (), reduzindo o tamanho do ficheiro principal.
4.  **Funcionalidade de Arquivo de Motoristas:** Foi implementada a separação entre motoristas ativos e inativos. A lista principal agora mostra apenas ativos, e foi criada uma página de arquivo para os inativos, com uma ficha de detalhes simplificada e personalizada () conforme solicitado.

**Last working item**:
-   **Last item agent was working:** O agente estava a trabalhar na solicitação para melhorar o fluxo de aprovação de utilizadores na página . O objetivo era adicionar a capacidade de o administrador selecionar um **Plano** e **Preços Especiais** para um novo utilizador diretamente no diálogo de aprovação. O agente já tinha começado a modificar o componente React, adicionando os estados necessários e a lógica para buscar os planos existentes.
-   **Status:** IN PROGRESS
-   **Agent Testing Done:** N
-   **Which testing method agent to use?** both. O backend precisa de testes para garantir que o plano e os preços especiais são corretamente associados ao utilizador. O frontend precisa de testes para validar a UI do diálogo de aprovação.
-   **User Testing Done:** N

**All Pending/In progress Issue list**:
-   Issue 1: Concluir a melhoria do fluxo de aprovação de utilizadores (P0)
-   Issue 2: Refatoração Incompleta de  (P1)
-   Issue 3: Erro ao Carregar Dados em Produção (P2)
-   Issue 4: Instabilidade do scraper da Prio (P3)

**Issues Detail:**
-   **Issue 1: Concluir a melhoria do fluxo de aprovação de utilizadores (P0)**
    -   **Attempted fixes:** O agente começou a modificar o componente . Foram adicionados  para , , e , e uma função  foi adicionada para carregar os planos quando o diálogo de aprovação é aberto.
    -   **Next debug checklist:**
        1.  Adicionar os elementos de UI (dropdowns/selects) para Planos e Preços Especiais no .
        2.  Modificar o handler de aprovação no frontend para enviar o  e  selecionados.
        3.  Atualizar o endpoint de backend  em  para aceitar e processar os novos campos, associando o plano e o preço especial ao utilizador.
        4.  Testar o fluxo completo.
    -   **Why fix this issue and what will be achieved with the fix?** Simplifica o trabalho do admin, permitindo configurar um novo utilizador completamente num único passo.
    -   **Status:** IN PROGRESS
    -   **Is recurring issue?** N
    -   **Should Test frontend/backend/both after fix?** Both.
    -   **Blocked on other issue:** Não.

-   **Issue 2: Refatoração Incompleta de  (P1)**
    -   **Attempted fixes:** A tab Dispositivos foi extraída para o componente . O ficheiro principal foi reduzido em ~175 linhas.
    -   **Next debug checklist:**
        1.  Priorizar a extração da tab info (~2200 linhas) para o seu próprio componente (), que já existe mas está incompleto.
        2.  Extrair a tab agenda (~277 linhas).
        3.  Verificar e refatorar a tab relatorio, se necessário.
    -   **Why fix this issue and what will be achieved with the fix?** O ficheiro tem mais de 5000 linhas, sendo extremamente difícil de manter. A refatoração irá melhorar drasticamente a legibilidade e manutenção.
    -   **Status:** IN PROGRESS
    -   **Is recurring issue?** N
    -   **Should Test frontend/backend/both after fix?** Frontend.
    -   **Blocked on other issue:** Não.

-   **Issue 3: Erro ao Carregar Dados em Produção (P2)**
    -   **Description:** Mencionado no handoff inicial. O utilizador reportou apos deploy esta aparecer errro a carregar dados, sugerindo um problema de dessincronização da base de dados de produção. Este problema não foi abordado nesta sessão.
    -   **Status:** NOT STARTED
    -   **Is recurring issue?** Y
    -   **Should Test frontend/backend/both after fix?** Both.
    -   **Blocked on other issue:** Aguardando mais informações do utilizador ou acesso a logs de produção.

-   **Issue 4: Instabilidade do scraper da Prio (P3)**
    -   **Description:** Mencionado em handoffs anteriores, mas não abordado nesta sessão.
    -   **Status:** NOT STARTED
    -   **Is recurring issue?** Y
    -   **Should Test frontend/backend/both after fix?** Backend.
    -   **Blocked on other issue:** Não.

**In progress Task List**:
-   **Task 1: Melhorar fluxo de aprovação de utilizadores (P0)**
    -   **Where to resume:** Em , continuar a implementação da adição dos seletores de Plano e Preço Especial ao .
    -   **What will be achieved with this?** O admin poderá aprovar e configurar totalmente um utilizador numa única ação.
    -   **Status:** IN PROGRESS
    -   **Should Test frontend/backend/both after fix?** Both.
    -   **Blocked on something:** Não.

**Upcoming and Future Tasks**
*   **Upcoming Tasks:**
    *   (P1) Concluir a refatoração de , focando na tab Info.
    *   (P2) Investigar e resolver o erro de carregamento de dados em produção.
    *   (P3) Investigar a instabilidade do scraper da Prio.
*   **Future Tasks:**
    *   Integração com o WhatsApp.
    *   Implementar funcionalidades de Alertas Avançados e Comissões Avançadas.
    *   Criar um sistema para arquivar dados antigos da base de dados.
    *   Implementar um sistema de relógio de ponto na app móvel.

**Completed work in this session**
-   **Funcionalidade: Sistema de Mensagens por Hierarquia (DONE)**
    -   Criado endpoint  em  com lógica de filtragem.
    -   Atualizado  para usar o novo endpoint.
-   **Correção: Dashboard de Faturação (DONE)**
    -   Corrigidos cálculos de totais e percentagens em .
    -   Adicionado filtro para garantir que parceiros vejam dados apenas das suas empresas.
-   **Correção: Resumo Semanal (DONE)**
    -   Corrigida a lógica em  para priorizar o campo  e verificar o status de  e , excluindo motoristas inativos ou de outros parceiros.
-   **Funcionalidade: Arquivo de Motoristas (DONE)**
    -   Endpoint  em  foi atualizado para retornar apenas motoristas ativos.
    -   Criado componente  para uma ficha de detalhe simplificada para motoristas arquivados.
    -   Atualizada a página  para usar o novo componente.
-   **Refatoração: FichaVeiculo.js - Tab Dispositivos (DONE)**
    -   Criado e implementado o componente .

**Earlier issues found/mentioned but not fixed**
-   **Erro de dados em Produção:** O utilizador reportou um erro crítico em produção (erro a carregar dados) que não foi investigado.
-   **Instabilidade do scraper da Prio:** Mencionado em handoffs anteriores, continua por abordar.

**Known issue recurrence from previous fork**
-   **Base de Dados de Produção Desatualizada:** Mencionada em handoffs anteriores, e é a causa provável do erro de carregamento de dados em produção reportado pelo utilizador.
-   **Recurrence count:** Alta
-   **Status:** NOT STARTED

**Code Architecture**


**Key Technical Concepts**
-   **Backend Role-Based Filtering:** Implementação de lógica de negócio complexa num endpoint para filtrar dados com base no papel e nas relações do utilizador autenticado.
-   **Debugging de Inconsistência de Dados:** Identificação e correção de problemas causados por dados inconsistentes na base de dados (e.g., múltiplos campos de ID de parceiro,  vs ).
-   **Refatoração de Componentes React:** Criação de componentes novos e especializados (, ) e sua integração em páginas existentes.
-   **Desenvolvimento Iterativo com Feedback do Utilizador:** O agente adaptou-se a múltiplos pedidos de refinamento do utilizador, como a evolução da ficha de detalhes do motorista arquivado de idêntica para simplificada.

**key DB schema**
-   **users:** Os campos , , , , , e  foram cruciais para a implementação das correções e novas funcionalidades de filtragem.
-   **planos:** Contém a lista de planos de faturação e os seus .
-   **dados_semanais:** Contém dados de faturação. A correção passou por filtrar  para corresponder apenas às empresas do parceiro.

**All files of reference**
-   **Created:**
    -   
    -   
-   **Updated Heavily:**
    -    (Correção do Resumo Semanal)
    -    (Correção do Dashboard de Faturação)
    -    (Novo endpoint de destinatários)
    -    (Início da implementação da seleção de planos)
    -    (Implementação da ficha simplificada)
    -    (Uso do novo endpoint)
-   **To be updated:**
    -    (Precisa de mais refatoração)
    -    (Para processar a atribuição de planos na aprovação)

**Areas that need refactoring**:
-    continua a ser a prioridade máxima. As tabs info (~2200 linhas) e agenda precisam de ser extraídas para componentes dedicados para tornar o ficheiro gerível.

**key api endpoints**
-   : (NOVO) Retorna a lista de utilizadores que podem receber mensagens com base no papel do remetente.
-   : Endpoint existente que precisa ser atualizado para receber e atribuir  e .
-   : Atualizado para retornar apenas motoristas com .
-   : A lógica de dados foi corrigida para excluir motoristas irrelevantes.
-   : A lógica de dados foi corrigida para filtrar por empresas do parceiro e corrigir cálculos.

**Critical Info for New Agent**
-   A prioridade imediata é concluir a tarefa em andamento: **adicionar a seleção de Plano e Preços Especiais ao diálogo de aprovação de utilizadores**. Isto exigirá trabalho tanto no frontend () como no backend ().
-   Após concluir a tarefa acima, a próxima prioridade deve ser continuar a **refatoração de **, começando pela massiva tab info.
-   Esteja ciente de que existem dois problemas de fundo, mencionados mas não resolvidos, que podem exigir atenção futura: um **erro de carregamento de dados em produção** (provavelmente relacionado com a BD) e a **instabilidade do scraper da Prio**. Se o utilizador os mencionar, devem ser priorizados.
-   Muitos bugs nesta sessão foram causados por **dados inconsistentes na base de dados**. Ao depurar, verifique sempre os dados reais na BD (e.g., com ) para validar as suas suposições sobre a lógica.

**documents and test reports created in this job**
-   
-   
-    (foi atualizado pelo agente anterior)

**Last 10 User Messages and any pending HUMAN messages**
-   : O utilizador reportou um problema com a aprovação e pediu para adicionar a atribuição de planos e preços especiais. O agente estava a trabalhar nisto. (EM PROGRESSO)
-   : O utilizador pediu para preparar a aplicação para deploy. (CONCLUÍDO)
-   : O utilizador refinou o pedido da ficha de detalhes do motorista arquivado para ser uma versão simplificada. (CONCLUÍDO)
-   : Pedido inicial do utilizador para que a ficha do motorista arquivado fosse idêntica à do ativo. (SUBSTITUÍDO PELO PEDIDO SEGUINTE)
-   : O utilizador pediu a separação de motoristas ativos e arquivados. (CONCLUÍDO)
-   : O utilizador apontou uma inconsistência no status de um motorista desativado que ainda aparecia nos relatórios. (CONCLUÍDO)
-   : O utilizador reportou múltiplos bugs no Dashboard de Faturação e no Resumo Semanal com screenshots. (CONCLUÍDO)

**Project Health Check:**
-   **Broken:** Existe um erro não diagnosticado de erro a carregar dados no ambiente de produção, reportado em handoffs anteriores e não abordado nesta sessão. É um risco elevado para a estabilidade da aplicação.

**3rd Party Integrations**
-   **Playwright:** Usado para automação RPA (scrapers Uber/Prio).
-   **Recharts:** Usado para gráficos no dashboard.
-   **Expo / EAS:** Utilizado para a aplicação móvel.

**Testing status**
-   **Testing agent used after significant changes:** YES. O agente usou o  duas vezes para validar as correções dos relatórios e a refatoração.
-   **Troubleshoot agent used after agent stuck in loop:** NO
-   **Test files created:** None.
-   **Known regressions:** A instabilidade do scraper da Prio e o problema não resolvido da base de dados de produção.

**Credentials to test flow:**
-   **App Admin User:**  / 
-   **App Partner User (Zeny):**  / 

**What agent forgot to execute**
-   O agente não iniciou a investigação sobre o **erro de carregamento de dados em produção**, apesar de este ser um problema recorrente e potencialmente crítico mencionado no handoff inicial. O foco foi direcionado para os novos bugs e funcionalidades reportados pelo utilizador durante a sessão.</analysis>
