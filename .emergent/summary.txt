<analysis>**original_problem_statement:**
O utilizador pretende continuar a desenvolver a sua aplicação de gestão de frotas. As solicitações iniciais abrangiam melhorias na gestão de preços, correção de bugs (registo de parceiros, emails bloqueados), e a criação de uma interface de administração para gerir utilizadores e armazenamento.

Durante a sessão, o âmbito expandiu-se significativamente com novas solicitações:
1.  **Integração com WhatsApp:** Implementar um sistema de ligação via QR Code para que os parceiros possam enviar notificações, alertas e relatórios aos motoristas.
2.  **Gestão de Armazenamento Avançada:**
    *   Criar uma funcionalidade para descarregar o servidor, movendo o armazenamento de documentos (relatórios, documentos de veículos/motoristas, etc.) para serviços de cloud de terceiros (Terabox, Google Drive, OneDrive, Dropbox).
    *   Permitir que cada parceiro escolha o seu modo de armazenamento: ,  (apenas num serviço externo), ou  (local com backup na cloud).
    *   O administrador do sistema deve ter uma visão geral e a capacidade de configurar o modo de armazenamento para cada parceiro.
    *   A ligação aos serviços cloud deve ser simplificada, utilizando email/password em vez de OAuth, e permitindo apenas um serviço cloud ativo por parceiro.
3.  **Correção de Bug:** Resolver um erro crítico que impedia o carregamento da página Loja de Planos.

**User's preferred language**: Portuguese (Portugal)

**what currently exists?**
Uma aplicação full-stack (React/FastAPI/MongoDB) de gestão de frotas.
- Foi concluída a UI para **Gestão de Armazenamento do Sistema**, que mostra o espaço em disco detalhado por pasta e permite limpar ficheiros temporários.
- Foi implementada uma **página de configuração de armazenamento** () onde os parceiros podem escolher o seu modo de armazenamento (, , ) e onde o admin pode gerir as configurações de todos os parceiros. A UI foi adaptada para uma ligação simplificada com email/password aos serviços cloud.
- Foram criados os serviços de backend para a integração com a cloud () e um utilitário central () para gerir para onde os ficheiros são enviados.
- Foi implementada uma **integração com o WhatsApp Web** através de um microserviço Node.js, com uma página no frontend para os utilizadores se conectarem via QR Code.
- Foi corrigido um bug crítico na página **Loja de Planos**.

**Last working item**:
-   **Last item agent was working:** O agente estava a dar início à **Parte 3** da funcionalidade de **Integração com Cloud Storage**. Tinha acabado de criar um utilitário central, , destinado a decidir se um ficheiro é guardado localmente ou na cloud, com base na configuração do parceiro. O passo seguinte era começar a refatorar todos os endpoints de upload de ficheiros da aplicação para utilizarem este novo handler, começando pelo endpoint de upload de documentos de motoristas em .
-   **Status:** IN PROGRESS
-   **Agent Testing Done:** N
-   **Which testing method agent to use?** Backend testing agent. Após refatorar cada endpoint de upload, é necessário testar dois cenários: 1) Com o parceiro em modo Local, o ficheiro deve ser guardado no servidor. 2) Com o parceiro em modo Cloud, o handler deve invocar o serviço de cloud (possivelmente com um mock para o teste).
-   **User Testing Done:** N

**All Pending/In progress Issue list**:
-   Issue 1: O estado da ligação WhatsApp não atualiza na UI (P0)
-   Issue 2: Continuar refatoração de  (P2)
-   Issue 3: Verificar se todas as categorias de planos são editáveis (P2)
-   Issue 4: Bug de navegação na página de ficha do veículo (P2)

**Issues Detail:**
-   **Issue 1: O estado da ligação WhatsApp não atualiza na UI (P0)**
    -   **Attempted fixes:** O agente identificou e limpou ficheiros de lock do perfil do Chromium, suspeitando que pudessem estar a bloquear novas sessões. No entanto, o problema principal persiste.
    -   **Next debug checklist:**
        1.  Verificar os logs do microserviço Node.js () para confirmar se o evento  está a ser disparado após o scan do QR code.
        2.  Analisar a comunicação entre o frontend () e o backend (). Confirmar que o polling no frontend está a chamar o endpoint  e que este endpoint está a obter o estado correto do serviço Node.js.
        3.  Verificar se há algum erro de CORS ou de rede na consola do browser do frontend.
    -   **Why fix this issue and what will be achieved with the fix?** É um bug bloqueante que impede os utilizadores de usar a funcionalidade de WhatsApp, uma das principais solicitações do utilizador.
    -   **Status:** IN PROGRESS
    -   **Is recurring issue?** N
    -   **Should Test frontend/backend/both after fix?** Both.
    -   **Blocked on other issue:** Não.

-   **Issue 2: Continuar refatoração de  (P2)**
    -   **Status:** NOT STARTED (Nesta sessão)
    -   **Why fix this issue and what will be achieved with the fix?** Melhora a manutenibilidade de um componente complexo.
    -   **Is recurring issue?** Y

-   **Issue 3: Verificar se todas as categorias são editáveis (P2)**
    -   **Status:** NOT STARTED

-   **Issue 4: Bug de navegação na página de ficha do veículo (P2)**
    -   **Status:** NOT STARTED

**In progress Task List**:
-   **Task 1: Concluir a Integração com Cloud Storage (P0)**
    -   **Where to resume:** Refatorar o endpoint de upload em  para usar o .
    -   **What will be achieved with this?** A aplicação será capaz de guardar ficheiros em serviços de armazenamento na cloud, respondendo a um requisito fulcral do utilizador para reduzir o uso de espaço no servidor.
    -   **Status:** IN PROGRESS
    -   **Sub-tasks:**
        1.  **Implementar a Lógica dos Provedores Cloud:** O ficheiro  é um esqueleto. É preciso implementar a lógica de upload real para cada provedor (Terabox, Google Drive, etc.), usando as credenciais encriptadas.
        2.  **Refatorar Todos os Endpoints de Upload:** Depois dos motoristas, é preciso encontrar e refatorar todos os outros endpoints que lidam com uploads de ficheiros (veículos, vistorias, documentos gerais, etc.) para usar o .
        3.  **Implementar Download da Cloud:** O utilizador perguntou especificamente se seria possível descarregar os ficheiros. É preciso criar os endpoints de backend e a lógica de UI para permitir o download de ficheiros a partir da cloud.
    -   **Should Test frontend/backend/both after fix?** Both.
    -   **Blocked on something:** Não.

**Upcoming and Future Tasks**
*   **Upcoming Tasks:**
    *   (P1) Implementar a funcionalidade de download para ficheiros armazenados na cloud.
*   **Future Tasks:**
    *   Implementar funcionalidades de Alertas Avançados e Comissões Avançadas.
    *   Criar um sistema para arquivar dados antigos da base de dados.
    *   Implementar um sistema de relógio de ponto na app móvel.
    *   Investigar a instabilidade do scraper da Prio.

**Completed work in this session**
-   **Feature: UI de Gestão de Armazenamento Melhorada:** Concluída a página de admin do sistema com uma vista detalhada do uso do disco e um botão para limpar ficheiros temporários.
-   **Feature: UI de Configuração de Cloud Storage:** Criada uma nova página para parceiros e administradores configurarem o modo de armazenamento (Local/Cloud/Ambos) e conectarem-se a provedores de cloud com email/password.
-   **Feature: Base da Integração WhatsApp:** Implementada a UI de conexão via QR Code e os endpoints de backend necessários para a comunicação com o microserviço.
-   **Bugfix: Loja de Planos:** Corrigido um erro que causava o crash da página, adicionando as verificações de nulidade necessárias.

**Earlier issues found/mentioned but not fixed**
-   O bug de conexão do WhatsApp (Issue 1) é o principal problema encontrado nesta sessão que não foi resolvido.

**Known issue recurrence from previous fork**
-   A necessidade de refatorar componentes monolíticos como  e  persiste.

**Code Architecture**


**Key Technical Concepts**
-   **Comunicação com Microserviços:** A arquitetura agora inclui a comunicação do backend FastAPI com um microserviço externo (Node.js) para a funcionalidade do WhatsApp.
-   **Camada de Serviço Unificada:** A criação do  e do  representa um passo importante para uma arquitetura mais limpa e centralizada, abstraindo a lógica de armazenamento.
-   **Encriptação de Credenciais:** O sistema foi projetado para encriptar e armazenar de forma segura as credenciais dos serviços cloud dos parceiros.

**key DB schema**
-   **parceiros:** Foi adicionada uma configuração de armazenamento para cada parceiro, contendo o  ('local', 'cloud', 'both'), o  (e.g., 'terabox') e as  encriptadas.

**All files of reference**
-   **Created:**
    -   
    -   
    -   
    -   
    -   
    -   
-   **Updated Heavily:**
    -    (passou por várias iterações)
    -   
-   **Fixed:**
    -   

**Areas that need refactoring**:
-   A implementação do  está incompleta e precisa ser preenchida com a lógica real de cada provedor.
-   Todos os endpoints de upload de ficheiros na aplicação precisam ser refatorados para usar o .

**key api endpoints**
-   **Novos:**
    -   : Para gerir as configurações de armazenamento.
    -   : Para guardar as credenciais da cloud.
    -   , : Para gerir a ligação com o WhatsApp.
-   **A Refatorar:**
    -   
    -   Todos os outros endpoints de upload de ficheiros em , , etc.

**Critical Info for New Agent**
-   **Prioridade Máxima (P0): Concluir a Integração Cloud.** Esta é a tarefa principal. Comece por implementar a lógica de upload no  para pelo menos um provedor (ex: Google Drive). Em seguida, continue a refatorar todos os endpoints de upload de ficheiros para usarem o . Não se esqueça da funcionalidade de download.
-   **Bug Crítico (P0): Corrigir a Conexão do WhatsApp.** O utilizador não pode usar esta funcionalidade enquanto o estado não for atualizado na UI. A investigação deve focar-se na cadeia de comunicação: . Verifique onde a atualização do estado ready se perde.
-   **Preferências do Utilizador:** Lembre-se que o utilizador valoriza a simplicidade. A mudança de OAuth para email/password na configuração da cloud é um exemplo disso. Mantenha as soluções diretas e focadas no problema.

**documents and test reports created in this job**
-   
-    (atualizado)

**Last 10 User Messages and any pending HUMAN messages**
1.  ****: Deu luz verde para continuar com a integração do sistema de upload com os serviços cloud. (Em progresso)
2.  ****: Confirmou que o resumo da implementação da Parte 3 (integração dos uploads) estava correto. (Em progresso)
3.  ****: Pedido para simplificar a conexão à cloud, usando email/password e permitindo apenas um provedor. (Concluído)
4.  ****: Definiu a ordem de prioridades para a implementação da funcionalidade de cloud storage. (Em progresso)
5.  ****: Pedido para que o admin possa configurar o armazenamento para cada parceiro. (Concluído)
6.  ****: Perguntou sobre a funcionalidade de download, confirmando que é um requisito. (Pendente)
7.  ****: Pediu esclarecimentos sobre os modos de armazenamento. (Esclarecido)
8.  ****: Pedido inicial para a funcionalidade de armazenamento na cloud. (Em progresso)
9.  ****: Reportou o bug na Loja de Planos. (Corrigido)
10. ****: Apontou a falta do seletor de parceiros na nova página de configuração. (Corrigido)

**Project Health Check:**
-   **Broken:** A atualização do estado da conexão do WhatsApp está quebrada, impedindo o uso da funcionalidade.
-   **Mocked:** A lógica de upload no  está efetivamente mockada (é um esqueleto vazio) e precisa de implementação real.
-   **Code Health:** Melhorou com a introdução de camadas de serviço (), mas a dívida técnica em componentes antigos e a necessidade de completar a refatoração dos uploads são pontos de atenção.

**3rd Party Integrations**
-   **wppconnect-team/wppconnect:** Usado no microserviço Node.js para a integração com o WhatsApp Web.
-   **PyDrive2, dropbox, onedrivesdk:** Bibliotecas Python instaladas para as integrações com Google Drive, Dropbox e OneDrive, respetivamente.

**Testing status**
-   **Testing agent used after significant changes:** YES. Usado para validar a implementação inicial da API do WhatsApp.
-   **Test files created:** None.
-   **Known regressions:** A funcionalidade de conexão do WhatsApp, que passou nos testes do subagente, falhou no uso real pelo utilizador, indicando um bug que os testes automatizados não apanharam.

**Credentials to test flow:**
-   **App Admin User:**  / 
-   **App Partner User (Zeny):**  / 

**What agent forgot to execute**
- O agente não implementou a funcionalidade de **download de ficheiros** a partir da cloud, um requisito que o utilizador mencionou explicitamente.
- O agente não implementou a lógica real de conexão e upload no  para os provedores de cloud; criou apenas a estrutura.</analysis>
