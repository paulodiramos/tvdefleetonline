<analysis>**original_problem_statement:**
O utilizador iniciou com a necessidade de desenvolver um sistema robusto para a gestão de relatórios semanais de frotas. Os requisitos evoluíram para incluir:
1.  **Gestão de Relatórios:** Um fluxo completo com os estados , , ,  e .
2.  **Criação de Relatórios:** Métodos de criação Manual, Semi-Manual (importação de CSV) e Automático (sincronização agendada).
3.  **Importação de Dados:** Uma página dedicada para importar dados de várias plataformas (Uber, Bolt, Via Verde), adaptando-se a diferentes formatos de ficheiro e criando relatórios de rascunho automaticamente.
4.  **Lógica de Agregação:** Ao gerar relatórios para uma semana específica, o sistema deve agregar os dados da Uber e Bolt da semana atual com os dados da Via Verde da semana *anterior*.
5.  **Correção de Bugs:** Múltiplos bugs foram reportados, principalmente relacionados com a falha na importação de CSV de diferentes plataformas e a persistência de dados em formulários de edição de veículos e motoristas.

**User's preferred language**: Portuguese (português)

**what currently exists?**
A aplicação full-stack (React + FastAPI) possui um Hub de Relatórios () para gerir o ciclo de vida dos relatórios e uma página () para a importação de dados. O sistema agora cria automaticamente relatórios em estado de Rascunho após a importação de dados. Foi implementada uma funcionalidade de Gerar Relatórios em Massa que agrega os dados importados de uma semana (Uber, Bolt, etc.) com os dados da Via Verde da semana anterior, conforme solicitado. A importação de CSV da Uber foi corrigida para lidar com delimitadores de ponto e vírgula e caracteres BOM. Foi adicionada uma funcionalidade para excluir relatórios pendentes.

**Last working item**:
- Last item agent was working: O agente estava prestes a corrigir um erro na importação de um ficheiro CSV da plataforma Bolt. O utilizador reportou que a importação falha com o erro Linha 2: Email do motorista vazio e forneceu um ficheiro de exemplo para análise.
- Status: NOT STARTED
- Agent Testing Done: N
- Which testing method agent to use? backend testing agent. O agente deve usar o ficheiro  para testar o endpoint  e validar a nova lógica de parsing.
- User Testing Done: N

**All Pending/In progress Issue list**:
-   Issue 1: (P0) A importação de CSV da Bolt falha com o erro Email do motorista vazio.
-   Issue 2: (P0) Bugs recorrentes na gravação de dados nos formulários.
-   Issue 3: (P3) Refatoração do ficheiro monolítico .
-   Issue 4: (P4) Perda intermitente de dados de teste na base de dados (herdado de forks anteriores).

Issues Detail:
-   Issue 1:
    -   Attempted fixes: Nenhum. O agente identificou o problema, mas ainda não iniciou a correção.
    -   Next debug checklist:
        1.  Analisar a estrutura do ficheiro CSV da Bolt fornecido () para identificar as colunas disponíveis e o identificador único do motorista (nome, ID, etc.).
        2.  Inspecionar a lógica do endpoint  em .
        3.  Modificar o endpoint para não depender do campo email e usar o identificador correto disponível no ficheiro, de forma semelhante à correção feita para a importação da Uber.
    -   Why fix this issue and what will be achieved with the fix? A importação de dados da Bolt é uma funcionalidade essencial para o negócio do utilizador.
    -   Status: NOT STARTED
    -   Is recurring issue? Y (Falhas na importação de CSV são um problema recorrente para diferentes plataformas).
    -   Should Test frontend/backend/both after fix? Backend
    -   Blocked on other issue: None
-   Issue 2:
    -   Attempted fixes: O agente fez várias tentativas para corrigir estes bugs, incluindo ajustes nos payloads do frontend e na lógica do backend. No entanto, o utilizador continuou a reportar que os dados não eram guardados.
    -   Next debug checklist:
        1.  **Verificação Rigorosa:** Assumir que as correções anteriores foram insuficientes. Usar o agente de testes de frontend para executar um teste E2E: editar todos os campos relevantes em  e , guardar, recarregar a página e verificar se os dados foram efetivamente persistidos.
        2.  **Inspeção de Rede:** Analisar detalhadamente o payload enviado nas requisições  para  e o endpoint de atualização do motorista, e a resposta do servidor.
        3.  **Logging no Backend:** Adicionar logs detalhados nos endpoints do backend para rastrear os dados recebidos e o resultado da operação de atualização na base de dados.
    -   Why fix this issue and what will be achieved with the fix? A gestão de veículos e motoristas são funcionalidades centrais e estão atualmente inutilizáveis ou pouco fiáveis.
    -   Status: IN PROGRESS
    -   Is recurring issue? Y
    -   Should Test frontend/backend/both after fix? Both
    -   Blocked on other issue: None

**In progress Task List**:
Nenhum.

**Upcoming and Future Tasks**

-   **Upcoming Tasks:**
    -   (P1) Implementar o método Automático de criação de relatórios (sincronização agendada), que faz parte do requisito original.
-   **Future Tasks:**
    -   (P2) Refatorar  em múltiplos ficheiros de rotas para melhorar a manutenibilidade.
    -   (P3) Refatorar os componentes React  e  em componentes mais pequenos e reutilizáveis.
    -   (P4) Investigar a causa da instabilidade da base de dados de teste que resulta em perda de dados.

**Completed work in this session**
-   **Funcionalidade de Relatórios em Massa:** Implementado endpoint () e UI para gerar relatórios semanais para todos os motoristas.
-   **Lógica da Via Verde:** O backend agora busca automaticamente os dados da Via Verde da semana anterior ao gerar relatórios, conforme solicitado.
-   **Criação de Rascunhos:** A importação de CSV agora cria automaticamente relatórios em estado de Rascunho.
-   **Correção de Importação da Uber:** A importação foi corrigida para suportar ficheiros com delimitador de ponto e vírgula () e para lidar com o BOM (Byte Order Mark) no início do ficheiro.
-   **Exclusão de Relatórios:** Adicionada funcionalidade para excluir relatórios nos estados  ou .
-   **Correções de Bugs e Estabilidade:** O agente corrigiu múltiplos erros de sintaxe e indentação no frontend e backend, e reiniciou o servidor várias vezes para resolver crashes e processos zombie.
-   **Limpeza da UI:** A funcionalidade Importar Relatórios via CSV foi removida do  a pedido do utilizador.

**Earlier issues found/mentioned but not fixed**
-   A refatoração de  e dos componentes React continua pendente.
-   A investigação sobre a instabilidade da base de dados não foi iniciada.

**Known issue recurrence from previous fork**
-   **Perda de dados de teste:** A causa raiz deste problema, observado no fork anterior, continua por investigar.
-   Recurrence count: 1
-   Status: NOT STARTED

**Code Architecture**


**Key Technical Concepts**
-   **Parsing de CSV Flexível:** O agente aprendeu a importância de detetar e usar o delimitador correto ( vs. ) e de lidar com codificações de ficheiro como  para remover o BOM.
-   **Operações em Massa (Backend):** Foi criado um novo padrão para operações em massa () que itera sobre um conjunto de dados (motoristas) para criar múltiplos registos (relatórios).
-   **Manipulação de Datas (Backend):** O backend agora usa  e  para ajustar o intervalo de datas ao buscar dados de diferentes fontes (ex: Via Verde da semana anterior).

**key DB schema**
-   **relatorios_semanais**: O fluxo de trabalho agora inclui um estado , que é o estado inicial dos relatórios criados via importação.
-   **motoristas**: O campo  foi central para a depuração da importação.
-   **vehicles**: Campos como , ,  são o foco de bugs de persistência de dados.

**changes in tech stack**
-   Nenhuma.

**All files of reference**
-   
-   
-   
-   
-   
-   
-    (ficheiro a ser analisado)

**Areas that need refactoring**:
-   ****: A sua dimensão e complexidade tornam-no um ponto crítico de falha e difícil de manter. A refatoração é urgente.
-   ****: Este componente gere demasiados estados e modais, devendo ser dividido em componentes mais pequenos e focados.

**key api endpoints**
-    (Novo)
-    (Novo)
-    (Modificado): A lógica foi alterada várias vezes e precisará de mais uma modificação para a plataforma Bolt.
-    (Buggy)
-    (Buggy)

**Critical Info for New Agent**
-   **Prioridade Máxima (P0):** A sua primeira ação deve ser corrigir a importação de CSV da Bolt, analisando o ficheiro fornecido pelo utilizador e adaptando a lógica do backend para usar um identificador que não seja o email.
-   **Bugs Recorrentes (P0):** Os bugs de gravação de dados em  e  são um problema persistente. Não confie que as correções anteriores funcionaram. É crucial realizar testes de ponta a ponta (E2E) para garantir que os dados são guardados e recarregados corretamente antes de considerar o problema resolvido.
-   **Fluxo de Trabalho de Relatórios:** O fluxo desejado pelo utilizador é: 1. Importar dados (cria rascunhos) -> 2. Gerar relatórios em massa (agrega dados, incluindo Via Verde da semana anterior) -> 3. Rever e aprovar. Certifique-se de que este fluxo permanece intacto.

**documents created in this job**
-   Nenhum.

**Last 10 User Messages and any pending user messages**
1.  **User:** Reporta que a importação da Uber falha mesmo com o UUID correto. **Status: RESOLVED** (o problema era o delimitador e o BOM do CSV).
2.  **User:** Pergunta onde encontrar os rascunhos para sincronizar dados. **Status: ADDRESSED** (agente implementou a geração em massa).
3.  **User:** Reporta que a aplicação bloqueia após a importação. **Status: RESOLVED** (agente reiniciou o backend e corrigiu erros de sintaxe).
4.  **User:** Esclarece que após a importação, os relatórios não aparecem como rascunhos. **Status: ADDRESSED** (agente implementou a criação automática de rascunhos).
5.  **User:** Detalha a lógica de agregação: a mesma semana para várias plataformas, mas a Via Verde tem um atraso de uma semana. **Status: ADDRESSED** (agente implementou a lógica no backend).
6.  **User:** Confirma que a Via Verde deve ser incluída no relatório da semana atual, apesar de as datas de cobrança serem da semana anterior. **Status: ADDRESSED**.
7.  **User:** erro login geral@zmbusines.com. **Status: RESOLVED** (agente corrigiu erros de sintaxe no backend que impediam o login).
8.  **User:** Reporta que após importar um relatório, este não fica em rascunho. **Status: ADDRESSED** (agente clarificou o fluxo e obteve confirmação).
9.  **User:** Esclarece novamente a lógica de agregação da Via Verde. **Status: ADDRESSED**.
10. **User (LATEST):** Reporta que a importação do CSV da Bolt falha com Email do motorista vazio e fornece o ficheiro para análise. **Status: PENDING**.

**Project Health Check:**
-   **Broken**:
    -   Funcionalidade de importação de CSV da Bolt.
    -   Gravação de dados na página de Detalhes do Veículo ().
    -   Gravação de dados na página de Perfil do Motorista ().
-   **Mocked**:
    -   Nenhum.

**3rd Party Integrations**
-   Nenhuma integração com serviços externos que exija chaves de API.

**Testing status**
-   Testing agent used after significant changes: YES, mas com eficácia limitada, pois os bugs reportados pelo utilizador persistiram.
-   Troubleshoot agent used after agent stuck in loop: YES, foi eficaz na identificação de causas de bugs.
-   Test files created: []
-   Known regressions: A funcionalidade de gravação de dados para veículos e motoristas regrediu ou nunca foi totalmente corrigida, apesar de múltiplas tentativas.

**Credentials to test flow:**
-   Disponíveis no ficheiro .

**What agent forgot to execute**
-   O agente não conseguiu resolver de forma definitiva os bugs recorrentes de gravação de dados, declarando sucesso prematuramente em várias ocasiões.
-   A implementação do método Automático de criação de relatórios (agendamento), que fazia parte dos requisitos originais, não foi iniciada.</analysis>
